<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>QRã‚³ãƒ¼ãƒ‰ - ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³æ¨é€²å§”å“¡ä¼š å‡ºæ¬ ç®¡ç†</title>
  <link rel="stylesheet" href="css/common.css">
  <style>
    .qr-container {
      max-width: 600px;
      margin: 0 auto;
    }

    .qr-card {
      background-color: white;
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .qr-header {
      margin-bottom: 2rem;
    }

    .qr-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }

    .qr-subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .qr-code-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      background: linear-gradient(135deg, var(--primary-bg) 0%, var(--gray-light) 100%);
      border-radius: 12px;
      margin-bottom: 2rem;
    }

    .qr-code {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      background-color: white;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .member-info {
      background-color: var(--gray-light);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
    }

    .member-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-color);
    }

    .member-info-row:last-child {
      border-bottom: none;
    }

    .member-info-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .member-info-value {
      font-size: 0.875rem;
      color: var(--text-color);
      font-weight: 600;
    }

    .qr-instructions {
      background-color: var(--info-bg);
      color: var(--info-color);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      text-align: left;
    }

    .qr-instructions-title {
      font-size: 0.875rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .qr-instructions-list {
      font-size: 0.813rem;
      line-height: 1.8;
      margin: 0;
      padding-left: 1.5rem;
    }

    .qr-instructions-list li {
      margin-bottom: 0.5rem;
    }

    .qr-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .brightness-notice {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 1rem;
      padding: 0.75rem;
      background-color: var(--warning-bg);
      color: var(--warning-color);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .loading-qr {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .loading-qr-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .qr-card {
        padding: 2rem 1.5rem;
      }

      .qr-code-wrapper {
        padding: 1.5rem;
      }

      .qr-actions {
        flex-direction: column;
      }

      .qr-actions .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-container">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="header-top">
        <h1 class="header-title">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="header-user">
          <span id="userName" class="header-user-name"></span>
          <button id="mobileNavToggle" class="mobile-nav-toggle">â˜°</button>
          <button id="logoutBtn" class="btn btn-secondary btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>

      <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <nav class="nav">
        <div class="nav-container">
          <a href="home.html" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">HOME</span>
          </a>
          <a href="events.html" class="nav-item">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-text">ã‚¤ãƒ™ãƒ³ãƒˆ</span>
          </a>
          <a href="members.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¥</span>
            <span class="nav-text">ãƒ¡ãƒ³ãƒãƒ¼</span>
          </a>
          <a href="history.html" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å±¥æ­´</span>
          </a>
          <a href="receipts.html" class="nav-item">
            <span class="nav-icon">ğŸ§¾</span>
            <span class="nav-text">é ˜åæ›¸</span>
          </a>
          <a href="profile.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¤</span>
            <span class="nav-text">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
          </a>
          <!-- ç®¡ç†è€…ç”¨ãƒªãƒ³ã‚¯ -->
          <a href="admin/dashboard.html" id="adminLink" class="nav-item" style="display: none;">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">ç®¡ç†ç”»é¢</span>
          </a>
        </div>
      </nav>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="container">
      <a href="home.html" class="back-link" style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--primary-color); text-decoration: none; font-size: 0.875rem; margin-bottom: 1.5rem;">
        â† HOMEã«æˆ»ã‚‹
      </a>

      <div class="qr-container">
        <div class="qr-card">
          <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
          <div class="qr-header">
            <h2 class="qr-title">ã‚ãªãŸã®QRã‚³ãƒ¼ãƒ‰</h2>
            <p class="qr-subtitle">
              ã‚¤ãƒ™ãƒ³ãƒˆä¼šå ´ã§ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’æç¤ºã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ã¦ãã ã•ã„
            </p>
          </div>

          <!-- QRã‚³ãƒ¼ãƒ‰ -->
          <div class="qr-code-wrapper">
            <div id="qrCodeContainer">
              <div class="loading-qr">
                <div class="loading-qr-spinner"></div>
                <p>QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆä¸­...</p>
              </div>
            </div>
          </div>

          <!-- ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ± -->
          <div class="member-info">
            <div class="member-info-row">
              <span class="member-info-label">æ°å</span>
              <span class="member-info-value" id="memberName">-</span>
            </div>
            <div class="member-info-row">
              <span class="member-info-label">ãƒ¡ãƒ³ãƒãƒ¼ID</span>
              <span class="member-info-value" id="memberId">-</span>
            </div>
          </div>

          <!-- ä½¿ã„æ–¹ -->
          <div class="qr-instructions">
            <div class="qr-instructions-title">
              <span>ğŸ’¡</span>
              <span>ä½¿ã„æ–¹</span>
            </div>
            <ol class="qr-instructions-list">
              <li>ã‚¤ãƒ™ãƒ³ãƒˆä¼šå ´ã®å—ä»˜ã§ã“ã®ç”»é¢ã‚’æç¤ºã—ã¦ãã ã•ã„</li>
              <li>ç®¡ç†è€…ãŒQRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™</li>
              <li>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãŒå®Œäº†ã™ã‚‹ã¨å‚åŠ ãŒè¨˜éŒ²ã•ã‚Œã¾ã™</li>
              <li>å‚åŠ è²»ãŒã‚ã‚‹å ´åˆã¯ã€ãã®å ´ã§ãŠæ”¯æ‰•ã„ãã ã•ã„</li>
            </ol>
          </div>

          <!-- æ³¨æ„äº‹é … -->
          <div class="brightness-notice">
            <span>ğŸ’¡</span>
            <span>ç”»é¢ã®æ˜ã‚‹ã•ã‚’ä¸Šã’ã‚‹ã¨ã‚¹ã‚­ãƒ£ãƒ³ã—ã‚„ã™ããªã‚Šã¾ã™</span>
          </div>

          <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="qr-actions" style="margin-top: 2rem;">
            <button id="refreshBtn" class="btn btn-outline">
              ğŸ”„ QRã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°
            </button>
            <button id="downloadBtn" class="btn btn-secondary">
              ğŸ“¥ ç”»åƒã¨ã—ã¦ä¿å­˜
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/nav.js"></script>

  <script>
    const userInfo = Auth.getUserInfo();
    let qrCodeUrl = '';

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
      Auth.requireLogin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±è¡¨ç¤º
      displayMemberInfo();

      // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆGoogle Charts APIã‚’ä½¿ç”¨ï¼‰
      await generateQRCode();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();

      // ç”»é¢ã®æ˜ã‚‹ã•ã‚’æœ€å¤§ã«è¨­å®šï¼ˆå¯èƒ½ãªå ´åˆï¼‰
      try {
        if ('wakeLock' in navigator) {
          const wakeLock = await navigator.wakeLock.request('screen');
          console.log('Wake Lock is active');
        }
      } catch (err) {
        console.log('Wake Lock error:', err);
      }
    });

    // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±è¡¨ç¤º
    function displayMemberInfo() {
      document.getElementById('memberName').textContent = userInfo.name;
      document.getElementById('memberId').textContent = userInfo.memberId;
    }

    // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆQR Server APIã‚’ä½¿ç”¨ï¼‰
    async function generateQRCode() {
      const container = document.getElementById('qrCodeContainer');

      try {
        // QRã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¡ãƒ³ãƒãƒ¼IDï¼‰
        const qrData = encodeURIComponent(userInfo.memberId);

        // QR Server APIã‚’ä½¿ç”¨ã—ã¦QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        // https://goqr.me/api/ - ç„¡æ–™ã®QRã‚³ãƒ¼ãƒ‰ç”ŸæˆAPI
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${qrData}`;

        // ç”»åƒè¦ç´ ã‚’ä½œæˆ
        const img = document.createElement('img');
        img.className = 'qr-code';
        img.alt = 'QRã‚³ãƒ¼ãƒ‰';

        // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
        img.onload = () => {
          container.innerHTML = '';
          container.appendChild(img);

          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã«URLã‚’ä¿å­˜
          qrCodeUrl = qrApiUrl;
          console.log('QRã‚³ãƒ¼ãƒ‰ç”ŸæˆæˆåŠŸ');
        };

        // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
        img.onerror = () => {
          console.error('QR Code image load error');
          handleQRError();
        };

        // ç”»åƒã®srcã‚’è¨­å®šï¼ˆèª­ã¿è¾¼ã¿é–‹å§‹ï¼‰
        img.src = qrApiUrl;

      } catch (error) {
        console.error('QR Code generation error:', error);
        handleQRError();
      }
    }

    // QRã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼å‡¦ç†
    function handleQRError() {
      const container = document.getElementById('qrCodeContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âŒ</div>
          <p class="empty-state-text">QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
          <button onclick="generateQRCode()" class="btn btn-primary btn-sm" style="margin-top: 1rem;">
            å†è©¦è¡Œ
          </button>
        </div>
      `;
    }
    window.handleQRError = handleQRError;

    // QRã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    async function downloadQRCode() {
      try {
        if (!qrCodeUrl) {
          throw new Error('QRã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        // æ–°ã—ã„Canvasã‚’ä½œæˆï¼ˆæƒ…å ±ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ï¼‰
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // Canvasã‚µã‚¤ã‚ºã‚’è¨­å®š
        canvas.width = 400;
        canvas.height = 480;

        // èƒŒæ™¯è‰²ï¼ˆç™½ï¼‰
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’èª­ã¿è¾¼ã¿
        const qrImg = new Image();
        qrImg.crossOrigin = 'anonymous'; // CORSå¯¾ç­–

        qrImg.onload = () => {
          // QRã‚³ãƒ¼ãƒ‰ã‚’ä¸­å¤®ã«é…ç½®
          const qrSize = 300;
          const qrX = (canvas.width - qrSize) / 2;
          const qrY = 50;
          ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

          // ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ 
          ctx.fillStyle = '#333333';
          ctx.font = 'bold 16px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(userInfo.name, canvas.width / 2, 380);

          ctx.font = '14px sans-serif';
          ctx.fillStyle = '#666666';
          ctx.fillText(`ID: ${userInfo.memberId}`, canvas.width / 2, 410);

          ctx.font = '12px sans-serif';
          ctx.fillText('ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³æ¨é€²å§”å“¡ä¼š', canvas.width / 2, 440);

          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qr-code-${userInfo.memberId}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('QRã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          });
        };

        qrImg.onerror = () => {
          throw new Error('QRã‚³ãƒ¼ãƒ‰ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        };

        qrImg.src = qrCodeUrl;

      } catch (error) {
        console.error('Download error:', error);
        alert('QRã‚³ãƒ¼ãƒ‰ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // QRã‚³ãƒ¼ãƒ‰æ›´æ–°
      document.getElementById('refreshBtn').addEventListener('click', () => {
        generateQRCode();
      });

      // QRã‚³ãƒ¼ãƒ‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      document.getElementById('downloadBtn').addEventListener('click', () => {
        downloadQRCode();
      });
    }
  </script>
</body>
</html>
