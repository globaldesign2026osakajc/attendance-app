<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>å‡ºå¸­ç‡åˆ†æ - ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/admin.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .analytics-filters {
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border-left: 4px solid var(--primary-color);
    }

    .stat-card.success {
      border-left-color: #28a745;
    }

    .stat-card.warning {
      border-left-color: #ffc107;
    }

    .stat-card.danger {
      border-left-color: #dc3545;
    }

    .stat-card.info {
      border-left-color: #17a2b8;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-color);
      line-height: 1;
    }

    .stat-unit {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-left: 0.25rem;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0 0 1.5rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
    }

    .chart-wrapper {
      position: relative;
      height: 400px;
    }

    .chart-wrapper.pie {
      height: 300px;
      max-width: 500px;
      margin: 0 auto;
    }

    .table-container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
    }

    .analytics-table {
      width: 100%;
      border-collapse: collapse;
    }

    .analytics-table th {
      background-color: #f8f9fa;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-color);
      border-bottom: 2px solid var(--border-color);
      white-space: nowrap;
    }

    .analytics-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .analytics-table tr:hover {
      background-color: #f8f9fa;
    }

    .percentage-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .percentage-bar-bg {
      flex: 1;
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }

    .percentage-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #20c997);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .percentage-text {
      font-weight: 600;
      color: var(--text-color);
      min-width: 50px;
      text-align: right;
    }

    .export-actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .no-data {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .no-data-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="admin-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h1 class="admin-sidebar-title">ç®¡ç†è€…ç”»é¢</h1>
        <p class="admin-sidebar-subtitle">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <nav class="admin-sidebar-nav">
        <a href="dashboard.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“Š</span>
          <span class="admin-sidebar-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
        <a href="events.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“…</span>
          <span class="admin-sidebar-text">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</span>
        </a>
        <a href="members.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ‘¥</span>
          <span class="admin-sidebar-text">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
        </a>
        <a href="analytics.html" class="admin-sidebar-item active">
          <span class="admin-sidebar-icon">ğŸ“ˆ</span>
          <span class="admin-sidebar-text">å‡ºå¸­ç‡åˆ†æ</span>
        </a>
        <a href="payments.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ’°</span>
          <span class="admin-sidebar-text">æ”¯æ‰•ã„ç®¡ç†</span>
        </a>
        <a href="checkin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“±</span>
          <span class="admin-sidebar-text">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
        </a>
        <a href="receipts-admin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ§¾</span>
          <span class="admin-sidebar-text">é ˜åæ›¸ç®¡ç†</span>
        </a>

        <div class="admin-sidebar-divider"></div>

        <a href="../home.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ </span>
          <span class="admin-sidebar-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸</span>
        </a>
      </nav>

      <div class="admin-sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block" style="color: white; border-color: rgba(255,255,255,0.3);">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-main">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="admin-topbar">
        <button class="admin-mobile-toggle" id="mobileToggle">
          â˜°
        </button>
        <h2 class="admin-topbar-title">å‡ºå¸­ç‡åˆ†æ</h2>
        <div class="admin-topbar-actions">
          <div class="admin-user-info">
            <span class="admin-user-icon">ğŸ‘¤</span>
            <div class="admin-user-details">
              <span class="admin-user-name" id="userName">ç®¡ç†è€…</span>
              <span class="admin-user-role">ç®¡ç†è€…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="admin-content">
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="analytics-filters">
          <div class="filter-row">
            <div class="form-group">
              <label for="filterStartDate" class="form-label">æœŸé–“ï¼ˆé–‹å§‹ï¼‰</label>
              <input type="date" id="filterStartDate" class="form-input">
            </div>

            <div class="form-group">
              <label for="filterEndDate" class="form-label">æœŸé–“ï¼ˆçµ‚äº†ï¼‰</label>
              <input type="date" id="filterEndDate" class="form-input">
            </div>

            <div class="form-group">
              <label for="filterPosition" class="form-label">å½¹è·</label>
              <select id="filterPosition" class="form-input">
                <option value="">å…¨ã¦</option>
              </select>
            </div>

            <div class="form-group">
              <label for="filterAffiliation" class="form-label">æ‰€å±</label>
              <select id="filterAffiliation" class="form-input">
                <option value="">å…¨ã¦</option>
              </select>
            </div>
          </div>

          <div class="filter-row">
            <div class="form-group">
              <label for="filterCommittee" class="form-label">å§”å“¡ä¼š</label>
              <select id="filterCommittee" class="form-input">
                <option value="">å…¨ã¦</option>
              </select>
            </div>

            <div class="form-group">
              <label for="filterTag" class="form-label">ã‚¿ã‚°</label>
              <select id="filterTag" class="form-input">
                <option value="">å…¨ã¦</option>
              </select>
            </div>

            <div class="form-group" style="display: flex; align-items: flex-end;">
              <button id="applyFilterBtn" class="btn btn-primary btn-block">
                ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
              </button>
            </div>

            <div class="form-group" style="display: flex; align-items: flex-end;">
              <button id="resetFilterBtn" class="btn btn-outline btn-block">
                ãƒªã‚»ãƒƒãƒˆ
              </button>
            </div>
          </div>
        </div>

        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">å…¨ä½“å‡ºå¸­ç‡</div>
            <div class="stat-value">
              <span id="overallRate">0</span><span class="stat-unit">%</span>
            </div>
          </div>

          <div class="stat-card success">
            <div class="stat-label">ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°</div>
            <div class="stat-value">
              <span id="totalEvents">0</span><span class="stat-unit">ä»¶</span>
            </div>
          </div>

          <div class="stat-card info">
            <div class="stat-label">å¹³å‡å‚åŠ è€…æ•°</div>
            <div class="stat-value">
              <span id="avgAttendees">0</span><span class="stat-unit">äºº</span>
            </div>
          </div>

          <div class="stat-card warning">
            <div class="stat-label">å¯¾è±¡ãƒ¡ãƒ³ãƒãƒ¼æ•°</div>
            <div class="stat-value">
              <span id="totalMembers">0</span><span class="stat-unit">äºº</span>
            </div>
          </div>
        </div>

        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
        <div class="export-actions">
          <button id="exportCsvBtn" class="btn btn-success">
            CSVå‡ºåŠ›
          </button>
        </div>

        <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
        <div class="chart-container">
          <h3 class="chart-title">å½¹è·åˆ¥å‡ºå¸­ç‡</h3>
          <div class="chart-wrapper">
            <canvas id="positionChart"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <h3 class="chart-title">æ‰€å±åˆ¥å‡ºå¸­ç‡</h3>
          <div class="chart-wrapper">
            <canvas id="affiliationChart"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <h3 class="chart-title">å§”å“¡ä¼šåˆ¥å‡ºå¸­ç‡</h3>
          <div class="chart-wrapper">
            <canvas id="committeeChart"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <h3 class="chart-title">å‡ºå¸­çŠ¶æ³ã®å‰²åˆ</h3>
          <div class="chart-wrapper pie">
            <canvas id="attendanceStatusChart"></canvas>
          </div>
        </div>

        <!-- è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="table-container">
          <h3 class="chart-title">ãƒ¡ãƒ³ãƒãƒ¼åˆ¥å‡ºå¸­ç‡</h3>
          <table class="analytics-table" id="memberTable">
            <thead>
              <tr>
                <th>ãƒ¡ãƒ³ãƒãƒ¼å</th>
                <th>å½¹è·</th>
                <th>æ‰€å±</th>
                <th>å§”å“¡ä¼š</th>
                <th>å‡ºå¸­å›æ•°</th>
                <th>å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆæ•°</th>
                <th>å‡ºå¸­ç‡</th>
              </tr>
            </thead>
            <tbody id="memberTableBody">
              <tr>
                <td colspan="7" class="no-data">
                  <div class="no-data-icon">ğŸ“Š</div>
                  <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    let analyticsData = null;
    let positionChart = null;
    let affiliationChart = null;
    let committeeChart = null;
    let statusChart = null;

    const userInfo = Auth.getUserInfo();

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      Auth.requireAdmin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();

      // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      await loadMasters();

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šï¼ˆéå»3ãƒ¶æœˆï¼‰
      const endDate = new Date();
      const startDate = new Date();
      startDate.setMonth(startDate.getMonth() - 3);

      document.getElementById('filterEndDate').value = endDate.toISOString().split('T')[0];
      document.getElementById('filterStartDate').value = startDate.toISOString().split('T')[0];

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      await loadAnalyticsData();
    });

    // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadMasters() {
      try {
        const result = await API.call('getMasters');

        if (result.success) {
          // å½¹è·
          const positionSelect = document.getElementById('filterPosition');
          if (result.positions) {
            result.positions.forEach(position => {
              const option = document.createElement('option');
              option.value = position;
              option.textContent = position;
              positionSelect.appendChild(option);
            });
          }

          // æ‰€å±
          const affiliationSelect = document.getElementById('filterAffiliation');
          if (result.affiliations) {
            result.affiliations.forEach(affiliation => {
              const option = document.createElement('option');
              option.value = affiliation;
              option.textContent = affiliation;
              affiliationSelect.appendChild(option);
            });
          }

          // å§”å“¡ä¼š
          const committeeSelect = document.getElementById('filterCommittee');
          if (result.committees) {
            result.committees.forEach(committee => {
              const option = document.createElement('option');
              option.value = committee;
              option.textContent = committee;
              committeeSelect.appendChild(option);
            });
          }

          // ã‚¿ã‚°
          const tagSelect = document.getElementById('filterTag');
          if (result.tags) {
            result.tags.forEach(tag => {
              const option = document.createElement('option');
              option.value = tag;
              option.textContent = tag;
              tagSelect.appendChild(option);
            });
          }
        }
      } catch (error) {
        console.error('Load masters error:', error);
      }
    }

    // åˆ†æãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadAnalyticsData() {
      Utils.showLoading();

      try {
        const filters = {
          start_date: document.getElementById('filterStartDate').value,
          end_date: document.getElementById('filterEndDate').value,
          position: document.getElementById('filterPosition').value,
          affiliation: document.getElementById('filterAffiliation').value,
          committee: document.getElementById('filterCommittee').value,
          tag: document.getElementById('filterTag').value
        };

        const result = await API.call('getAnalytics', filters);

        if (result.success) {
          analyticsData = result.data;
          renderAnalytics();
        } else {
          throw new Error(result.message || 'åˆ†æãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load analytics error:', error);
        Utils.showError('åˆ†æãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // åˆ†æãƒ‡ãƒ¼ã‚¿æç”»
    function renderAnalytics() {
      if (!analyticsData) return;

      // çµ±è¨ˆã‚«ãƒ¼ãƒ‰
      document.getElementById('overallRate').textContent = analyticsData.overall_rate || 0;
      document.getElementById('totalEvents').textContent = analyticsData.total_events || 0;
      document.getElementById('avgAttendees').textContent = analyticsData.avg_attendees || 0;
      document.getElementById('totalMembers').textContent = analyticsData.total_members || 0;

      // ã‚°ãƒ©ãƒ•æç”»
      renderPositionChart();
      renderAffiliationChart();
      renderCommitteeChart();
      renderStatusChart();

      // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
      renderMemberTable();
    }

    // å½¹è·åˆ¥å‡ºå¸­ç‡ã‚°ãƒ©ãƒ•
    function renderPositionChart() {
      const ctx = document.getElementById('positionChart');

      if (positionChart) {
        positionChart.destroy();
      }

      const data = analyticsData.by_position || [];

      positionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(item => item.position || 'æœªè¨­å®š'),
          datasets: [{
            label: 'å‡ºå¸­ç‡ (%)',
            data: data.map(item => item.rate),
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `å‡ºå¸­ç‡: ${context.parsed.y}%`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    }

    // æ‰€å±åˆ¥å‡ºå¸­ç‡ã‚°ãƒ©ãƒ•
    function renderAffiliationChart() {
      const ctx = document.getElementById('affiliationChart');

      if (affiliationChart) {
        affiliationChart.destroy();
      }

      const data = analyticsData.by_affiliation || [];

      affiliationChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(item => item.affiliation || 'æœªè¨­å®š'),
          datasets: [{
            label: 'å‡ºå¸­ç‡ (%)',
            data: data.map(item => item.rate),
            backgroundColor: 'rgba(75, 192, 192, 0.7)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `å‡ºå¸­ç‡: ${context.parsed.y}%`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    }

    // å§”å“¡ä¼šåˆ¥å‡ºå¸­ç‡ã‚°ãƒ©ãƒ•
    function renderCommitteeChart() {
      const ctx = document.getElementById('committeeChart');

      if (committeeChart) {
        committeeChart.destroy();
      }

      const data = analyticsData.by_committee || [];

      committeeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(item => item.committee || 'æœªè¨­å®š'),
          datasets: [{
            label: 'å‡ºå¸­ç‡ (%)',
            data: data.map(item => item.rate),
            backgroundColor: 'rgba(153, 102, 255, 0.7)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `å‡ºå¸­ç‡: ${context.parsed.y}%`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    }

    // å‡ºå¸­çŠ¶æ³å††ã‚°ãƒ©ãƒ•
    function renderStatusChart() {
      const ctx = document.getElementById('attendanceStatusChart');

      if (statusChart) {
        statusChart.destroy();
      }

      const statusData = analyticsData.by_status || { attended: 0, absent: 0, undecided: 0 };

      statusChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['å‡ºå¸­', 'æ¬ å¸­', 'æœªå®š'],
          datasets: [{
            data: [statusData.attended, statusData.absent, statusData.undecided],
            backgroundColor: [
              'rgba(40, 167, 69, 0.7)',
              'rgba(220, 53, 69, 0.7)',
              'rgba(255, 193, 7, 0.7)'
            ],
            borderColor: [
              'rgba(40, 167, 69, 1)',
              'rgba(220, 53, 69, 1)',
              'rgba(255, 193, 7, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return `${label}: ${value}ä»¶ (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«
    function renderMemberTable() {
      const tbody = document.getElementById('memberTableBody');
      const members = analyticsData.by_member || [];

      if (members.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="no-data">
              <div class="no-data-icon">ğŸ“Š</div>
              <div>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${Utils.escapeHtml(member.name)}</td>
          <td>${Utils.escapeHtml(member.position || '-')}</td>
          <td>${Utils.escapeHtml(member.affiliation || '-')}</td>
          <td>${Utils.escapeHtml(member.committee || '-')}</td>
          <td>${member.attended_count}</td>
          <td>${member.total_events}</td>
          <td>
            <div class="percentage-bar">
              <div class="percentage-bar-bg">
                <div class="percentage-bar-fill" style="width: ${member.rate}%"></div>
              </div>
              <span class="percentage-text">${member.rate}%</span>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // CSVå‡ºåŠ›
    function exportToCsv() {
      if (!analyticsData) {
        Utils.showError('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const members = analyticsData.by_member || [];

      if (members.length === 0) {
        Utils.showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      // CSVãƒ˜ãƒƒãƒ€ãƒ¼
      let csv = 'ãƒ¡ãƒ³ãƒãƒ¼å,å½¹è·,æ‰€å±,å§”å“¡ä¼š,å‡ºå¸­å›æ•°,å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆæ•°,å‡ºå¸­ç‡(%)\n';

      // ãƒ‡ãƒ¼ã‚¿è¡Œ
      members.forEach(member => {
        csv += `"${member.name}","${member.position || ''}","${member.affiliation || ''}","${member.committee || ''}",${member.attended_count},${member.total_events},${member.rate}\n`;
      });

      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      const now = new Date();
      const filename = `å‡ºå¸­ç‡åˆ†æ_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.csv`;

      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      Utils.showSuccess('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
      document.getElementById('mobileToggle').addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.toggle('mobile-open');
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
      document.getElementById('applyFilterBtn').addEventListener('click', () => {
        loadAnalyticsData();
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('resetFilterBtn').addEventListener('click', () => {
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        document.getElementById('filterPosition').value = '';
        document.getElementById('filterAffiliation').value = '';
        document.getElementById('filterCommittee').value = '';
        document.getElementById('filterTag').value = '';
        loadAnalyticsData();
      });

      // CSVå‡ºåŠ›
      document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
    }
  </script>
</body>
</html>
