<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ãƒ»ç·¨é›† - ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/admin.css">
  <style>
    .form-section {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .form-section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0 0 1.5rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-actions-sticky {
      position: sticky;
      bottom: 0;
      background-color: white;
      padding: 1.5rem 2rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
      z-index: 100;
    }

    /* ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .custom-option-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }

    .custom-option-item input[type="text"] {
      flex: 2;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .custom-option-item input[type="number"] {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .remove-option-btn {
      padding: 6px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }

    .remove-option-btn:hover {
      background: #c82333;
    }

    .btn-secondary {
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="admin-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h1 class="admin-sidebar-title">ç®¡ç†è€…ç”»é¢</h1>
        <p class="admin-sidebar-subtitle">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <nav class="admin-sidebar-nav">
        <a href="dashboard.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“Š</span>
          <span class="admin-sidebar-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
        <a href="events.html" class="admin-sidebar-item active">
          <span class="admin-sidebar-icon">ğŸ“…</span>
          <span class="admin-sidebar-text">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</span>
        </a>
        <a href="members.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ‘¥</span>
          <span class="admin-sidebar-text">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
        </a>
        <a href="analytics.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“ˆ</span>
          <span class="admin-sidebar-text">å‡ºå¸­ç‡åˆ†æ</span>
        </a>
        <a href="payments.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ’°</span>
          <span class="admin-sidebar-text">æ”¯æ‰•ã„ç®¡ç†</span>
        </a>
        <a href="checkin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“±</span>
          <span class="admin-sidebar-text">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
        </a>
        <a href="receipts-admin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ§¾</span>
          <span class="admin-sidebar-text">é ˜åæ›¸ç®¡ç†</span>
        </a>

        <div class="admin-sidebar-divider"></div>

        <a href="../home.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ </span>
          <span class="admin-sidebar-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸</span>
        </a>
      </nav>

      <div class="admin-sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block" style="color: white; border-color: rgba(255,255,255,0.3);">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-main">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="admin-topbar">
        <button class="admin-mobile-toggle" id="mobileToggle">
          â˜°
        </button>
        <h2 class="admin-topbar-title" id="pageTitle">ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²</h2>
        <div class="admin-topbar-actions">
          <div class="admin-user-info">
            <span class="admin-user-icon">ğŸ‘¤</span>
            <div class="admin-user-details">
              <span class="admin-user-name" id="userName">ç®¡ç†è€…</span>
              <span class="admin-user-role">ç®¡ç†è€…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="admin-content">
        <form id="eventForm">
          <!-- åŸºæœ¬æƒ…å ± -->
          <div class="form-section">
            <h3 class="form-section-title">åŸºæœ¬æƒ…å ±</h3>

            <div class="form-group">
              <label for="eventName" class="form-label required">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
              <input
                type="text"
                id="eventName"
                class="form-input"
                required
                placeholder="ä¾‹ï¼š12æœˆåº¦å§”å“¡ä¼š"
              >
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="eventDate" class="form-label required">é–‹å‚¬æ—¥</label>
                <input
                  type="date"
                  id="eventDate"
                  class="form-input"
                  required
                >
              </div>

              <div class="form-group">
                <label for="startTime" class="form-label">é–‹å§‹æ™‚é–“</label>
                <input
                  type="time"
                  id="startTime"
                  class="form-input"
                >
              </div>

              <div class="form-group">
                <label for="endTime" class="form-label">çµ‚äº†æ™‚é–“</label>
                <input
                  type="time"
                  id="endTime"
                  class="form-input"
                >
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="location" class="form-label">é–‹å‚¬å ´æ‰€</label>
                <input
                  type="text"
                  id="location"
                  class="form-input"
                  placeholder="ä¾‹ï¼šæ±äº¬å›½éš›ãƒ•ã‚©ãƒ¼ãƒ©ãƒ "
                >
              </div>

              <div class="form-group">
                <label for="mapUrl" class="form-label">MAP URL</label>
                <input
                  type="url"
                  id="mapUrl"
                  class="form-input"
                  placeholder="https://maps.google.com/..."
                >
              </div>
            </div>

            <div class="form-group">
              <label for="host" class="form-label">ä¸»å‚¬</label>
              <input
                type="text"
                id="host"
                class="form-input"
                placeholder="ä¾‹ï¼šã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³æ¨é€²å§”å“¡ä¼š"
              >
            </div>

            <div class="form-group">
              <label for="description" class="form-label">èª¬æ˜æ–‡</label>
              <textarea
                id="description"
                class="form-input"
                rows="4"
                placeholder="ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
              ></textarea>
            </div>

            <div class="form-check">
              <input
                type="checkbox"
                id="urgentFlag"
                class="form-check-input"
              >
              <label for="urgentFlag" class="form-check-label">
                è‡³æ€¥ç™»éŒ²ï¼ˆç·Šæ€¥ãƒ•ãƒ©ã‚°ï¼‰
              </label>
            </div>
          </div>

          <!-- å‡ºæ¬ ãƒ»ç· åˆ‡è¨­å®š -->
          <div class="form-section">
            <h3 class="form-section-title">å‡ºæ¬ ãƒ»ç· åˆ‡è¨­å®š</h3>

            <!-- å‡ºæ¬ ã‚¿ã‚¤ãƒ—é¸æŠ -->
            <div class="form-group" style="margin-bottom: 2rem;">
              <label class="form-label">å‡ºæ¬ ã‚¿ã‚¤ãƒ—</label>
              <div class="radio-group" style="display: flex; gap: 2rem; margin-top: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="radio" name="attendance_type" value="A" checked>
                  <span>ã‚¿ã‚¤ãƒ—A (ã‚·ãƒ³ãƒ—ãƒ«ãªå‡ºæ¬ )</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="radio" name="attendance_type" value="B">
                  <span>ã‚¿ã‚¤ãƒ—B (ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</span>
                </label>
              </div>
              <p style="font-size: 0.875rem; color: #6c757d; margin-top: 0.5rem;">
                ã‚¿ã‚¤ãƒ—A: å‚åŠ /ä¸å‚åŠ /æœªå®šã®ã‚·ãƒ³ãƒ—ãƒ«ãªé¸æŠ<br>
                ã‚¿ã‚¤ãƒ—B: ä»»æ„ã®é¸æŠè‚¢ã¨é‡‘é¡ã‚’è¨­å®šå¯èƒ½(ä¾‹: 15æ—¥å‚åŠ å®¿æ³Šãªã— 5,000å††)
              </p>
            </div>

            <!-- ã‚¿ã‚¤ãƒ—Bã®ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š -->
            <div id="customOptionsContainer" style="display: none; margin-bottom: 2rem;">
              <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">å‚åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š</h4>
              <div id="optionsList"></div>
              <button type="button" id="addOptionBtn" class="btn-secondary" style="margin-top: 1rem;">
                ï¼‹ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
              </button>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="deadline" class="form-label">å‡ºæ¬ ç· åˆ‡æ—¥</label>
                <input
                  type="date"
                  id="deadline"
                  class="form-input"
                >
              </div>

              <div class="form-group">
                <label for="registrationDeadline" class="form-label">ç™»éŒ²æœŸé™</label>
                <input
                  type="date"
                  id="registrationDeadline"
                  class="form-input"
                >
              </div>

              <div class="form-group">
                <label for="cancellationFeeDate" class="form-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ç™ºç”Ÿæ—¥</label>
                <input
                  type="date"
                  id="cancellationFeeDate"
                  class="form-input"
                >
              </div>
            </div>
          </div>

          <!-- å‚åŠ è²»ãƒ»æ”¯æ‰•ã„ -->
          <div class="form-section">
            <h3 class="form-section-title">å‚åŠ è²»ãƒ»æ”¯æ‰•ã„</h3>

            <div class="form-row">
              <div class="form-group">
                <label for="participationFee" class="form-label">å‚åŠ è²»ï¼ˆå††ï¼‰</label>
                <input
                  type="number"
                  id="participationFee"
                  class="form-input"
                  min="0"
                  placeholder="0"
                >
              </div>

              <div class="form-group">
                <label for="paymentMethods" class="form-label">æ”¯æ‰•ã„æ–¹æ³•</label>
                <select id="paymentMethods" class="form-input" multiple size="3">
                  <option value="ç¾åœ°æ‰•ã„">ç¾åœ°æ‰•ã„</option>
                  <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                </select>
                <small style="color: var(--text-secondary); font-size: 0.75rem;">
                  Ctrl/Cmdã‚’æŠ¼ã—ãªãŒã‚‰è¤‡æ•°é¸æŠå¯èƒ½
                </small>
              </div>
            </div>

            <div class="form-check">
              <input
                type="checkbox"
                id="receiptEnabled"
                class="form-check-input"
              >
              <label for="receiptEnabled" class="form-check-label">
                é ˜åæ›¸ç™ºè¡Œã‚’æœ‰åŠ¹ã«ã™ã‚‹
              </label>
            </div>

            <div class="form-group">
              <label for="receiptNoteDefault" class="form-label">é ˜åæ›¸ ä½†ã—æ›¸ãï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</label>
              <input
                type="text"
                id="receiptNoteDefault"
                class="form-input"
                placeholder="ä¾‹ï¼šä¼šè²»ã¨ã—ã¦ã€ç ”ä¿®è²»ã¨ã—ã¦ï¼ˆç©ºæ¬„ã®å ´åˆï¼šã‚¤ãƒ™ãƒ³ãƒˆå å‚åŠ è²»ã¨ã—ã¦ï¼‰"
              >
              <small style="color: var(--text-secondary); font-size: 0.75rem;">
                ãƒ¡ãƒ³ãƒãƒ¼ãŒé ˜åæ›¸ç™ºè¡Œæ™‚ã«å¤‰æ›´å¯èƒ½
              </small>
            </div>
          </div>

          <!-- ãã®ä»–è¨­å®š -->
          <div class="form-section">
            <h3 class="form-section-title">ãã®ä»–è¨­å®š</h3>

            <div class="form-group">
              <label for="dressCode" class="form-label">æœè£…è¦å®š</label>
              <select id="dressCode" class="form-input">
                <option value="">æŒ‡å®šãªã—</option>
                <option value="ã‚¹ãƒ¼ãƒ„">ã‚¹ãƒ¼ãƒ„</option>
                <option value="ãƒ“ã‚¸ãƒã‚¹ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«">ãƒ“ã‚¸ãƒã‚¹ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</option>
                <option value="ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</option>
              </select>
            </div>

            <div class="form-group">
              <label for="tags" class="form-label">ã‚¿ã‚°</label>
              <input
                type="text"
                id="tags"
                class="form-input"
                placeholder="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹ï¼šå§”å“¡ä¼š,æœˆä¾‹ä¼š,ç·ä¼šï¼‰"
              >
            </div>

            <div class="form-group">
              <label for="notes" class="form-label">å‚™è€ƒ</label>
              <textarea
                id="notes"
                class="form-input"
                rows="3"
                placeholder="ç®¡ç†è€…ç”¨ã®ãƒ¡ãƒ¢ã‚„å‚™è€ƒ..."
              ></textarea>
            </div>

            <div class="form-check">
              <input
                type="checkbox"
                id="calendarSync"
                class="form-check-input"
              >
              <label for="calendarSync" class="form-check-label">
                Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«é€£æº
              </label>
            </div>

            <div class="form-check">
              <input
                type="checkbox"
                id="qrEnabled"
                class="form-check-input"
                checked
              >
              <label for="qrEnabled" class="form-check-label">
                QRã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
              </label>
            </div>
          </div>

          <!-- ãƒ¡ãƒ³ãƒãƒ¼ã¸ã®è¡¨ç¤ºé …ç›® -->
          <div class="form-section">
            <h3 class="form-section-title">ãƒ¡ãƒ³ãƒãƒ¼ã¸ã®è¡¨ç¤ºé …ç›®</h3>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1.5rem;">
              ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚ŒãŸé …ç›®ã®ã¿ãƒ¡ãƒ³ãƒãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
              <div class="form-check">
                <input type="checkbox" id="display_date" class="form-check-input" checked>
                <label for="display_date" class="form-check-label">é–‹å‚¬æ—¥</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="display_time" class="form-check-input" checked>
                <label for="display_time" class="form-check-label">é–‹å‚¬æ™‚é–“</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="display_location" class="form-check-input" checked>
                <label for="display_location" class="form-check-label">é–‹å‚¬å ´æ‰€</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="display_map_url" class="form-check-input">
                <label for="display_map_url" class="form-check-label">MAP URL</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="display_host" class="form-check-input" checked>
                <label for="display_host" class="form-check-label">ä¸»å‚¬</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="display_description" class="form-check-input" checked>
                <label for="display_description" class="form-check-label">èª¬æ˜æ–‡</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="display_fee_amount" class="form-check-input" checked>
                <label for="display_fee_amount" class="form-check-label">å‚åŠ è²»</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="display_payment_methods" class="form-check-input">
                <label for="display_payment_methods" class="form-check-label">æ”¯æ‰•ã„æ–¹æ³•</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="display_dress_code" class="form-check-input" checked>
                <label for="display_dress_code" class="form-check-label">æœè£…è¦å®š</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="display_notes" class="form-check-input">
                <label for="display_notes" class="form-check-label">å‚™è€ƒ</label>
              </div>
            </div>
          </div>

        </form>
      </div>

      <!-- å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ -->
      <div class="form-actions-sticky">
        <button type="button" class="btn btn-outline btn-lg" onclick="history.back()">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="submit" form="eventForm" class="btn btn-primary btn-lg" id="submitBtn">
          ä¿å­˜
        </button>
      </div>
    </main>
  </div>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    let eventId = null;
    let isEditMode = false;
    const userInfo = Auth.getUserInfo();
    let customOptions = [];

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      Auth.requireAdmin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      await loadMasterData();

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
      eventId = Utils.getUrlParam('id');
      isEditMode = !!eventId;

      if (isEditMode) {
        document.getElementById('pageTitle').textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†';
        document.getElementById('submitBtn').textContent = 'æ›´æ–°';
        await loadEventData();
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadMasterData() {
      try {
        const result = await API.call('getMasters');

        if (result.success) {
          const masters = result.masters || {};

          // æ”¯æ‰•ã„æ–¹æ³•
          const paymentMethodsSelect = document.getElementById('paymentMethods');
          paymentMethodsSelect.innerHTML = '';
          (masters.payment_methods || []).forEach(method => {
            const option = document.createElement('option');
            option.value = method;
            option.textContent = method;
            paymentMethodsSelect.appendChild(option);
          });

          // æœè£…è¦å®š
          const dressCodeSelect = document.getElementById('dressCode');
          dressCodeSelect.innerHTML = '<option value="">æŒ‡å®šãªã—</option>';
          (masters.dress_codes || []).forEach(code => {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = code;
            dressCodeSelect.appendChild(option);
          });

          // ä¸»å‚¬ï¼ˆå§”å“¡ä¼šï¼‰
          const hostInput = document.getElementById('host');
          if (masters.committees && masters.committees.length > 0) {
            // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‹ã‚‰ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å¤‰æ›´
            const hostSelect = document.createElement('select');
            hostSelect.id = 'host';
            hostSelect.className = 'form-input';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'é¸æŠã—ã¦ãã ã•ã„';
            hostSelect.appendChild(defaultOption);

            masters.committees.forEach(committee => {
              const option = document.createElement('option');
              option.value = committee;
              option.textContent = committee;
              hostSelect.appendChild(option);
            });

            hostInput.parentNode.replaceChild(hostSelect, hostInput);
          }

          // ã‚¿ã‚°ï¼ˆãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆï¼‰
          const tagsInput = document.getElementById('tags');
          if (masters.tags && masters.tags.length > 0) {
            // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‹ã‚‰ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã«å¤‰æ›´
            const tagsSelect = document.createElement('select');
            tagsSelect.id = 'tags';
            tagsSelect.className = 'form-input';
            tagsSelect.multiple = true;
            tagsSelect.size = 3;

            masters.tags.forEach(tag => {
              const option = document.createElement('option');
              option.value = tag;
              option.textContent = tag;
              tagsSelect.appendChild(option);
            });

            const small = document.createElement('small');
            small.style.color = 'var(--text-secondary)';
            small.style.fontSize = '0.75rem';
            small.textContent = 'Ctrl/Cmdã‚’æŠ¼ã—ãªãŒã‚‰è¤‡æ•°é¸æŠå¯èƒ½';

            tagsInput.parentNode.replaceChild(tagsSelect, tagsInput);
            tagsSelect.parentNode.appendChild(small);
          }
        }
      } catch (error) {
        console.error('Load master data error:', error);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadEventData() {
      Utils.showLoading();

      try {
        const result = await API.call('getEventDetail', {
          event_id: eventId
        });

        if (result.success && result.event) {
          fillFormData(result.event);
        } else {
          throw new Error(result.message || 'ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load event error:', error);
        Utils.showError('ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setTimeout(() => {
          history.back();
        }, 2000);
      } finally {
        Utils.hideLoading();
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›
    function fillFormData(event) {
      document.getElementById('eventName').value = event.title || '';
      document.getElementById('eventDate').value = event.date || '';
      document.getElementById('startTime').value = event.start_time || '';
      document.getElementById('endTime').value = event.end_time || '';
      document.getElementById('location').value = event.location || '';
      document.getElementById('mapUrl').value = event.map_url || '';
      document.getElementById('description').value = event.description || '';
      document.getElementById('urgentFlag').checked = event.urgent || false;
      document.getElementById('deadline').value = event.attendance_deadline || '';
      document.getElementById('registrationDeadline').value = event.registration_deadline || '';
      document.getElementById('cancellationFeeDate').value = event.cancellation_fee_date || '';
      document.getElementById('participationFee').value = event.fee_amount || 0;
      document.getElementById('receiptEnabled').checked = event.receipt_enabled || false;
      document.getElementById('receiptNoteDefault').value = event.receipt_note_default || '';
      document.getElementById('dressCode').value = event.dress_code || '';
      document.getElementById('notes').value = event.notes || '';

      // ã‚¿ã‚°ã®è¨­å®šï¼ˆãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆï¼‰
      const tagsElement = document.getElementById('tags');
      if (tagsElement.tagName === 'SELECT') {
        // ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã®å ´åˆ
        if (event.tags) {
          const tags = event.tags.split(',').map(t => t.trim());
          Array.from(tagsElement.options).forEach(option => {
            option.selected = tags.includes(option.value);
          });
        }
      } else {
        // ãƒ†ã‚­ã‚¹ãƒˆã‚¤ãƒ³ãƒ—ãƒƒãƒˆã®å ´åˆ
        tagsElement.value = event.tags || '';
      }

      // ãƒ›ã‚¹ãƒˆã®è¨­å®šï¼ˆã‚»ãƒ¬ã‚¯ãƒˆã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆï¼‰
      const hostElement = document.getElementById('host');
      if (hostElement.tagName === 'SELECT') {
        hostElement.value = event.host || '';
      } else {
        hostElement.value = event.host || '';
      }

      // æ”¯æ‰•ã„æ–¹æ³•ï¼ˆè¤‡æ•°é¸æŠï¼‰
      if (event.payment_methods) {
        const methods = event.payment_methods.split(',').map(m => m.trim());
        const select = document.getElementById('paymentMethods');
        Array.from(select.options).forEach(option => {
          option.selected = methods.includes(option.value);
        });
      }

      document.getElementById('calendarSync').checked = event.calendar_sync || false;
      document.getElementById('qrEnabled').checked = event.qr_enabled !== false;

      // å‡ºæ¬ ã‚¿ã‚¤ãƒ—ã¨ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const attendanceType = event.attendance_type || 'A';
      document.querySelector(`input[name="attendance_type"][value="${attendanceType}"]`).checked = true;

      if (attendanceType === 'B' && event.participation_options) {
        customOptions = typeof event.participation_options === 'string'
          ? JSON.parse(event.participation_options)
          : event.participation_options;
        document.getElementById('customOptionsContainer').style.display = 'block';
        renderCustomOptions();
      }

      // è¡¨ç¤ºé …ç›®
      const displayFields = event.display_fields || {};
      Object.keys(displayFields).forEach(key => {
        const checkbox = document.getElementById(`display_${key}`);
        if (checkbox) {
          checkbox.checked = displayFields[key];
        }
      });
    }

    // ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤º
    function renderCustomOptions() {
      const container = document.getElementById('optionsList');
      container.innerHTML = customOptions.map((option, index) => `
        <div class="custom-option-item">
          <input type="text" placeholder="é¸æŠè‚¢åï¼ˆä¾‹ï¼šå®¿æ³Šã‚ã‚Šï¼‰" value="${option.label || ''}" onchange="updateOption(${index}, 'label', this.value)">
          <input type="number" placeholder="é‡‘é¡" value="${option.amount || 0}" min="0" onchange="updateOption(${index}, 'amount', parseInt(this.value) || 0)">
          <button type="button" class="remove-option-btn" onclick="removeOption(${index})">å‰Šé™¤</button>
        </div>
      `).join('');
    }

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
    function updateOption(index, field, value) {
      if (customOptions[index]) {
        customOptions[index][field] = value;
      }
    }

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ 
    function addCustomOption() {
      customOptions.push({ label: '', amount: 0 });
      renderCustomOptions();
    }

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‰Šé™¤
    function removeOption(index) {
      customOptions.splice(index, 1);
      renderCustomOptions();
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«è¿½åŠ 
    window.updateOption = updateOption;
    window.addCustomOption = addCustomOption;
    window.removeOption = removeOption;

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    async function handleSubmit(e) {
      e.preventDefault();

      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
      // å‡ºæ¬ ã‚¿ã‚¤ãƒ—
      const attendanceType = document.querySelector('input[name="attendance_type"]:checked').value;

      const formData = {
        title: document.getElementById('eventName').value.trim(),
        date: document.getElementById('eventDate').value,
        start_time: document.getElementById('startTime').value,
        end_time: document.getElementById('endTime').value,
        location: document.getElementById('location').value.trim(),
        map_url: document.getElementById('mapUrl').value.trim(),
        host: document.getElementById('host').value.trim(),
        description: document.getElementById('description').value.trim(),
        attendance_type: attendanceType,
        urgent: document.getElementById('urgentFlag').checked,
        attendance_deadline: document.getElementById('deadline').value,
        registration_deadline: document.getElementById('registrationDeadline').value,
        cancellation_fee_date: document.getElementById('cancellationFeeDate').value,
        fee_amount: parseInt(document.getElementById('participationFee').value) || 0,
        receipt_enabled: document.getElementById('receiptEnabled').checked,
        receipt_note_default: document.getElementById('receiptNoteDefault').value.trim(),
        dress_code: document.getElementById('dressCode').value,
        notes: document.getElementById('notes').value.trim(),
        calendar_sync: document.getElementById('calendarSync').checked,
        qr_enabled: document.getElementById('qrEnabled').checked
      };

      // ã‚¿ã‚°ã®å–å¾—ï¼ˆãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆï¼‰
      const tagsElement = document.getElementById('tags');
      if (tagsElement.tagName === 'SELECT') {
        const selectedTags = Array.from(tagsElement.selectedOptions).map(opt => opt.value);
        formData.tags = selectedTags.join(',');
      } else {
        formData.tags = tagsElement.value.trim();
      }

      // ã‚¿ã‚¤ãƒ—Bã®å ´åˆã€å‚åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      if (attendanceType === 'B') {
        formData.participation_options = customOptions;
      }

      // æ”¯æ‰•ã„æ–¹æ³•
      const paymentMethodsSelect = document.getElementById('paymentMethods');
      const selectedMethods = Array.from(paymentMethodsSelect.selectedOptions).map(opt => opt.value);
      formData.payment_methods = selectedMethods.join(',');

      // è¡¨ç¤ºé …ç›®
      const displayFields = {};
      ['date', 'time', 'location', 'map_url', 'host', 'description', 'fee_amount', 'payment_methods', 'dress_code', 'notes'].forEach(key => {
        const checkbox = document.getElementById(`display_${key}`);
        if (checkbox) {
          displayFields[key] = checkbox.checked;
        }
      });
      formData.display_fields = displayFields;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!formData.title) {
        Utils.showError('ã‚¤ãƒ™ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (!formData.date) {
        Utils.showError('é–‹å‚¬æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // ç¢ºèª
      const confirmMessage = isEditMode ? 'ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ' : 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ';
      if (!confirm(confirmMessage)) {
        return;
      }

      Utils.showLoading();

      try {
        let result;
        if (isEditMode) {
          formData.event_id = eventId;
          result = await API.call('updateEvent', { data: JSON.stringify(formData) });
        } else {
          result = await API.call('addEvent', { data: JSON.stringify(formData) });
        }

        if (result.success) {
          Utils.showSuccess(isEditMode ? 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
          setTimeout(() => {
            location.href = 'events.html';
          }, 1000);
        } else {
          throw new Error(result.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Save event error:', error);
        Utils.showError(error.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
      document.getElementById('mobileToggle').addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.toggle('mobile-open');
      });

      // å‡ºæ¬ ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('input[name="attendance_type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const customContainer = document.getElementById('customOptionsContainer');
          const participationFeeContainer = document.getElementById('participationFee').closest('.form-group');

          if (e.target.value === 'B') {
            customContainer.style.display = 'block';
            participationFeeContainer.style.display = 'none';
            if (customOptions.length === 0) {
              customOptions.push({ label: '', amount: 0 });
              renderCustomOptions();
            }
          } else {
            customContainer.style.display = 'none';
            participationFeeContainer.style.display = 'block';
          }
        });
      });

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ ãƒœã‚¿ãƒ³
      document.getElementById('addOptionBtn').addEventListener('click', addCustomOption);

      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
      document.getElementById('eventForm').addEventListener('submit', handleSubmit);
    }
  </script>
</body>
</html>
