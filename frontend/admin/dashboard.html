<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/admin.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="admin-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h1 class="admin-sidebar-title">ç®¡ç†è€…ç”»é¢</h1>
        <p class="admin-sidebar-subtitle">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <nav class="admin-sidebar-nav">
        <a href="dashboard.html" class="admin-sidebar-item active">
          <span class="admin-sidebar-icon">ğŸ“Š</span>
          <span class="admin-sidebar-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
        <a href="events.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“…</span>
          <span class="admin-sidebar-text">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</span>
        </a>
        <a href="members.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ‘¥</span>
          <span class="admin-sidebar-text">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
        </a>
        <a href="analytics.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“ˆ</span>
          <span class="admin-sidebar-text">å‡ºå¸­ç‡åˆ†æ</span>
        </a>
        <a href="payments.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ’°</span>
          <span class="admin-sidebar-text">æ”¯æ‰•ã„ç®¡ç†</span>
        </a>
        <a href="checkin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“±</span>
          <span class="admin-sidebar-text">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
        </a>
        <a href="receipts-admin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ§¾</span>
          <span class="admin-sidebar-text">é ˜åæ›¸ç®¡ç†</span>
        </a>

        <div class="admin-sidebar-divider"></div>

        <a href="../home.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ </span>
          <span class="admin-sidebar-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸</span>
        </a>
      </nav>

      <div class="admin-sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block" style="color: white; border-color: rgba(255,255,255,0.3);">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-main">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="admin-topbar">
        <button class="admin-mobile-toggle" id="mobileToggle">
          â˜°
        </button>
        <h2 class="admin-topbar-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
        <div class="admin-topbar-actions">
          <div class="admin-user-info">
            <span class="admin-user-icon">ğŸ‘¤</span>
            <div class="admin-user-details">
              <span class="admin-user-name" id="userName">ç®¡ç†è€…</span>
              <span class="admin-user-role">ç®¡ç†è€…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="admin-content">
        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-value" id="totalEvents">0</div>
                <div class="stat-card-label">ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°</div>
              </div>
              <div class="stat-card-icon primary">
                ğŸ“…
              </div>
            </div>
            <div class="stat-card-change positive" id="eventsChange">
              â†— ä»Šæœˆ <span id="eventsThisMonth">0</span> ä»¶
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-value" id="attendanceRate">0%</div>
                <div class="stat-card-label">å…¨ä½“å‡ºæ¬ ç‡</div>
              </div>
              <div class="stat-card-icon success">
                ğŸ“Š
              </div>
            </div>
            <div class="stat-card-change" id="attendanceChange">
              éå»3ãƒ¶æœˆã®å¹³å‡
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-value" id="unansweredCount">0</div>
                <div class="stat-card-label">æœªå›ç­”è€…æ•°</div>
              </div>
              <div class="stat-card-icon warning">
                â°
              </div>
            </div>
            <div class="stat-card-change" id="unansweredChange">
              ç›´è¿‘ã‚¤ãƒ™ãƒ³ãƒˆå¯¾è±¡
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-value" id="weeklyEvents">0</div>
                <div class="stat-card-label">ä»Šé€±ã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°</div>
              </div>
              <div class="stat-card-icon danger">
                ğŸ“†
              </div>
            </div>
            <div class="stat-card-change" id="weeklyChange">
              ä»Šé€±ã®äºˆå®š
            </div>
          </div>
        </div>

        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
        <div id="alertsContainer"></div>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-card" style="margin-bottom: 2rem;">
          <div class="admin-card-header">
            <h3 class="admin-card-title">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
          </div>
          <div class="admin-card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <button class="btn btn-primary btn-block" onclick="location.href='events.html?action=create'" style="padding: 1.5rem; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <span style="font-size: 2rem;">ğŸ“…</span>
                <span>æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²</span>
              </button>
              <button class="btn btn-success btn-block" onclick="location.href='members.html'" style="padding: 1.5rem; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <span style="font-size: 2rem;">ğŸ‘¥</span>
                <span>ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
              </button>
              <button class="btn btn-warning btn-block" onclick="location.href='checkin.html'" style="padding: 1.5rem; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <span style="font-size: 2rem;">ğŸ“±</span>
                <span>QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
              </button>
              <button class="btn btn-info btn-block" onclick="location.href='analytics.html'" style="padding: 1.5rem; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <span style="font-size: 2rem;">ğŸ“ˆ</span>
                <span>å‡ºå¸­ç‡åˆ†æ</span>
              </button>
            </div>
          </div>
        </div>

        <!-- ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
          <!-- æœˆåˆ¥ã‚¤ãƒ™ãƒ³ãƒˆæ•°æ¨ç§» -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">æœˆåˆ¥ã‚¤ãƒ™ãƒ³ãƒˆæ•°æ¨ç§»</h3>
            </div>
            <div class="admin-card-body">
              <canvas id="monthlyEventsChart" style="max-height: 300px;"></canvas>
            </div>
          </div>

          <!-- å‡ºæ¬ çŠ¶æ³ã®å‰²åˆ -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">å‡ºæ¬ çŠ¶æ³ã®å‰²åˆ</h3>
            </div>
            <div class="admin-card-body">
              <canvas id="attendanceStatusChart" style="max-height: 300px;"></canvas>
            </div>
          </div>
        </div>

        <!-- 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
          <!-- ä»Šå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆ -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">ä»Šå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
              <a href="events.html" class="btn btn-sm btn-outline">ã™ã¹ã¦è¦‹ã‚‹</a>
            </div>
            <div class="admin-card-body">
              <div id="upcomingEvents"></div>
            </div>
          </div>

          <!-- æœ€è¿‘ã®å‡ºæ¬ ç™»éŒ² -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">æœ€è¿‘ã®å‡ºæ¬ ç™»éŒ²</h3>
              <a href="events.html" class="btn btn-sm btn-outline">ã™ã¹ã¦è¦‹ã‚‹</a>
            </div>
            <div class="admin-card-body">
              <div id="recentAttendance"></div>
            </div>
          </div>
        </div>

        <!-- æœªå¯¾å¿œã‚¿ã‚¹ã‚¯ -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">æœªå¯¾å¿œã‚¿ã‚¹ã‚¯</h3>
          </div>
          <div class="admin-card-body">
            <div id="pendingTasks"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    const userInfo = Auth.getUserInfo();

    // ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    let monthlyEventsChart = null;
    let attendanceStatusChart = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      Auth.requireAdmin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—
      await loadDashboardData();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—
    async function loadDashboardData() {
      Utils.showLoading();

      try {
        // å„ç¨®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦è¡Œå–å¾—
        const [eventsResult, membersResult, statsResult, tasksResult, alertsResult] = await Promise.all([
          API.call('getEvents', {}),
          API.call('getMembers', {}),
          API.call('getDashboardStats', {}),
          API.call('getPendingTasks', {}),
          API.call('getAlerts', {})
        ]);

        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        updateStats(eventsResult, membersResult, statsResult);

        // ä»Šå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º
        displayUpcomingEvents(eventsResult.events || []);

        // æœ€è¿‘ã®å‡ºæ¬ ç™»éŒ²è¡¨ç¤º
        displayRecentAttendance(statsResult.recent_attendance || []);

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        displayAlerts(alertsResult.alerts || statsResult.alerts || []);

        // æœªå¯¾å¿œã‚¿ã‚¹ã‚¯è¡¨ç¤º
        displayPendingTasks(tasksResult.tasks || []);

        // ã‚°ãƒ©ãƒ•è¡¨ç¤º
        renderCharts(eventsResult.events || [], statsResult);

      } catch (error) {
        console.error('Load dashboard error:', error);
        Utils.showError('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // çµ±è¨ˆæƒ…å ±æ›´æ–°
    function updateStats(eventsResult, membersResult, statsResult) {
      const events = eventsResult.events || [];
      const members = membersResult.members || [];
      const stats = statsResult.stats || {};

      // ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°
      document.getElementById('totalEvents').textContent = events.length;

      // ä»Šæœˆã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°
      const now = new Date();
      const thisMonth = events.filter(e => {
        const eventDate = new Date(e.event_date);
        return eventDate.getMonth() === now.getMonth() &&
               eventDate.getFullYear() === now.getFullYear();
      }).length;
      document.getElementById('eventsThisMonth').textContent = thisMonth;

      // å¹³å‡å‡ºå¸­ç‡ï¼ˆå…¨ä½“å‡ºæ¬ ç‡ï¼‰
      const attendanceRate = stats.attendance_rate || 0;
      document.getElementById('attendanceRate').textContent = attendanceRate + '%';

      // æœªå›ç­”è€…æ•°
      const unansweredCount = stats.unanswered_count || 0;
      document.getElementById('unansweredCount').textContent = unansweredCount;

      // ä»Šé€±ã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°
      const startOfWeek = new Date(now);
      startOfWeek.setDate(now.getDate() - now.getDay()); // ä»Šé€±ã®æ—¥æ›œæ—¥
      startOfWeek.setHours(0, 0, 0, 0);

      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6); // ä»Šé€±ã®åœŸæ›œæ—¥
      endOfWeek.setHours(23, 59, 59, 999);

      const weeklyEvents = events.filter(e => {
        const eventDate = new Date(e.event_date);
        return eventDate >= startOfWeek && eventDate <= endOfWeek;
      }).length;
      document.getElementById('weeklyEvents').textContent = weeklyEvents;
    }

    // ä»Šå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º
    function displayUpcomingEvents(events) {
      const container = document.getElementById('upcomingEvents');
      const now = new Date();

      // æœªæ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿æŠ½å‡ºã—ã¦æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
      const upcomingEvents = events
        .filter(e => new Date(e.date) >= now)
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 5);

      if (upcomingEvents.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">ä»Šå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      container.innerHTML = upcomingEvents.map(event => {
        const eventDate = Utils.formatDateSlash(event.date);
        const dayOfWeek = Utils.getDayOfWeek(event.date);
        const attendCount = event.attend_count || 0;
        const pendingCount = event.pending_count || 0;

        return `
          <div style="padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer;"
               onclick="location.href='events.html?id=${event.event_id}'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
              <div style="font-weight: 600; color: var(--text-color);">${Utils.escapeHtml(event.title)}</div>
              ${event.urgent ? '<span class="badge badge-danger">ç·Šæ€¥</span>' : ''}
            </div>
            <div style="font-size: 0.813rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
              ğŸ“… ${eventDate}ï¼ˆ${dayOfWeek}ï¼‰
            </div>
            <div style="font-size: 0.813rem; color: var(--text-secondary);">
              å‡ºå¸­: ${attendCount}å / æœªç™»éŒ²: ${pendingCount}å
            </div>
          </div>
        `;
      }).join('');
    }

    // æœ€è¿‘ã®å‡ºæ¬ ç™»éŒ²è¡¨ç¤º
    function displayRecentAttendance(attendanceList) {
      const container = document.getElementById('recentAttendance');

      if (attendanceList.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">æœ€è¿‘ã®å‡ºæ¬ ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      container.innerHTML = attendanceList.slice(0, 5).map(item => {
        const registeredAt = Utils.formatDateTime(item.registered_at);
        const statusClass = item.status === 'å‡ºå¸­' ? 'success' : 'secondary';

        return `
          <div style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <div style="font-weight: 600; color: var(--text-color);">${Utils.escapeHtml(item.member_name)}</div>
              <span class="badge badge-${statusClass}">${item.status}</span>
            </div>
            <div style="font-size: 0.813rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
              ${Utils.escapeHtml(item.event_name)}
            </div>
            <div style="font-size: 0.75rem; color: var(--text-light);">
              ${registeredAt}
            </div>
          </div>
        `;
      }).join('');
    }

    // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function displayAlerts(alerts) {
      const container = document.getElementById('alertsContainer');

      if (!alerts || alerts.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = alerts.map(alert => {
        const typeClass = alert.type || 'info';
        const icon = {
          danger: 'âš ï¸',
          warning: 'â°',
          info: 'â„¹ï¸',
          success: 'âœ“'
        }[typeClass] || 'â„¹ï¸';

        const actionButton = alert.action_url ? `
          <button class="btn btn-sm btn-${typeClass}" onclick="location.href='${alert.action_url}'" style="margin-top: 0.5rem;">
            è©³ç´°ã‚’è¦‹ã‚‹
          </button>
        ` : '';

        return `
          <div class="admin-alert ${typeClass}" style="margin-bottom: 1rem;">
            <div class="admin-alert-icon">${icon}</div>
            <div class="admin-alert-content">
              <div class="admin-alert-title">${Utils.escapeHtml(alert.title)}</div>
              <div class="admin-alert-message">${Utils.escapeHtml(alert.message)}</div>
              ${actionButton}
            </div>
          </div>
        `;
      }).join('');
    }

    // æœªå¯¾å¿œã‚¿ã‚¹ã‚¯è¡¨ç¤º
    function displayPendingTasks(tasks) {
      const container = document.getElementById('pendingTasks');

      if (tasks.length === 0) {
        container.innerHTML = '<p style="color: var(--success-color); text-align: center; padding: 2rem;">âœ“ ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¦ã„ã¾ã™</p>';
        return;
      }

      container.innerHTML = `
        <div style="display: grid; gap: 1rem;">
          ${tasks.map(task => `
            <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.25rem;">
                  ${Utils.escapeHtml(task.title)}
                </div>
                <div style="font-size: 0.813rem; color: var(--text-secondary);">
                  ${Utils.escapeHtml(task.description)}
                </div>
              </div>
              <button class="btn btn-sm btn-primary" onclick="handleTask('${task.id}', '${task.action}')">
                å¯¾å¿œã™ã‚‹
              </button>
            </div>
          `).join('')}
        </div>
      `;
    }

    // ã‚¿ã‚¹ã‚¯å¯¾å¿œ
    function handleTask(taskId, action) {
      // ã‚¿ã‚¹ã‚¯ã«å¿œã˜ãŸç”»é¢ã«é·ç§»
      const actionMap = {
        'confirm_payment': 'payments.html',
        'issue_receipt': 'receipts-admin.html',
        'check_attendance': 'events.html'
      };

      const targetPage = actionMap[action] || 'dashboard.html';
      window.location.href = targetPage;
    }
    window.handleTask = handleTask;

    // ã‚°ãƒ©ãƒ•æç”»
    function renderCharts(events, statsResult) {
      // æœˆåˆ¥ã‚¤ãƒ™ãƒ³ãƒˆæ•°æ¨ç§»ã‚°ãƒ©ãƒ•
      renderMonthlyEventsChart(events);

      // å‡ºæ¬ çŠ¶æ³ã®å‰²åˆã‚°ãƒ©ãƒ•
      renderAttendanceStatusChart(statsResult);
    }

    // æœˆåˆ¥ã‚¤ãƒ™ãƒ³ãƒˆæ•°æ¨ç§»ã‚°ãƒ©ãƒ•
    function renderMonthlyEventsChart(events) {
      const ctx = document.getElementById('monthlyEventsChart');
      if (!ctx) return;

      // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ãŒã‚ã‚Œã°ç ´æ£„
      if (monthlyEventsChart) {
        monthlyEventsChart.destroy();
      }

      // éå»6ãƒ¶æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
      const now = new Date();
      const labels = [];
      const data = [];

      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthLabel = `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        labels.push(monthLabel);

        // ãã®æœˆã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        const count = events.filter(e => {
          const eventDate = new Date(e.event_date);
          return eventDate.getFullYear() === date.getFullYear() &&
                 eventDate.getMonth() === date.getMonth();
        }).length;
        data.push(count);
      }

      // ã‚°ãƒ©ãƒ•æç”»
      monthlyEventsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ã‚¤ãƒ™ãƒ³ãƒˆæ•°',
            data: data,
            borderColor: 'rgb(79, 70, 229)',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: {
                size: 14
              },
              bodyFont: {
                size: 13
              },
              callbacks: {
                label: function(context) {
                  return `ã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${context.parsed.y}ä»¶`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 11
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // å‡ºæ¬ çŠ¶æ³ã®å‰²åˆã‚°ãƒ©ãƒ•
    function renderAttendanceStatusChart(statsResult) {
      const ctx = document.getElementById('attendanceStatusChart');
      if (!ctx) return;

      // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ãŒã‚ã‚Œã°ç ´æ£„
      if (attendanceStatusChart) {
        attendanceStatusChart.destroy();
      }

      const stats = statsResult.stats || {};
      const attendanceStats = stats.attendance_stats || {
        attend: 0,
        absent: 0,
        pending: 0
      };

      // ã‚°ãƒ©ãƒ•æç”»
      attendanceStatusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['å‡ºå¸­', 'æ¬ å¸­', 'æœªå›ç­”'],
          datasets: [{
            data: [
              attendanceStats.attend || 0,
              attendanceStats.absent || 0,
              attendanceStats.pending || 0
            ],
            backgroundColor: [
              'rgba(34, 197, 94, 0.8)',   // ç·‘ï¼ˆå‡ºå¸­ï¼‰
              'rgba(239, 68, 68, 0.8)',    // èµ¤ï¼ˆæ¬ å¸­ï¼‰
              'rgba(156, 163, 175, 0.8)'   // ã‚°ãƒ¬ãƒ¼ï¼ˆæœªå›ç­”ï¼‰
            ],
            borderColor: [
              'rgb(34, 197, 94)',
              'rgb(239, 68, 68)',
              'rgb(156, 163, 175)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: {
                size: 14
              },
              bodyFont: {
                size: 13
              },
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value}å (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
      document.getElementById('mobileToggle').addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.toggle('mobile-open');
      });

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('adminSidebar');
        const toggle = document.getElementById('mobileToggle');

        if (window.innerWidth <= 1024 &&
            sidebar.classList.contains('mobile-open') &&
            !sidebar.contains(e.target) &&
            !toggle.contains(e.target)) {
          sidebar.classList.remove('mobile-open');
        }
      });
    }
  </script>
</body>
</html>
