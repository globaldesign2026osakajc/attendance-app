<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« - ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³æ¨é€²å§”å“¡ä¼š å‡ºæ¬ ç®¡ç†</title>
  <link rel="stylesheet" href="css/common.css">
  <style>
    .profile-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .profile-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .profile-header-content {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .profile-photo-wrapper {
      position: relative;
    }

    .profile-photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      background-color: var(--gray-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
    }

    .profile-photo-upload {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 36px;
      height: 36px;
      background-color: var(--primary-color);
      border-radius: 50%;
      border: 3px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
    }

    .profile-photo-upload:hover {
      background-color: var(--secondary-color);
      transform: scale(1.1);
    }

    .profile-header-info h2 {
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
    }

    .profile-header-meta {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .profile-section {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0 0 1.5rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .info-grid {
      display: grid;
      gap: 1.5rem;
    }

    .info-item {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 1rem;
      padding: 1rem;
      background-color: var(--gray-light);
      border-radius: 8px;
    }

    .info-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .info-value {
      font-size: 0.875rem;
      color: var(--text-color);
      font-weight: 500;
    }

    .edit-mode .info-item {
      background-color: white;
      border: 1px solid var(--border-color);
    }

    .password-requirements {
      background-color: var(--info-bg);
      color: var(--info-color);
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.813rem;
      margin-bottom: 1.5rem;
    }

    .password-requirements ul {
      margin: 0.5rem 0 0 1.5rem;
      padding: 0;
    }

    .password-requirements li {
      margin-bottom: 0.25rem;
    }

    .photo-upload-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .photo-upload-modal.active {
      display: flex;
    }

    .photo-upload-content {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
    }

    .photo-upload-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }

    .photo-preview {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 1.5rem;
      display: block;
      border: 2px solid var(--border-color);
    }

    .photo-upload-info {
      font-size: 0.813rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      text-align: center;
    }

    @media (max-width: 768px) {
      .profile-header-content {
        flex-direction: column;
        text-align: center;
      }

      .profile-section {
        padding: 1.5rem;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .info-item {
        grid-template-columns: 1fr;
      }

      .form-actions {
        flex-direction: column;
      }

      .form-actions .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-container">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="header-top">
        <h1 class="header-title">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="header-user">
          <span id="userName" class="header-user-name"></span>
          <button id="mobileNavToggle" class="mobile-nav-toggle">â˜°</button>
          <button id="logoutBtn" class="btn btn-secondary btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>

      <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <nav class="nav">
        <div class="nav-container">
          <a href="home.html" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">HOME</span>
          </a>
          <a href="events.html" class="nav-item">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-text">ã‚¤ãƒ™ãƒ³ãƒˆ</span>
          </a>
          <a href="members.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¥</span>
            <span class="nav-text">ãƒ¡ãƒ³ãƒãƒ¼</span>
          </a>
          <a href="history.html" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å±¥æ­´</span>
          </a>
          <a href="receipts.html" class="nav-item">
            <span class="nav-icon">ğŸ§¾</span>
            <span class="nav-text">é ˜åæ›¸</span>
          </a>
          <a href="profile.html" class="nav-item active">
            <span class="nav-icon">ğŸ‘¤</span>
            <span class="nav-text">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
          </a>
          <!-- ç®¡ç†è€…ç”¨ãƒªãƒ³ã‚¯ -->
          <a href="admin/dashboard.html" id="adminLink" class="nav-item" style="display: none;">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">ç®¡ç†ç”»é¢</span>
          </a>
        </div>
      </nav>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="container profile-container">
      <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="profile-header">
        <div class="profile-header-content">
          <div class="profile-photo-wrapper">
            <div id="profilePhoto" class="profile-photo">ğŸ‘¤</div>
            <button class="profile-photo-upload" onclick="openPhotoUpload()">ğŸ“·</button>
          </div>
          <div class="profile-header-info">
            <h2 id="profileName">-</h2>
            <div class="profile-header-meta">
              <div>æ¨©é™: <span id="profileRole">-</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- åŸºæœ¬æƒ…å ± -->
      <div class="profile-section">
        <h3 class="section-title">åŸºæœ¬æƒ…å ±</h3>
        <div id="basicInfoContent"></div>
      </div>

      <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ -->
      <div class="profile-section">
        <h3 class="section-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>

        <div class="password-requirements">
          <strong>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶ï¼š</strong>
          <ul>
            <li>8æ–‡å­—ä»¥ä¸Š</li>
            <li>è‹±æ•°å­—ã‚’å«ã‚€ã“ã¨æ¨å¥¨</li>
          </ul>
        </div>

        <form id="passwordForm">
          <div class="form-group">
            <label for="currentPassword" class="form-label required">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input
              type="password"
              id="currentPassword"
              class="form-input"
              required
              autocomplete="current-password"
            >
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="newPassword" class="form-label required">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <input
                type="password"
                id="newPassword"
                class="form-input"
                required
                minlength="8"
                autocomplete="new-password"
              >
            </div>

            <div class="form-group">
              <label for="confirmPassword" class="form-label required">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
              <input
                type="password"
                id="confirmPassword"
                class="form-input"
                required
                minlength="8"
                autocomplete="new-password"
              >
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="photoUploadModal" class="photo-upload-modal">
    <div class="photo-upload-content">
      <h3 class="photo-upload-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã‚’å¤‰æ›´</h3>

      <img id="photoPreview" class="photo-preview" src="" alt="Preview" style="display: none;">
      <div id="photoPlaceholder" class="photo-preview" style="display: flex; align-items: center; justify-content: center; font-size: 3rem; background-color: var(--gray-light);">
        ğŸ‘¤
      </div>

      <div class="photo-upload-info">
        JPGã€PNGå½¢å¼ / æœ€å¤§5MB
      </div>

      <div class="form-group">
        <input
          type="file"
          id="photoInput"
          accept="image/jpeg,image/png"
          class="form-input"
          onchange="previewPhoto()"
        >
      </div>

      <div class="form-actions">
        <button class="btn btn-outline" onclick="closePhotoUpload()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="uploadPhotoBtn" class="btn btn-primary" onclick="uploadPhoto()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </div>
  </div>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/nav.js"></script>

  <script>
    let memberData = null;
    const userInfo = Auth.getUserInfo();

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
      Auth.requireLogin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±å–å¾—
      await loadMemberInfo();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±å–å¾—
    async function loadMemberInfo() {
      showLoading();

      try {
        const result = await API.call('getMemberProfile');

        if (result.success && result.profile) {
          memberData = result.profile;
          displayMemberInfo();
        } else {
          throw new Error(result.message || 'ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load member info error:', error);
        showError('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }
    }

    // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±è¡¨ç¤º
    function displayMemberInfo() {
      // ãƒ˜ãƒƒãƒ€ãƒ¼
      document.getElementById('profileName').textContent = memberData.name;
      document.getElementById('profileRole').textContent = getRoleText(memberData.role);

      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ
      const photoElement = document.getElementById('profilePhoto');
      const photoUrl = memberData.PhotoURL || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23f1f5f9' width='100' height='100'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%2394a3b8' font-size='40'%3EğŸ‘¤%3C/text%3E%3C/svg%3E";
      photoElement.innerHTML = `<img src="${photoUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;

      // å…¥ä¼šå¹´åº¦ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
      const currentYear = new Date().getFullYear();
      const yearOptions = [];
      for (let year = currentYear; year >= 2010; year--) {
        yearOptions.push(`<option value="${year}" ${memberData['å…¥ä¼šå¹´åº¦'] == year ? 'selected' : ''}>${year}å¹´</option>`);
      }

      // åŸºæœ¬æƒ…å ±ï¼ˆç·¨é›†å¯èƒ½ãƒ•ã‚©ãƒ¼ãƒ ï¼‰
      const basicInfoContent = document.getElementById('basicInfoContent');
      basicInfoContent.innerHTML = `
        <form id="profileForm">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">æ°åï¼ˆã‚«ãƒŠï¼‰</label>
              <input type="text" id="kana" class="form-input" value="${escapeHtml(memberData.kana || '')}">
            </div>
            <div class="form-group">
              <label class="form-label">ã‚ã å</label>
              <input type="text" id="nickname" class="form-input" value="${escapeHtml(memberData['ã‚ã å'] || '')}">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">å½¹è·</label>
              <input type="text" id="position" class="form-input" value="${escapeHtml(memberData.position || '')}">
            </div>
            <div class="form-group">
              <label class="form-label">æ‰€å±</label>
              <input type="text" id="affiliation" class="form-input" value="${escapeHtml(memberData.affiliation || '')}">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">èª•ç”Ÿæ—¥</label>
              <input type="date" id="birthday" class="form-input" value="${memberData.birthday || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">å§”å“¡ä¼š</label>
              <input type="text" id="committee" class="form-input" value="${escapeHtml(memberData.committee || '')}">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">ä¸€è¨€</label>
            <textarea id="comment" class="form-input" rows="3">${escapeHtml(memberData['ä¸€è¨€'] || '')}</textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">LINEå</label>
              <input type="text" id="line_name" class="form-input" value="${escapeHtml(memberData['LINEå'] || '')}">
            </div>
            <div class="form-group">
              <label class="form-label">å…¥ä¼šå¹´åº¦</label>
              <select id="join_year" class="form-input">
                <option value="">æœªè¨­å®š</option>
                ${yearOptions.join('')}
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">å‡ºå‘å…ˆ</label>
              <input type="text" id="secondment" class="form-input" value="${escapeHtml(memberData['å‡ºå‘å…ˆ'] || '')}">
            </div>
            <div class="form-group">
              <label class="form-label">é›»è©±ç•ªå·</label>
              <input type="tel" id="phone" class="form-input" value="${escapeHtml(memberData['é›»è©±ç•ªå·'] || '')}">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ä¼šç¤¾å</label>
              <input type="text" id="company_name" class="form-input" value="${escapeHtml(memberData.company_name || '')}">
            </div>
            <div class="form-group">
              <label class="form-label">æ¥­ç¨®</label>
              <input type="text" id="industry" class="form-input" value="${escapeHtml(memberData['æ¥­ç¨®'] || '')}">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
              <input type="text" id="allergy" class="form-input" value="${escapeHtml(memberData['ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼'] || '')}">
            </div>
            <div class="form-group">
              <label class="form-label">å¥½ããªã‚‚ã®</label>
              <input type="text" id="favorite" class="form-input" value="${escapeHtml(memberData['å¥½ããªã‚‚ã®'] || '')}">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">å«Œã„ãªã‚‚ã®</label>
              <input type="text" id="dislike" class="form-input" value="${escapeHtml(memberData['å«Œã„ãªã‚‚ã®'] || '')}">
            </div>
            <div class="form-group">
              <label class="form-label">å¥½ããªå›½</label>
              <input type="text" id="favorite_country" class="form-input" value="${escapeHtml(memberData['å¥½ããªå›½'] || '')}">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">å¥½ããªè¨€è‘‰</label>
            <input type="text" id="favorite_word" class="form-input" value="${escapeHtml(memberData['å¥½ããªè¨€è‘‰'] || '')}">
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°</button>
          </div>
        </form>
      `;

      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('profileForm').addEventListener('submit', updateProfile);
    }

    // èª•ç”Ÿæ—¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatBirthday(birthday) {
      if (!birthday) return '-';
      const date = new Date(birthday);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      return `${month}æœˆ${day}æ—¥`;
    }

    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    // å½¹å‰²ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
    function getRoleText(role) {
      switch (role) {
        case 'staff': return 'ã‚¹ã‚¿ãƒƒãƒ•';
        case 'member': return 'ãƒ¡ãƒ³ãƒãƒ¼';
        default: return role;
      }
    }

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
    async function updateProfile(e) {
      e.preventDefault();

      if (!confirm('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      showLoading();

      try {
        const profileData = {
          kana: document.getElementById('kana').value.trim(),
          'ã‚ã å': document.getElementById('nickname').value.trim(),
          position: document.getElementById('position').value.trim(),
          affiliation: document.getElementById('affiliation').value.trim(),
          birthday: document.getElementById('birthday').value,
          committee: document.getElementById('committee').value.trim(),
          'ä¸€è¨€': document.getElementById('comment').value.trim(),
          'LINEå': document.getElementById('line_name').value.trim(),
          'å…¥ä¼šå¹´åº¦': document.getElementById('join_year').value,
          'å‡ºå‘å…ˆ': document.getElementById('secondment').value.trim(),
          'é›»è©±ç•ªå·': document.getElementById('phone').value.trim(),
          company_name: document.getElementById('company_name').value.trim(),
          'æ¥­ç¨®': document.getElementById('industry').value.trim(),
          'ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼': document.getElementById('allergy').value.trim(),
          'å¥½ããªã‚‚ã®': document.getElementById('favorite').value.trim(),
          'å«Œã„ãªã‚‚ã®': document.getElementById('dislike').value.trim(),
          'å¥½ããªå›½': document.getElementById('favorite_country').value.trim(),
          'å¥½ããªè¨€è‘‰': document.getElementById('favorite_word').value.trim()
        };

        const result = await API.call('updateMemberProfile', { data: JSON.stringify(profileData) });

        if (result.success) {
          showSuccess('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          await loadMemberInfo();
        } else {
          throw new Error(result.message || 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Update profile error:', error);
        showError(error.message || 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }
    }

    // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openPhotoUpload() {
      document.getElementById('photoUploadModal').classList.add('active');
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('photoPreview').style.display = 'none';
      document.getElementById('photoPlaceholder').style.display = 'flex';
      document.getElementById('photoInput').value = '';
    }
    window.openPhotoUpload = openPhotoUpload;

    // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closePhotoUpload() {
      document.getElementById('photoUploadModal').classList.remove('active');
    }
    window.closePhotoUpload = closePhotoUpload;

    // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    function previewPhoto() {
      const input = document.getElementById('photoInput');
      const preview = document.getElementById('photoPreview');
      const placeholder = document.getElementById('photoPlaceholder');

      if (input.files && input.files[0]) {
        const file = input.files[0];

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBï¼‰
        if (file.size > 5 * 1024 * 1024) {
          Utils.showError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
          input.value = '';
          return;
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.src = e.target.result;
          preview.style.display = 'block';
          placeholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    }
    window.previewPhoto = previewPhoto;

    // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    async function uploadPhoto() {
      const input = document.getElementById('photoInput');

      if (!input.files || !input.files[0]) {
        Utils.showError('å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const file = input.files[0];

      Utils.showLoading();

      try {
        // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        const reader = new FileReader();
        reader.onload = async (e) => {
          const base64Data = e.target.result.split(',')[1];

          const result = await API.call('uploadProfilePhoto', {
            file_data: base64Data,
            file_name: file.name,
            mime_type: file.type
          });

          if (result.success) {
            showSuccess('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            closePhotoUpload();
            // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å†å–å¾—
            await loadMemberInfo();
          } else {
            throw new Error(result.message || 'å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        };

        reader.onerror = () => {
          throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        };

        reader.readAsDataURL(file);

      } catch (error) {
        console.error('Upload photo error:', error);
        Utils.showError(error.message || 'å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
        Utils.hideLoading();
      }
    }
    window.uploadPhoto = uploadPhoto;

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
    async function changePassword(e) {
      e.preventDefault();

      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (newPassword.length < 8) {
        Utils.showError('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„');
        return;
      }

      if (newPassword !== confirmPassword) {
        Utils.showError('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
        return;
      }

      if (currentPassword === newPassword) {
        Utils.showError('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç•°ãªã‚‹ã‚‚ã®ã«ã—ã¦ãã ã•ã„');
        return;
      }

      // ç¢ºèª
      if (!confirm('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('changePassword', {
          member_id: userInfo.memberId,
          current_password: currentPassword,
          new_password: newPassword
        });

        if (result.success) {
          Utils.showSuccess('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
          document.getElementById('passwordForm').reset();
        } else {
          throw new Error(result.message || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Change password error:', error);
        Utils.showError(error.message || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ•ã‚©ãƒ¼ãƒ 
      document.getElementById('passwordForm').addEventListener('submit', changePassword);

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.getElementById('photoUploadModal').addEventListener('click', (e) => {
        if (e.target.id === 'photoUploadModal') {
          closePhotoUpload();
        }
      });
    }
  </script>
</body>
</html>
