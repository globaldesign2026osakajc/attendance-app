<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>é ˜åæ›¸ - ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³æ¨é€²å§”å“¡ä¼š å‡ºæ¬ ç®¡ç†</title>
  <link rel="stylesheet" href="css/common.css">
  <style>
    .receipts-header {
      background-color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .receipts-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0 0 1rem 0;
    }

    .receipts-subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .filter-section {
      background-color: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .receipts-list {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .receipts-count {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border-color);
    }

    .receipt-card {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .receipt-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: var(--primary-color);
    }

    .receipt-card.issued {
      background: linear-gradient(to right, var(--success-bg) 0%, white 10%);
      border-left: 4px solid var(--success-color);
    }

    .receipt-card.pending {
      background: linear-gradient(to right, var(--warning-bg) 0%, white 10%);
      border-left: 4px solid var(--warning-color);
    }

    .receipt-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .receipt-info {
      flex: 1;
    }

    .receipt-event-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }

    .receipt-event-date {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .receipt-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .receipt-status.issued {
      background-color: var(--success-bg);
      color: var(--success-color);
    }

    .receipt-status.pending {
      background-color: var(--warning-bg);
      color: var(--warning-color);
    }

    .receipt-status.unavailable {
      background-color: var(--gray-light);
      color: var(--text-secondary);
    }

    .receipt-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      padding: 1rem;
      background-color: var(--gray-light);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .receipt-detail-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .receipt-detail-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
    }

    .receipt-detail-value {
      font-size: 0.875rem;
      color: var(--text-color);
      font-weight: 600;
    }

    .receipt-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .receipt-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      background-color: white;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .receipt-btn:hover:not(:disabled) {
      background-color: var(--primary-bg);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .receipt-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .receipt-btn.primary {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .receipt-btn.primary:hover:not(:disabled) {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1rem;
      margin: 0;
    }

    .receipt-notice {
      background-color: var(--info-bg);
      color: var(--info-color);
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.813rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .receipt-notice-icon {
      font-size: 1.25rem;
    }

    @media (max-width: 768px) {
      .receipts-list {
        padding: 1.5rem;
      }

      .receipt-card {
        padding: 1.25rem;
      }

      .receipt-header {
        flex-direction: column;
      }

      .receipt-details {
        grid-template-columns: 1fr;
      }

      .receipt-actions {
        flex-direction: column;
      }

      .receipt-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-container">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="header-top">
        <h1 class="header-title">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="header-user">
          <span id="userName" class="header-user-name"></span>
          <button id="mobileNavToggle" class="mobile-nav-toggle">â˜°</button>
          <button id="logoutBtn" class="btn btn-secondary btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>

      <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <nav class="nav">
        <div class="nav-container">
          <a href="home.html" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">HOME</span>
          </a>
          <a href="events.html" class="nav-item">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-text">ã‚¤ãƒ™ãƒ³ãƒˆ</span>
          </a>
          <a href="members.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¥</span>
            <span class="nav-text">ãƒ¡ãƒ³ãƒãƒ¼</span>
          </a>
          <a href="history.html" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å±¥æ­´</span>
          </a>
          <a href="receipts.html" class="nav-item active">
            <span class="nav-icon">ğŸ§¾</span>
            <span class="nav-text">é ˜åæ›¸</span>
          </a>
          <a href="profile.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¤</span>
            <span class="nav-text">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
          </a>
          <!-- ç®¡ç†è€…ç”¨ãƒªãƒ³ã‚¯ -->
          <a href="admin/dashboard.html" id="adminLink" class="nav-item" style="display: none;">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">ç®¡ç†ç”»é¢</span>
          </a>
        </div>
      </nav>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="container">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="receipts-header">
        <h2 class="receipts-title">é ˜åæ›¸ä¸€è¦§</h2>
        <p class="receipts-subtitle">
          ç™»éŒ²æ–™ã‚’ãŠæ”¯æ‰•ã„ã„ãŸã ã„ãŸã‚¤ãƒ™ãƒ³ãƒˆã®é ˜åæ›¸ã‚’ç™ºè¡Œãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚<br>
          é ˜åæ›¸ã¯æ”¯æ‰•ç¢ºèªå¾Œã€è‡ªå‹•çš„ã«ç™ºè¡Œã•ã‚Œã¾ã™ã€‚
        </p>
      </div>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <div class="filter-section">
        <div class="filter-row">
          <!-- æœŸé–“é¸æŠ -->
          <div class="filter-group">
            <label class="filter-label">æœŸé–“</label>
            <select id="periodSelect" class="form-input">
              <option value="all">ã™ã¹ã¦</option>
              <option value="this-year">ä»Šå¹´</option>
              <option value="last-year">æ˜¨å¹´</option>
              <option value="last-3-months">éå»3ãƒ¶æœˆ</option>
              <option value="last-6-months">éå»6ãƒ¶æœˆ</option>
            </select>
          </div>

          <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ -->
          <div class="filter-group">
            <label class="filter-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="statusSelect" class="form-input">
              <option value="all">ã™ã¹ã¦</option>
              <option value="issued">ç™ºè¡Œæ¸ˆã¿</option>
              <option value="pending">ç™ºè¡Œå¯èƒ½</option>
            </select>
          </div>
        </div>
      </div>

      <!-- é ˜åæ›¸ãƒªã‚¹ãƒˆ -->
      <div class="receipts-list">
        <div class="receipts-count" id="receiptsCount">0ä»¶ã®é ˜åæ›¸</div>
        <div id="receiptsList"></div>
      </div>
    </div>
  </main>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/nav.js"></script>

  <script>
    let allReceipts = [];
    let filteredReceipts = [];
    const userInfo = Auth.getUserInfo();

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
    let filters = {
      period: 'all',
      status: 'all'
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
      Auth.requireLogin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // é ˜åæ›¸å–å¾—
      await loadReceipts();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // é ˜åæ›¸å–å¾—
    async function loadReceipts() {
      Utils.showLoading();

      try {
        const result = await API.call('getReceiptableEvents', {});

        if (result.success) {
          allReceipts = result.events || [];
          applyFilters();
        } else {
          throw new Error(result.error || 'é ˜åæ›¸ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load receipts error:', error);
        Utils.showError('é ˜åæ›¸ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    function applyFilters() {
      const now = new Date();

      filteredReceipts = allReceipts.filter(receipt => {
        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const eventDate = new Date(receipt.event_date);
        if (filters.period !== 'all') {
          if (filters.period === 'this-year' && eventDate.getFullYear() !== now.getFullYear()) {
            return false;
          }
          if (filters.period === 'last-year' && eventDate.getFullYear() !== now.getFullYear() - 1) {
            return false;
          }
          if (filters.period === 'last-3-months') {
            const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
            if (eventDate < threeMonthsAgo) {
              return false;
            }
          }
          if (filters.period === 'last-6-months') {
            const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
            if (eventDate < sixMonthsAgo) {
              return false;
            }
          }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (filters.status !== 'all') {
          if (filters.status === 'issued' && !receipt.receipt_url) {
            return false;
          }
          if (filters.status === 'pending' && receipt.receipt_url) {
            return false;
          }
        }

        return true;
      });

      displayReceipts();
    }

    // é ˜åæ›¸è¡¨ç¤º
    function displayReceipts() {
      const container = document.getElementById('receiptsList');
      const countElement = document.getElementById('receiptsCount');

      // ä»¶æ•°è¡¨ç¤º
      countElement.textContent = `${filteredReceipts.length}ä»¶ã®é ˜åæ›¸`;

      // ç©ºçŠ¶æ…‹
      if (filteredReceipts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ§¾</div>
            <p class="empty-state-text">è©²å½“ã™ã‚‹é ˜åæ›¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        `;
        return;
      }

      // é ˜åæ›¸ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
      container.innerHTML = filteredReceipts.map(receipt => createReceiptCard(receipt)).join('');
    }

    // é ˜åæ›¸ã‚«ãƒ¼ãƒ‰ä½œæˆ
    function createReceiptCard(receipt) {
      const eventDate = Utils.formatDateSlash(receipt.event_date);
      const dayOfWeek = Utils.getDayOfWeek(receipt.event_date);
      const amount = Utils.formatCurrency(receipt.payment_amount);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
      let statusClass = 'unavailable';
      let statusText = 'ç™ºè¡Œä¸å¯';
      let cardClass = '';

      if (receipt.receipt_issued) {
        statusClass = 'issued';
        statusText = 'âœ“ ç™ºè¡Œæ¸ˆã¿';
        cardClass = 'issued';
      } else if (receipt.can_issue) {
        statusClass = 'pending';
        statusText = 'ç™ºè¡Œå¯èƒ½';
        cardClass = 'pending';
      }

      return `
        <div class="receipt-card ${cardClass}">
          <div class="receipt-header">
            <div class="receipt-info">
              <div class="receipt-event-name">${Utils.escapeHtml(receipt.event_title)}</div>
              <div class="receipt-event-date">é–‹å‚¬æ—¥ï¼š${eventDate}ï¼ˆ${dayOfWeek}ï¼‰</div>
            </div>
            <div class="receipt-status ${statusClass}">${statusText}</div>
          </div>

          <div class="receipt-details">
            <div class="receipt-detail-item">
              <div class="receipt-detail-label">é‡‘é¡</div>
              <div class="receipt-detail-value">${amount}</div>
            </div>
            <div class="receipt-detail-item">
              <div class="receipt-detail-label">æ”¯æ‰•çŠ¶æ³</div>
              <div class="receipt-detail-value">${receipt.paid ? 'æ”¯æ‰•æ¸ˆã¿' : 'æœªæ‰•ã„'}</div>
            </div>
            ${receipt.receipt_number ? `
              <div class="receipt-detail-item">
                <div class="receipt-detail-label">é ˜åæ›¸ç•ªå·</div>
                <div class="receipt-detail-value">${receipt.receipt_number}</div>
              </div>
            ` : ''}
          </div>

          ${!receipt.paid ? `
            <div class="receipt-notice">
              <span class="receipt-notice-icon">â„¹ï¸</span>
              <span>æ”¯æ‰•ã„ãŒç¢ºèªã•ã‚Œã¦ã„ãªã„ãŸã‚ã€é ˜åæ›¸ã‚’ç™ºè¡Œã§ãã¾ã›ã‚“ã€‚</span>
            </div>
          ` : ''}

          <div class="receipt-actions">
            ${receipt.receipt_url ? `
              <button class="receipt-btn primary" onclick="downloadReceipt('${receipt.receipt_url}', '${receipt.receipt_number}')">
                <span>ğŸ“¥</span>
                <span>PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
              </button>
              <button class="receipt-btn" onclick="viewReceipt('${receipt.receipt_url}')">
                <span>ğŸ‘ï¸</span>
                <span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
              </button>
            ` : receipt.can_issue ? `
              <button class="receipt-btn primary" onclick="issueReceipt('${receipt.event_id}')">
                <span>ğŸ“</span>
                <span>é ˜åæ›¸ã‚’ç™ºè¡Œ</span>
              </button>
            ` : ''}
            <button class="receipt-btn" onclick="location.href='event-detail.html?id=${receipt.event_id}'">
              <span>ğŸ“…</span>
              <span>ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°</span>
            </button>
          </div>
        </div>
      `;
    }

    // é ˜åæ›¸ç™ºè¡Œ
    async function issueReceipt(eventId) {
      // ä¼šç¤¾åå…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      const companyName = prompt('é ˜åæ›¸ã®å®›åï¼ˆä¼šç¤¾åãƒ»å›£ä½“åï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '');

      if (!companyName) {
        return;
      }

      if (!confirm('é ˜åæ›¸ã‚’ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      Utils.showLoading();

      try {
        const data = {
          event_id: eventId,
          member_id: userInfo.memberId,
          company_name: companyName
        };

        const result = await API.call('issueReceipt', {}, true);

        // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆã€dataã‚’JSONæ–‡å­—åˆ—ã¨ã—ã¦é€ã‚‹
        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'issueReceipt',
            token: localStorage.getItem('authToken'),
            data: JSON.stringify(data)
          })
        });

        const result2 = await response.json();

        if (result2.success) {
          Utils.showSuccess('é ˜åæ›¸ã‚’ç™ºè¡Œã—ã¾ã—ãŸ');
          // é ˜åæ›¸ã‚’å†å–å¾—
          await loadReceipts();
        } else {
          throw new Error(result2.error || 'é ˜åæ›¸ã®ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Issue receipt error:', error);
        Utils.showError(error.message || 'é ˜åæ›¸ã®ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }
    window.issueReceipt = issueReceipt;

    // é ˜åæ›¸ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadReceipt(url, receiptNumber) {
      try {
        const a = document.createElement('a');
        a.href = url;
        a.download = `é ˜åæ›¸_${receiptNumber}.pdf`;
        a.target = '_blank';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (error) {
        console.error('Download error:', error);
        Utils.showError('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    window.downloadReceipt = downloadReceipt;

    // é ˜åæ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    function viewReceipt(url) {
      window.open(url, '_blank');
    }
    window.viewReceipt = viewReceipt;

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´
      document.getElementById('periodSelect').addEventListener('change', (e) => {
        filters.period = e.target.value;
        applyFilters();
      });

      document.getElementById('statusSelect').addEventListener('change', (e) => {
        filters.status = e.target.value;
        applyFilters();
      });
    }
  </script>
</body>
</html>
