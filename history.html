<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>å‡ºæ¬ å±¥æ­´ - ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³æ¨é€²å§”å“¡ä¼š å‡ºæ¬ ç®¡ç†</title>
  <link rel="stylesheet" href="css/common.css">
  <style>
    .stats-overview {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }

    .stats-section {
      margin-bottom: 2rem;
    }

    .stats-section:last-child {
      margin-bottom: 0;
    }

    .stats-section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary-color);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }

    .stat-card {
      background-color: var(--gray-light);
      border-radius: 8px;
      padding: 1rem;
      border-left: 4px solid var(--primary-color);
    }

    .stat-card.committee {
      border-left-color: #2196F3;
    }

    .stat-card.monthly-meeting {
      border-left-color: #4CAF50;
    }

    .stat-card.other {
      border-left-color: #FF9800;
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .stat-card-icon {
      font-size: 1.25rem;
    }

    .stat-card-label {
      font-size: 0.875rem;
      color: var(--text-color);
      font-weight: 600;
    }

    .stat-card-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
    }

    .stat-card-detail {
      font-size: 0.813rem;
      color: var(--text-secondary);
    }

    .stat-card-rate {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--success-color);
      margin-left: 0.5rem;
    }

    .filter-section {
      background-color: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .history-list {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border-color);
    }

    .history-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0;
    }

    .history-count {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
    }

    .history-table thead {
      background-color: var(--gray-light);
    }

    .history-table th {
      padding: 1rem;
      text-align: left;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-color);
      border-bottom: 2px solid var(--border-color);
    }

    .history-table td {
      padding: 1rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .history-table tbody tr {
      transition: background-color 0.3s ease;
      cursor: pointer;
    }

    .history-table tbody tr:hover {
      background-color: var(--gray-light);
    }

    .history-event-name {
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.25rem;
    }

    .history-event-date {
      font-size: 0.75rem;
      color: var(--text-light);
    }

    .history-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.813rem;
    }

    .history-status.attend {
      background-color: var(--success-bg);
      color: var(--success-color);
    }

    .history-status.absent {
      background-color: var(--gray-light);
      color: var(--text-secondary);
    }

    .history-status.pending {
      background-color: var(--warning-bg);
      color: var(--warning-color);
    }

    .payment-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.813rem;
    }

    .payment-status.paid {
      background-color: var(--success-bg);
      color: var(--success-color);
    }

    .payment-status.unpaid {
      background-color: var(--warning-bg);
      color: var(--warning-color);
    }

    .payment-status.free {
      background-color: var(--gray-light);
      color: var(--text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1rem;
      margin: 0;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      .history-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .history-table thead {
        display: none;
      }

      .history-table tbody {
        display: block;
      }

      .history-table tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
      }

      .history-table td {
        display: block;
        text-align: left;
        padding: 0.5rem 0;
        border: none;
      }

      .history-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--text-color);
        display: inline-block;
        width: 100px;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-container">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="header-top">
        <h1 class="header-title">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="header-user">
          <span id="userName" class="header-user-name"></span>
          <button id="mobileNavToggle" class="mobile-nav-toggle">â˜°</button>
          <button id="logoutBtn" class="btn btn-secondary btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>

      <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <nav class="nav">
        <div class="nav-container">
          <a href="home.html" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">HOME</span>
          </a>
          <a href="events.html" class="nav-item">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-text">ã‚¤ãƒ™ãƒ³ãƒˆ</span>
          </a>
          <a href="members.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¥</span>
            <span class="nav-text">ãƒ¡ãƒ³ãƒãƒ¼</span>
          </a>
          <a href="history.html" class="nav-item active">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å±¥æ­´</span>
          </a>
          <a href="receipts.html" class="nav-item">
            <span class="nav-icon">ğŸ§¾</span>
            <span class="nav-text">é ˜åæ›¸</span>
          </a>
          <a href="profile.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¤</span>
            <span class="nav-text">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
          </a>
          <!-- ç®¡ç†è€…ç”¨ãƒªãƒ³ã‚¯ -->
          <a href="admin/dashboard.html" id="adminLink" class="nav-item" style="display: none;">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">ç®¡ç†ç”»é¢</span>
          </a>
        </div>
      </nav>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="container">
      <h2 class="page-title">å‡ºæ¬ å±¥æ­´</h2>

      <!-- çµ±è¨ˆæ¦‚è¦ -->
      <div class="stats-overview">
        <!-- ç™»éŒ²å˜ä½ -->
        <div class="stats-section">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <h3 class="stats-section-title" style="margin-bottom: 0; border-bottom: none; padding-bottom: 0;">ğŸ“ ç™»éŒ²å˜ä½</h3>
            <select id="registrationTagSelect" class="filter-input" style="max-width: 300px; padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px;">
              <option value="">ç™»éŒ²å˜ä½ã‚’é¸æŠ...</option>
            </select>
          </div>
          <div id="registrationStatsDisplay" style="display: none;"></div>
        </div>

        <!-- å®Ÿå‡ºå¸­ -->
        <div class="stats-section">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <h3 class="stats-section-title" style="margin-bottom: 0; border-bottom: none; padding-bottom: 0;">âœ… å®Ÿå‡ºå¸­ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰</h3>
            <select id="checkinTagSelect" class="filter-input" style="max-width: 300px; padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px;">
              <option value="">ç™»éŒ²å˜ä½ã‚’é¸æŠ...</option>
            </select>
          </div>
          <div id="checkinStatsDisplay" style="display: none;"></div>
        </div>
      </div>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <div class="filter-section">
        <div class="filter-row">
          <!-- æœŸé–“é¸æŠ -->
          <div class="filter-group">
            <label class="filter-label">æœŸé–“</label>
            <select id="periodSelect" class="form-input">
              <option value="all">ã™ã¹ã¦</option>
              <option value="this-year">ä»Šå¹´</option>
              <option value="last-year">æ˜¨å¹´</option>
              <option value="this-month">ä»Šæœˆ</option>
              <option value="last-3-months">éå»3ãƒ¶æœˆ</option>
              <option value="last-6-months">éå»6ãƒ¶æœˆ</option>
            </select>
          </div>

          <!-- å‡ºæ¬ çŠ¶æ³é¸æŠ -->
          <div class="filter-group">
            <label class="filter-label">å‡ºæ¬ çŠ¶æ³</label>
            <select id="statusSelect" class="form-input">
              <option value="all">ã™ã¹ã¦</option>
              <option value="attend">å‡ºå¸­ã®ã¿</option>
              <option value="absent">æ¬ å¸­ã®ã¿</option>
              <option value="pending">æœªç™»éŒ²ã®ã¿</option>
            </select>
          </div>

          <!-- æ”¯æ‰•çŠ¶æ³é¸æŠ -->
          <div class="filter-group">
            <label class="filter-label">æ”¯æ‰•çŠ¶æ³</label>
            <select id="paymentSelect" class="form-input">
              <option value="all">ã™ã¹ã¦</option>
              <option value="paid">æ”¯æ‰•æ¸ˆã¿</option>
              <option value="unpaid">æœªæ‰•ã„</option>
            </select>
          </div>
        </div>
      </div>

      <!-- å±¥æ­´ãƒªã‚¹ãƒˆ -->
      <div class="history-list">
        <div class="history-header">
          <h3 class="history-title">å‡ºæ¬ è¨˜éŒ²</h3>
          <span class="history-count" id="historyCount">0ä»¶</span>
        </div>

        <div id="historyTable"></div>
      </div>
    </div>
  </main>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/nav.js"></script>

  <script>
    let allHistory = [];
    let filteredHistory = [];
    const userInfo = Auth.getUserInfo();

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
    let filters = {
      period: 'all',
      status: 'all',
      payment: 'all'
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
      Auth.requireLogin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ã‚¿ã‚°ä¸€è¦§å–å¾—
      await loadTags();

      // å±¥æ­´å–å¾—
      await loadHistory();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // å±¥æ­´å–å¾—
    async function loadHistory() {
      Utils.showLoading();

      try {
        // ãƒ©ãƒƒãƒ‘ãƒ¼ãŒæœªå®šç¾©ã®å ´åˆã«å‚™ãˆã€ç›´æ¥APIã‚’å‘¼ã¶
        const result = await (API.getAttendanceHistory ? API.getAttendanceHistory() : API.call('getMyAttendance'));

        if (result.success) {
          // GASå´ã¯ `attendances` ã‚’è¿”ã™ãŸã‚ãã‚Œã‚’å„ªå…ˆã—ã¦æ‰±ã†ã€‚
          // äº’æ›æ€§ã®ãŸã‚ `history` / `data` ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å—ã‘å–ã‚‹ã€‚
          allHistory = result.attendances || result.history || result.data || [];

          // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šå–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®æœ€åˆã®1ä»¶ã‚’ç¢ºèª
          if (allHistory.length > 0) {
            console.log('å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:', allHistory[0]);
            console.log('tagså½¢å¼:', typeof allHistory[0].tags, allHistory[0].tags);
            console.log('event_tagså½¢å¼:', typeof allHistory[0].event_tags, allHistory[0].event_tags);
            console.log('checked_in:', allHistory[0].checked_in);
            console.log('checkin_time:', allHistory[0].checkin_time);
            console.log('å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', Object.keys(allHistory[0]));

            // ã‚¿ã‚°æƒ…å ±ãŒã©ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚ã‚‹ã‹ç¢ºèª
            console.log('=== ã‚¿ã‚°é–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç¢ºèª ===');
            for (let key in allHistory[0]) {
              const value = allHistory[0][key];
              if (key.toLowerCase().includes('tag') ||
                  key.toLowerCase().includes('type') ||
                  key.toLowerCase().includes('category')) {
                console.log(`${key}:`, typeof value, value);
              }
            }
          }

          applyFilters();
          updateStats();
        } else {
          throw new Error(result.message || 'å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load history error:', error);
        Utils.showError('å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    function applyFilters() {
      const now = new Date();

      filteredHistory = allHistory.filter(item => {
        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const eventDate = new Date(item.event_date);
        if (filters.period !== 'all') {
          if (filters.period === 'this-year' && eventDate.getFullYear() !== now.getFullYear()) {
            return false;
          }
          if (filters.period === 'last-year' && eventDate.getFullYear() !== now.getFullYear() - 1) {
            return false;
          }
          if (filters.period === 'this-month') {
            if (eventDate.getFullYear() !== now.getFullYear() || eventDate.getMonth() !== now.getMonth()) {
              return false;
            }
          }
          if (filters.period === 'last-3-months') {
            const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
            if (eventDate < threeMonthsAgo) {
              return false;
            }
          }
          if (filters.period === 'last-6-months') {
            const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
            if (eventDate < sixMonthsAgo) {
              return false;
            }
          }
        }

        // å‡ºæ¬ çŠ¶æ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (filters.status !== 'all') {
          if (filters.status === 'attend' && item.attendance_status !== 'å‡ºå¸­') {
            return false;
          }
          if (filters.status === 'absent' && item.attendance_status !== 'æ¬ å¸­') {
            return false;
          }
          if (filters.status === 'pending' && item.attendance_status) {
            return false;
          }
        }

        // æ”¯æ‰•çŠ¶æ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (filters.payment !== 'all') {
          if (filters.payment === 'paid' && !item.payment_confirmed) {
            return false;
          }
          if (filters.payment === 'unpaid' && (item.payment_confirmed || item.participation_fee === 0)) {
            return false;
          }
        }

        return true;
      });

      displayHistory();
    }

    // ã‚¿ã‚°ã‚’é…åˆ—ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function normalizeTags(tags) {
      if (!tags) return [];
      if (Array.isArray(tags)) return tags;
      if (typeof tags === 'string') {
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã¾ãŸã¯å˜ä¸€ã®æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
        return tags.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
      }
      return [];
    }

    // ã‚¿ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function hasTag(item, tagName) {
      const tags = normalizeTags(item.tags || item.event_tags);
      return tags.some(tag => tag.includes(tagName));
    }

    // çµ±è¨ˆæ›´æ–°
    function updateStats() {
      const now = new Date();

      // ç™»éŒ²å˜ä½: å…¨ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆéå»+æœªæ¥ï¼‰ã‚’é›†è¨ˆ
      const allEvents = allHistory;

      // å®Ÿå‡ºå¸­: éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿é›†è¨ˆ
      const pastEvents = allHistory.filter(item => new Date(item.event_date) < now);

      // ã‚¿ã‚°åˆ¥ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ†é¡ï¼ˆç™»éŒ²å˜ä½ç”¨: å…¨ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
      const committeeEventsAll = allEvents.filter(item => hasTag(item, 'å§”å“¡ä¼š'));
      const monthlyEventsAll = allEvents.filter(item => hasTag(item, 'æœˆä¾‹ä¼š'));
      const otherEventsAll = allEvents.filter(item =>
        !hasTag(item, 'å§”å“¡ä¼š') && !hasTag(item, 'æœˆä¾‹ä¼š')
      );

      // ã‚¿ã‚°åˆ¥ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ†é¡ï¼ˆå®Ÿå‡ºå¸­ç”¨: éå»ã®ã¿ï¼‰
      const committeeEventsPast = pastEvents.filter(item => hasTag(item, 'å§”å“¡ä¼š'));
      const monthlyEventsPast = pastEvents.filter(item => hasTag(item, 'æœˆä¾‹ä¼š'));
      const otherEventsPast = pastEvents.filter(item =>
        !hasTag(item, 'å§”å“¡ä¼š') && !hasTag(item, 'æœˆä¾‹ä¼š')
      );

      // ç™»éŒ²å˜ä½ã®çµ±è¨ˆï¼ˆå…¨ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
      updateCategoryStats('reg', 'Committee', committeeEventsAll, false);
      updateCategoryStats('reg', 'Monthly', monthlyEventsAll, false);
      updateCategoryStats('reg', 'Other', otherEventsAll, false);

      // å®Ÿå‡ºå¸­ã®çµ±è¨ˆï¼ˆéå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ï¼‰
      updateCategoryStats('actual', 'Committee', committeeEventsPast, true);
      updateCategoryStats('actual', 'Monthly', monthlyEventsPast, true);
      updateCategoryStats('actual', 'Other', otherEventsPast, true);
    }

    // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥çµ±è¨ˆæ›´æ–°
    function updateCategoryStats(type, category, events, useCheckin) {
      const totalEvents = events.length;
      let attendCount = 0;

      if (useCheckin) {
        // å®Ÿå‡ºå¸­ï¼šãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
        // checked_in ãƒ•ãƒ©ã‚°ã¾ãŸã¯ checkin_time ã®æœ‰ç„¡ã§åˆ¤å®š
        attendCount = events.filter(item =>
          item.checked_in === true ||
          item.checked_in === 1 ||
          (item.checkin_time && item.checkin_time !== null)
        ).length;
      } else {
        // ç™»éŒ²å˜ä½ï¼šå‡ºå¸­ç™»éŒ²ãŒã‚ã‚‹ã‚‚ã®ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        // attendance_status ãŒã€Œå‡ºå¸­ã€ã€Œå‚åŠ ã€ã®å ´åˆã€ã¾ãŸã¯Bã‚¿ã‚¤ãƒ—ï¼ˆæ¬ å¸­ä»¥å¤–ï¼‰
        attendCount = events.filter(item => {
          if (!item.attendance_status) return false; // æœªç™»éŒ²ã¯é™¤å¤–
          if (item.attendance_status === 'æ¬ å¸­') return false; // æ¬ å¸­ã¯é™¤å¤–
          return true; // å‡ºå¸­ã€å‚åŠ ã€ãã®ä»–ã®Bã‚¿ã‚¤ãƒ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ã™ã¹ã¦ã‚«ã‚¦ãƒ³ãƒˆ
        }).length;
      }

      const rate = totalEvents > 0 ? Math.round((attendCount / totalEvents) * 100) : 0;

      // å€¤ã‚’æ›´æ–°
      document.getElementById(`${type}${category}Attend`).textContent = attendCount;
      document.getElementById(`${type}${category}Detail`).textContent =
        `${attendCount} / ${totalEvents}`;
      document.getElementById(`${type}${category}Rate`).textContent = `${rate}%`;
    }

    // å±¥æ­´è¡¨ç¤º
    function displayHistory() {
      const container = document.getElementById('historyTable');
      const countElement = document.getElementById('historyCount');

      // ä»¶æ•°è¡¨ç¤º
      countElement.textContent = `${filteredHistory.length}ä»¶`;

      // ç©ºçŠ¶æ…‹
      if (filteredHistory.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <p class="empty-state-text">è©²å½“ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        `;
        return;
      }

      // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
      container.innerHTML = `
        <table class="history-table">
          <thead>
            <tr>
              <th>é–‹å‚¬æ—¥</th>
              <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
              <th>å‡ºæ¬ </th>
              <th>å®Ÿå‡ºå¸­</th>
              <th>ç™»éŒ²æ–™</th>
              <th>æ”¯æ‰•</th>
            </tr>
          </thead>
          <tbody>
            ${filteredHistory.map(item => createHistoryRow(item)).join('')}
          </tbody>
        </table>
      `;
    }

    // å±¥æ­´è¡Œä½œæˆ
    function createHistoryRow(item) {
      const eventDate = Utils.formatDateSlash(item.event_date);
      const dayOfWeek = Utils.getDayOfWeek(item.event_date);

      // å‡ºæ¬ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
      let statusHTML = '';
      let statusClass = 'pending';

      if (!item.attendance_status) {
        // statusãŒãªã„å ´åˆã®ã¿æœªç™»éŒ²
        statusHTML = 'æœªç™»éŒ²';
        statusClass = 'pending';
      } else if (item.attendance_status === 'å‡ºå¸­') {
        statusHTML = 'âœ“ å‡ºå¸­';
        statusClass = 'attend';
      } else if (item.attendance_status === 'æ¬ å¸­') {
        statusHTML = 'âœ— æ¬ å¸­';
        statusClass = 'absent';
      } else {
        // Bã‚¿ã‚¤ãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
        statusHTML = item.attendance_status;
        statusClass = 'attend'; // Bã‚¿ã‚¤ãƒ—ã¯æ¬ å¸­ä»¥å¤–ã¯å‡ºå¸­æ‰±ã„
      }

      // å®Ÿå‡ºå¸­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰
      let checkinHTML = '';
      let checkinClass = 'pending';

      if (item.checked_in === true || item.checked_in === 1 || (item.checkin_time && item.checkin_time !== null)) {
        checkinHTML = 'âœ“ å‡ºå¸­';
        checkinClass = 'attend';
      } else {
        checkinHTML = 'ï¼';
        checkinClass = 'absent';
      }

      // ç™»éŒ²æ–™
      const fee = item.participation_fee > 0 ? Utils.formatCurrency(item.participation_fee) : 'ç„¡æ–™';

      // æ”¯æ‰•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
      let paymentHTML = '';
      let paymentClass = 'free';

      if (item.participation_fee > 0) {
        if (item.payment_confirmed) {
          paymentHTML = 'âœ“ æ”¯æ‰•æ¸ˆã¿';
          paymentClass = 'paid';
        } else if (item.attendance_status === 'å‡ºå¸­') {
          paymentHTML = 'æœªæ‰•ã„';
          paymentClass = 'unpaid';
        } else {
          paymentHTML = '-';
          paymentClass = 'free';
        }
      } else {
        paymentHTML = '-';
      }

      return `
        <tr onclick="location.href='event-detail.html?id=${item.event_id}'">
          <td data-label="é–‹å‚¬æ—¥">${eventDate}ï¼ˆ${dayOfWeek}ï¼‰</td>
          <td data-label="ã‚¤ãƒ™ãƒ³ãƒˆå">
            <div class="history-event-name">${Utils.escapeHtml(item.event_name)}</div>
          </td>
          <td data-label="å‡ºæ¬ ">
            <span class="history-status ${statusClass}">${statusHTML}</span>
          </td>
          <td data-label="å®Ÿå‡ºå¸­">
            <span class="history-status ${checkinClass}">${checkinHTML}</span>
          </td>
          <td data-label="ç™»éŒ²æ–™">${fee}</td>
          <td data-label="æ”¯æ‰•">
            <span class="payment-status ${paymentClass}">${paymentHTML}</span>
          </td>
        </tr>
      `;
    }

    // ã‚¿ã‚°ä¸€è¦§å–å¾—
    async function loadTags() {
      try {
        const result = await API.call('getMasters', {});

        if (result.success && result.masters.tags) {
          // ç™»éŒ²å˜ä½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨
          const registrationTagSelect = document.getElementById('registrationTagSelect');
          // å®Ÿå‡ºå¸­ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨
          const checkinTagSelect = document.getElementById('checkinTagSelect');

          result.masters.tags.forEach(tag => {
            // ç™»éŒ²å˜ä½ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const option2 = document.createElement('option');
            option2.value = tag;
            option2.textContent = tag;
            registrationTagSelect.appendChild(option2);

            // å®Ÿå‡ºå¸­ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const option3 = document.createElement('option');
            option3.value = tag;
            option3.textContent = tag;
            checkinTagSelect.appendChild(option3);
          });
        }
      } catch (error) {
        console.error('Load tags error:', error);
      }
    }

    // ç™»éŒ²å˜ä½ã®çµ±è¨ˆã‚’è¡¨ç¤º
    async function displayRegistrationStats(tagName) {
      const container = document.getElementById('registrationStatsDisplay');

      if (!tagName) {
        container.style.display = 'none';
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('getMyTagStats', {
          tag_name: tagName
        });

        if (result.success) {
          const registrationRate = result.event_count > 0
            ? Math.round((result.registered_count / result.event_count) * 100)
            : 0;

          container.innerHTML = `
            <div class="stats-grid">
              <div class="stat-card committee">
                <div class="stat-card-header">
                  <div class="stat-card-icon">ğŸ¢</div>
                  <div class="stat-card-label">${Utils.escapeHtml(tagName)}</div>
                </div>
                <div class="stat-card-value">${result.registered_count}</div>
                <div class="stat-card-detail">
                  <span>${result.registered_count} / ${result.event_count}</span>
                  <span class="stat-card-rate">${registrationRate}%</span>
                </div>
              </div>
            </div>
          `;
          container.style.display = 'block';
        } else {
          throw new Error(result.error || 'çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('Load registration stats error:', error);
        Utils.showError('çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // å®Ÿå‡ºå¸­ã®çµ±è¨ˆã‚’è¡¨ç¤º
    async function displayCheckinStats(tagName) {
      const container = document.getElementById('checkinStatsDisplay');

      if (!tagName) {
        container.style.display = 'none';
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('getMyTagStats', {
          tag_name: tagName
        });

        if (result.success) {
          // å®Ÿå‡ºå¸­ã®æ¯æ•°ã¯é–‹å‚¬æ¸ˆã‚¤ãƒ™ãƒ³ãƒˆæ•°
          const completedCount = result.completed_event_count || 0;
          const attendanceRate = completedCount > 0
            ? Math.round((result.attended_count / completedCount) * 100)
            : 0;

          container.innerHTML = `
            <div class="stats-grid">
              <div class="stat-card committee">
                <div class="stat-card-header">
                  <div class="stat-card-icon">ğŸ¢</div>
                  <div class="stat-card-label">${Utils.escapeHtml(tagName)}</div>
                </div>
                <div class="stat-card-value">${result.attended_count}</div>
                <div class="stat-card-detail">
                  <span>${result.attended_count} / ${completedCount}</span>
                  <span class="stat-card-rate">${attendanceRate}%</span>
                </div>
              </div>
            </div>
          `;
          container.style.display = 'block';
        } else {
          throw new Error(result.error || 'çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('Load checkin stats error:', error);
        Utils.showError('çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ç™»éŒ²å˜ä½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚°é¸æŠ
      document.getElementById('registrationTagSelect').addEventListener('change', async (e) => {
        await displayRegistrationStats(e.target.value);
      });

      // å®Ÿå‡ºå¸­ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚°é¸æŠ
      document.getElementById('checkinTagSelect').addEventListener('change', async (e) => {
        await displayCheckinStats(e.target.value);
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´
      document.getElementById('periodSelect').addEventListener('change', (e) => {
        filters.period = e.target.value;
        applyFilters();
      });

      document.getElementById('statusSelect').addEventListener('change', (e) => {
        filters.status = e.target.value;
        applyFilters();
      });

      document.getElementById('paymentSelect').addEventListener('change', (e) => {
        filters.payment = e.target.value;
        applyFilters();
      });
    }
  </script>
</body>
</html>
