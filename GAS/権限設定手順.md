# 🔐 権限設定手順

## 問題: 「認証が必要です」エラー

Web Appデプロイ後、以下のエラーが表示される場合:
```json
{"error":"Unauthorized","message":"認証が必要です"}
```

これは、Apps Scriptプロジェクトに必要な権限が付与されていないためです。

---

## ✅ 解決方法

### ステップ1: appsscript.json の設定

Apps Scriptエディタで:

1. 左メニューの「プロジェクトの設定」（⚙️アイコン）をクリック
2. 「appsscript.json」マニフェスト ファイルをエディタで表示する」にチェック
3. 左メニューに「appsscript.json」が表示される
4. 以下の内容で置き換え:

```json
{
  "timeZone": "Asia/Tokyo",
  "dependencies": {
    "enabledAdvancedServices": [
      {
        "userSymbol": "Calendar",
        "version": "v3",
        "serviceId": "calendar"
      }
    ]
  },
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/calendar",
    "https://www.googleapis.com/auth/script.external_request"
  ],
  "webapp": {
    "executeAs": "USER_DEPLOYING",
    "access": "ANYONE"
  }
}
```

5. 保存（Ctrl+S または Cmd+S）

### ステップ2: Calendar API サービスの追加

1. 左メニューの「サービス」（＋アイコン）をクリック
2. 「Google Calendar API」を検索
3. バージョン: **v3** を選択
4. 「追加」をクリック

### ステップ3: 初期化テストの実行

1. `初期化テスト.gs` ファイルを開く
2. 関数選択ドロップダウンで `testConnection` を選択
3. 「実行」（▶️）ボタンをクリック
4. **「承認が必要です」** と表示される
5. 「権限を確認」をクリック
6. Googleアカウントを選択
7. **「詳細」** をクリック
8. **「(プロジェクト名)（安全ではないページ）に移動」** をクリック
9. 以下の権限が表示される:
   - Google ドライブのファイルの表示、編集、作成、削除
   - Google カレンダーの予定の表示と編集
   - Google スプレッドシートの表示と管理
10. **「許可」** をクリック

### ステップ4: 実行ログの確認

実行ログ（Ctrl+Enter または Cmd+Enter）で以下が表示されれば成功:

```
✅ スプレッドシート接続成功: 出欠管理システム
📋 シート数: 15
  - members
  - events
  - attendance
  ...
👥 メンバー数（ヘッダー除く）: 1
✅ プロフィール写真フォルダ接続成功: profile_photos
✅ 領収書フォルダ接続成功: 領収書
✅ 領収書テンプレート接続成功: 領収書テンプレート
✅ カレンダー接続成功: グローバルデザイン推進委員会

🎉 すべての接続テストが成功しました！
Web Appとして正常に動作します。
```

### ステップ5: 再デプロイ

権限を付与した後は、**必ず再デプロイ**してください:

1. 「デプロイ」→「デプロイを管理」
2. 鉛筆アイコン（編集）をクリック
3. バージョン: **新しいバージョン**
4. 「デプロイ」をクリック

**重要**: URLは変わりませんが、権限設定を反映させるために再デプロイが必要です。

### ステップ6: Web Appのテスト

ブラウザで以下のURLにアクセス:

```
https://script.google.com/macros/s/AKfycbzTThSpmZmrYwPosNK2mhyk9KHgrJXUmwRX70pPVRO_-kT2T-VJpiC3TuG6YYlSvr0/exec?action=login&login_id=yamada&password=password123
```

**成功時のレスポンス:**
```json
{
  "success": true,
  "token": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "member_id": "M001",
  "name": "山田太郎",
  "role": "staff"
}
```

---

## 🔍 トラブルシューティング

### エラー1: 「認証が必要です」

**原因**: トークンが無効または期限切れ

**解決策**:
- ログインAPIを呼び出して新しいトークンを取得
- トークンは24時間有効

### エラー2: 「メンバーが見つかりません」

**原因**: `members` シートにサンプルデータがない

**解決策**:
1. スプレッドシートの `members` シートを開く
2. 2行目（ヘッダーの次）にサンプルデータが存在するか確認
3. なければ、以下のデータを追加:

| member_id | name | login_id | password | kana | affiliation | position | birthday | PhotoURL | role | committee | company_name | registered_at |
|-----------|------|----------|----------|------|-------------|----------|----------|----------|------|-----------|--------------|---------------|
| M001 | 山田太郎 | yamada | password123 | ヤマダタロウ | 営業部 | 委員長 | 1990-01-01 | | staff | グローバルデザイン推進委員会 | 株式会社サンプル | (今日の日付) |

### エラー3: 「プロフィール写真フォルダにアクセスできません」

**原因**: フォルダIDが間違っているか、権限がない

**解決策**:
1. Google Driveで該当フォルダを開く
2. URLから正しいフォルダIDを確認
3. `Config.gs` の `PROFILE_PHOTO_FOLDER_ID` を更新
4. フォルダの共有設定で、自分（スクリプトの所有者）が編集権限を持っているか確認

### エラー4: 「カレンダーが見つかりません」

**原因**: カレンダーIDが間違っているか、Calendar APIが有効になっていない

**解決策**:
1. Googleカレンダーで該当カレンダーを開く
2. 設定でカレンダーIDを確認
3. `Config.gs` の `CALENDAR_ID` を更新
4. Apps Scriptで「サービス」→「Google Calendar API」を追加

---

## 📞 まだエラーが出る場合

以下の情報を確認してください:

1. **実行ログ**: `Ctrl+Enter` (Windows) または `Cmd+Enter` (Mac) でログを表示
2. **エラーメッセージ全文**: エラーの詳細を確認
3. **権限承認画面**: すべての権限を「許可」したか確認
4. **再デプロイ**: 権限付与後に必ず再デプロイ

権限設定後、すべてのAPIが正常に動作するようになります。
