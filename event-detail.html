<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´° - ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³æ¨é€²å§”å“¡ä¼š å‡ºæ¬ ç®¡ç†</title>
  <link rel="stylesheet" href="css/common.css">
  <style>
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary-color);
      text-decoration: none;
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
      transition: color 0.3s ease;
    }

    .back-link:hover {
      color: var(--secondary-color);
    }

    .event-detail-card {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .event-header {
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 1rem;
      margin-bottom: 1rem;
    }

    .event-title-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .event-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0;
      flex: 1;
    }

    .event-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .event-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .event-info-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .event-info-icon {
      font-size: 1.5rem;
      min-width: 1.5rem;
    }

    .event-info-content {
      flex: 1;
    }

    .event-info-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .event-info-value {
      font-size: 1rem;
      color: var(--text-color);
      font-weight: 500;
    }

    .event-description {
      background-color: var(--gray-light);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .event-description-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 0.75rem;
    }

    .event-description-text {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .attendance-section {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .attendance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .attendance-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0;
    }

    .current-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .current-status.attend {
      background-color: var(--success-bg);
      color: var(--success-color);
    }

    .current-status.official-absence {
      background-color: #fff4e6;
      color: #f59e0b;
    }

    .current-status.absent {
      background-color: var(--gray-light);
      color: var(--text-secondary);
    }

    .current-status.pending {
      background-color: var(--warning-bg);
      color: var(--warning-color);
    }

    .deadline-notice {
      background-color: var(--danger-bg);
      color: var(--danger-color);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .deadline-notice.warning {
      background-color: var(--warning-bg);
      color: var(--warning-color);
    }

    .deadline-notice.expired {
      background-color: var(--gray-light);
      color: var(--text-secondary);
    }

    .attendance-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .attendance-btn {
      padding: 1rem;
      border: 2px solid var(--border-color);
      background-color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .attendance-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .attendance-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .attendance-btn.selected {
      border-color: var(--primary-color);
      background-color: var(--primary-bg);
    }

    .attendance-btn-icon {
      font-size: 2rem;
    }

    .attendance-btn-content {
      flex: 1;
    }

    .attendance-btn-label {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 0.25rem;
    }

    .attendance-btn-desc {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .reason-section {
      margin-bottom: 1.5rem;
    }

    .reason-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.5rem;
      display: block;
    }

    .reason-textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.875rem;
      font-family: inherit;
      resize: vertical;
      transition: all 0.3s ease;
    }

    .reason-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px var(--primary-bg);
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .cancel-section {
      background-color: var(--gray-light);
      padding: 1.5rem;
      border-radius: 8px;
      margin-top: 2rem;
    }

    .cancel-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 1rem;
    }

    .cancel-info {
      font-size: 0.813rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      line-height: 1.6;
    }

    .stats-section {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .stats-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 1.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1.5rem;
    }

    .stat-card {
      text-align: center;
      padding: 1.5rem;
      background-color: var(--gray-light);
      border-radius: 8px;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
    .tabs-container {
      background-color: white;
      border-radius: 12px;
      padding: 0;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .tabs-header {
      display: flex;
      border-bottom: 2px solid var(--border-color);
    }

    .tab-btn {
      flex: 1;
      padding: 1rem 1.5rem;
      background-color: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      position: relative;
      margin-bottom: -2px;
    }

    .tab-btn:hover {
      background-color: var(--gray-light);
    }

    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      background-color: transparent;
    }

    .tab-content {
      display: none;
      padding: 2rem;
    }

    .tab-content.active {
      display: block;
    }

    /* å‚åŠ è€…ä¸€è¦§ã‚¹ã‚¿ã‚¤ãƒ« */
    .participants-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .participants-stat-card {
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
    }

    .participants-stat-card.attend {
      background-color: var(--success-bg);
    }

    .participants-stat-card.absent {
      background-color: var(--danger-bg);
    }

    .participants-stat-card.official-absence {
      background-color: #fff4e6;
    }

    .participants-stat-card.pending {
      background-color: var(--warning-bg);
    }

    .participants-stat-number {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .participants-stat-card.attend .participants-stat-number {
      color: var(--success-color);
    }

    .participants-stat-card.absent .participants-stat-number {
      color: var(--danger-color);
    }

    .participants-stat-card.official-absence .participants-stat-number {
      color: #f59e0b;
    }

    .participants-stat-card.pending .participants-stat-number {
      color: var(--warning-color);
    }

    .participants-stat-label {
      font-size: 0.813rem;
      font-weight: 600;
    }

    .participants-list {
      display: grid;
      gap: 0.75rem;
    }

    .participant-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background-color: var(--gray-light);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .participant-item:hover {
      background-color: #e8eaed;
    }

    .participant-icon {
      font-size: 1.5rem;
      min-width: 1.5rem;
    }

    .participant-info {
      flex: 1;
      min-width: 0;
    }

    .participant-name {
      font-size: 0.938rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.25rem;
    }

    .participant-affiliation {
      font-size: 0.813rem;
      color: var(--text-secondary);
    }

    .participant-status {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-size: 0.813rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .participant-status.attend {
      background-color: var(--success-bg);
      color: var(--success-color);
    }

    .participant-status.absent {
      background-color: var(--danger-bg);
      color: var(--danger-color);
    }

    .participant-status.official-absence {
      background-color: #fff4e6;
      color: #f59e0b;
    }

    .participant-status.pending {
      background-color: var(--warning-bg);
      color: var(--warning-color);
    }

    @media (max-width: 768px) {
      .event-detail-card,
      .attendance-section,
      .stats-section {
        padding: 1.5rem;
      }

      .event-title {
        font-size: 1.5rem;
      }

      .event-title-row {
        flex-direction: column;
      }

      .event-info-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .attendance-buttons {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .action-buttons .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-container">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="header-top">
        <h1 class="header-title">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="header-user">
          <span id="userName" class="header-user-name"></span>
          <button id="mobileNavToggle" class="mobile-nav-toggle">â˜°</button>
          <button id="logoutBtn" class="btn btn-secondary btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>

      <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <nav class="nav">
        <div class="nav-container">
          <a href="home.html" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">HOME</span>
          </a>
          <a href="events.html" class="nav-item active">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-text">ã‚¤ãƒ™ãƒ³ãƒˆ</span>
          </a>
          <a href="members.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¥</span>
            <span class="nav-text">ãƒ¡ãƒ³ãƒãƒ¼</span>
          </a>
          <a href="history.html" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å±¥æ­´</span>
          </a>
          <a href="receipts.html" class="nav-item">
            <span class="nav-icon">ğŸ§¾</span>
            <span class="nav-text">é ˜åæ›¸</span>
          </a>
          <a href="profile.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¤</span>
            <span class="nav-text">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
          </a>
          <!-- ç®¡ç†è€…ç”¨ãƒªãƒ³ã‚¯ -->
          <a href="admin/dashboard.html" id="adminLink" class="nav-item" style="display: none;">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">ç®¡ç†ç”»é¢</span>
          </a>
        </div>
      </nav>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-content">
    <div class="container">
      <a href="events.html" class="back-link">
        â† ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã«æˆ»ã‚‹
      </a>

      <!-- ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´° -->
      <div id="eventDetail" class="event-detail-card">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>

      <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒŠ -->
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-btn active" onclick="switchTab('attendance')">å‡ºæ¬ ç™»éŒ²</button>
          <button class="tab-btn" onclick="switchTab('participants')">å‚åŠ è€…ä¸€è¦§</button>
        </div>

        <!-- å‡ºæ¬ ç™»éŒ²ã‚¿ãƒ– -->
        <div id="attendanceTab" class="tab-content active">
          <!-- å‡ºæ¬ ç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div id="attendanceSection">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>

        <!-- å‚åŠ è€…ä¸€è¦§ã‚¿ãƒ– -->
        <div id="participantsTab" class="tab-content">
          <div id="participantsSection">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/nav.js"></script>

  <script>
    let eventData = null;
    let selectedAttendance = null;
    let participantsData = null;
    let participantsLoaded = false;
    const userInfo = Auth.getUserInfo();
    const eventId = Utils.getUrlParam('id');

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
      Auth.requireLogin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ã‚¤ãƒ™ãƒ³ãƒˆIDç¢ºèª
      if (!eventId) {
        Utils.showError('ã‚¤ãƒ™ãƒ³ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        window.location.href = 'events.html';
        return;
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°å–å¾—
      await loadEventDetail();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ç™ºç”Ÿæ—¥ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatCancellationFeeDate(cancellationFeeDate, eventDate) {
      if (!cancellationFeeDate) return '';

      const feeDate = new Date(cancellationFeeDate);
      const evDate = new Date(eventDate);

      // ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ã¨ã®å·®ã‚’è¨ˆç®—
      const diffTime = evDate - feeDate;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      // æ—¥ä»˜è¡¨ç¤º
      const month = feeDate.getMonth() + 1;
      const day = feeDate.getDate();
      const dateStr = `${month}æœˆ${day}æ—¥`;

      if (diffDays > 0) {
        return `${dateStr}ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆ${diffDays}æ—¥å‰ï¼‰`;
      } else if (diffDays === 0) {
        return `${dateStr}ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå½“æ—¥ï¼‰`;
      } else {
        return dateStr;
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°å–å¾—
    async function loadEventDetail() {
      Utils.showLoading();

      try {
        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã®ã¿ã‚’å–å¾—ï¼ˆå‚åŠ è€…ä¸€è¦§ã¯é…å»¶èª­ã¿è¾¼ã¿ï¼‰
        const eventResult = await API.call('getEventDetail', {
          event_id: eventId,
          member_id: userInfo.memberId
        });

        if (eventResult.success && eventResult.event) {
          eventData = eventResult.event;
          displayEventDetail();
          displayAttendanceSection();
        } else {
          throw new Error(eventResult.message || 'ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load event detail error:', error);
        Utils.showError('ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setTimeout(() => {
          window.location.href = 'events.html';
        }, 2000);
      } finally {
        Utils.hideLoading();
      }
    }

    // å‚åŠ è€…ä¸€è¦§ã‚’å–å¾—
    async function loadParticipants() {
      if (participantsLoaded) {
        // æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆã¯å†è¡¨ç¤ºã®ã¿
        displayParticipants(participantsData);
        return;
      }

      Utils.showLoading();

      try {
        const participantsResult = await API.call('getEventAttendance', {
          event_id: eventId
        });

        if (participantsResult.success) {
          participantsData = participantsResult.attendance;
          participantsLoaded = true;
          displayParticipants(participantsData);
        } else {
          throw new Error(participantsResult.message || 'å‚åŠ è€…ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load participants error:', error);
        Utils.showError('å‚åŠ è€…ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰ active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
      if (tabName === 'attendance') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('attendanceTab').classList.add('active');
      } else if (tabName === 'participants') {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('participantsTab').classList.add('active');
        // å‚åŠ è€…ä¸€è¦§ã‚¿ãƒ–ã‚’é–‹ã„ãŸã¨ãã«åˆã‚ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        loadParticipants();
      }
    }
    window.switchTab = switchTab;

    // å‚åŠ è€…ä¸€è¦§ã‚’è¡¨ç¤º
    function displayParticipants(attendanceList) {
      const container = document.getElementById('participantsSection');

      if (!attendanceList || attendanceList.length === 0) {
        container.innerHTML = `
          <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
            å‚åŠ è€…æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“
          </p>
        `;
        return;
      }

      // ã‚¿ã‚¤ãƒ—Bã‚¤ãƒ™ãƒ³ãƒˆã®åˆ¤å®š
      const isTypeB = eventData.attendance_type === 'B';

      // çµ±è¨ˆè¨ˆç®—
      let attendCount, officialAbsenceCount, absentCount, pendingCount;

      if (isTypeB) {
        // ã‚¿ã‚¤ãƒ—B: æ¬ å¸­ã‚’æ¬ å¸­ã€ãã‚Œä»¥å¤–ï¼ˆstatusãŒã‚ã‚‹ã‚‚ã®ï¼‰ã‚’å‡ºå¸­ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
        absentCount = attendanceList.filter(a => a.status === 'æ¬ å¸­').length;
        attendCount = attendanceList.filter(a => a.status && a.status !== 'æ¬ å¸­').length;
        officialAbsenceCount = 0; // ã‚¿ã‚¤ãƒ—Bã«ã¯å…¬æ¬ ãªã—
      } else {
        // ã‚¿ã‚¤ãƒ—A: å‡ºå¸­/å…¬æ¬ /æ¬ å¸­ã‚’å€‹åˆ¥ã«ã‚«ã‚¦ãƒ³ãƒˆ
        attendCount = attendanceList.filter(a => a.status === 'å‚åŠ ' || a.status === 'å‡ºå¸­').length;
        officialAbsenceCount = attendanceList.filter(a => a.status === 'å…¬æ¬ ').length;
        absentCount = attendanceList.filter(a => a.status === 'ä¸å‚åŠ ' || a.status === 'æ¬ å¸­').length;
      }

      pendingCount = attendanceList.filter(a => !a.status).length;

      // çµ±è¨ˆã‚«ãƒ¼ãƒ‰
      let statsHtml = '<div class="participants-stats">';
      statsHtml += `
        <div class="participants-stat-card attend">
          <div class="participants-stat-number">${attendCount}</div>
          <div class="participants-stat-label">å‡ºå¸­</div>
        </div>
      `;

      if (!isTypeB && officialAbsenceCount > 0) {
        statsHtml += `
          <div class="participants-stat-card official-absence">
            <div class="participants-stat-number">${officialAbsenceCount}</div>
            <div class="participants-stat-label">å…¬æ¬ </div>
          </div>
        `;
      }

      statsHtml += `
        <div class="participants-stat-card absent">
          <div class="participants-stat-number">${absentCount}</div>
          <div class="participants-stat-label">æ¬ å¸­</div>
        </div>
        <div class="participants-stat-card pending">
          <div class="participants-stat-number">${pendingCount}</div>
          <div class="participants-stat-label">æœªç™»éŒ²</div>
        </div>
      `;
      statsHtml += '</div>';

      // å‚åŠ è€…ãƒªã‚¹ãƒˆ
      let listHtml = '<div class="participants-list">';

      attendanceList.forEach(item => {
        let statusClass = 'pending';
        let statusIcon = 'â“';
        let statusText = 'æœªç™»éŒ²';

        if (item.status) {
          if (isTypeB) {
            // ã‚¿ã‚¤ãƒ—B: selected_optionã‚’è¡¨ç¤º
            statusText = item.selected_option || item.status;
            if (item.status === 'æ¬ å¸­') {
              statusClass = 'absent';
              statusIcon = 'âŒ';
            } else {
              statusClass = 'attend';
              statusIcon = 'âœ…';
            }
          } else {
            // ã‚¿ã‚¤ãƒ—A: é€šå¸¸ã®å‡ºå¸­/æ¬ å¸­/å…¬æ¬ 
            if (item.status === 'å‚åŠ ' || item.status === 'å‡ºå¸­') {
              statusClass = 'attend';
              statusIcon = 'âœ…';
              statusText = 'å‡ºå¸­';
            } else if (item.status === 'å…¬æ¬ ') {
              statusClass = 'official-absence';
              statusIcon = 'âšª';
              statusText = 'å…¬æ¬ ';
            } else if (item.status === 'ä¸å‚åŠ ' || item.status === 'æ¬ å¸­') {
              statusClass = 'absent';
              statusIcon = 'âŒ';
              statusText = 'æ¬ å¸­';
            }
          }
        }

        // æ‰€å±ã‚«ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
        const itemStyle = item.affiliation_color
          ? `style="background: linear-gradient(to right, ${item.affiliation_color}15, ${item.affiliation_color}08); border-left: 3px solid ${item.affiliation_color};"`
          : '';

        listHtml += `
          <div class="participant-item" ${itemStyle}>
            <div class="participant-icon">${statusIcon}</div>
            <div class="participant-info">
              <div class="participant-name">${Utils.escapeHtml(item.member_name)}</div>
              ${item.affiliation ? `<div class="participant-affiliation" ${item.affiliation_color ? `style="color: ${item.affiliation_color}; font-weight: 600;"` : ''}>${Utils.escapeHtml(item.affiliation)}</div>` : ''}
            </div>
            <div class="participant-status ${statusClass}">
              ${Utils.escapeHtml(statusText)}
            </div>
          </div>
        `;
      });

      listHtml += '</div>';

      container.innerHTML = statsHtml + listHtml;
    }

    // ä»»æ„é …ç›®è¡¨ç¤º
    function renderOptionalFields(event, displayFields) {
      let html = '';

      // ç™»éŒ²æ–™ï¼ˆdisplay_fieldsã§fee_amountãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
      if (displayFields.fee_amount !== false && event.fee_amount > 0) {
        const fee = Utils.formatCurrency(event.fee_amount);
        html += `
          <div class="event-info-grid">
            <div class="event-info-item">
              <div class="event-info-icon">ğŸ’°</div>
              <div class="event-info-content">
                <div class="event-info-label">ç™»éŒ²æ–™</div>
                <div class="event-info-value">${fee}</div>
              </div>
            </div>
          </div>
        `;
      }

      // åœ°å›³URL
      if (displayFields.map_url !== false && event.map_url) {
        // map_urlãŒhttpã§å§‹ã¾ã‚‹å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨ã€ãã‚Œä»¥å¤–ã¯ä½æ‰€ã¨ã—ã¦Google Mapsã®æ¤œç´¢URLã‚’ç”Ÿæˆ
        const mapUrl = event.map_url.startsWith('http')
          ? event.map_url
          : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.map_url)}`;

        html += `
          <div class="event-info-grid">
            <div class="event-info-item">
              <div class="event-info-icon">ğŸ—ºï¸</div>
              <div class="event-info-content">
                <div class="event-info-label">åœ°å›³</div>
                <div class="event-info-value"><a href="${Utils.escapeHtml(mapUrl)}" target="_blank" style="color: var(--primary-color); text-decoration: underline;">åœ°å›³ã‚’é–‹ã</a></div>
              </div>
            </div>
          </div>
        `;
      }

      // ä¸»å‚¬è€…
      if (displayFields.host !== false && event.host) {
        html += `
          <div class="event-info-grid">
            <div class="event-info-item">
              <div class="event-info-icon">ğŸ‘¤</div>
              <div class="event-info-content">
                <div class="event-info-label">ä¸»å‚¬è€…</div>
                <div class="event-info-value">${Utils.escapeHtml(event.host)}</div>
              </div>
            </div>
          </div>
        `;
      }

      // æ”¯æ‰•ã„æ–¹æ³•
      if (displayFields.payment_methods !== false && event.payment_methods) {
        html += `
          <div class="event-info-grid">
            <div class="event-info-item">
              <div class="event-info-icon">ğŸ’³</div>
              <div class="event-info-content">
                <div class="event-info-label">æ”¯æ‰•ã„æ–¹æ³•</div>
                <div class="event-info-value">${Utils.escapeHtml(event.payment_methods)}</div>
              </div>
            </div>
          </div>
        `;
      }

      // æœè£…
      if (displayFields.dress_code !== false && event.dress_code) {
        html += `
          <div class="event-info-grid">
            <div class="event-info-item">
              <div class="event-info-icon">ğŸ‘”</div>
              <div class="event-info-content">
                <div class="event-info-label">æœè£…</div>
                <div class="event-info-value">${Utils.escapeHtml(event.dress_code)}</div>
                ${event.dress_code_note ? `<div class="event-info-value" style="font-size: 0.875rem; color: var(--text-secondary);">${Utils.escapeHtml(event.dress_code_note)}</div>` : ''}
              </div>
            </div>
          </div>
        `;
      }

      // å‚™è€ƒ
      if (displayFields.notes !== false && event.notes) {
        html += `
          <div class="event-description">
            <div class="event-description-title">å‚™è€ƒ</div>
            <div class="event-description-text">${Utils.escapeHtml(event.notes)}</div>
          </div>
        `;
      }

      return html;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°è¡¨ç¤º
    function displayEventDetail() {
      const container = document.getElementById('eventDetail');
      const event = eventData;

      const dateStr = Utils.formatDateSlash(event.date);
      const dayOfWeek = Utils.getDayOfWeek(event.date);
      const startTime = Utils.formatTime(event.start_time);
      const endTime = Utils.formatTime(event.end_time);
      const fee = event.fee_amount > 0 ? Utils.formatCurrency(event.fee_amount) : 'ç„¡æ–™';

      // ãƒãƒƒã‚¸
      let badges = '';
      if (event.urgent) {
        badges += '<span class="badge badge-danger">ç·Šæ€¥</span>';
      }

      const now = new Date();
      const eventDate = new Date(event.date);
      const isPast = eventDate < now;

      if (isPast) {
        badges += '<span class="badge badge-secondary">çµ‚äº†</span>';
      }

      // display_fieldsã®å–å¾—
      const displayFields = typeof event.display_fields === 'string'
        ? JSON.parse(event.display_fields)
        : (event.display_fields || {});

      container.innerHTML = `
        <div class="event-header">
          <div class="event-title-row">
            <h2 class="event-title">${Utils.escapeHtml(event.title)}</h2>
            <div class="event-badges">${badges}</div>
          </div>
        </div>

        <div class="event-info-grid">
          <!-- é–‹å‚¬æ—¥ -->
          <div class="event-info-item">
            <div class="event-info-icon">ğŸ“…</div>
            <div class="event-info-content">
              <div class="event-info-label">é–‹å‚¬æ—¥</div>
              <div class="event-info-value">${dateStr}ï¼ˆ${dayOfWeek}ï¼‰</div>
              ${displayFields.time !== false && (event.start_time || event.end_time) ? `
                <div class="event-info-value">${startTime} - ${endTime}</div>
              ` : ''}
            </div>
          </div>

          <!-- é–‹å‚¬å ´æ‰€ -->
          ${displayFields.location !== false && event.location ? `
            <div class="event-info-item">
              <div class="event-info-icon">ğŸ“</div>
              <div class="event-info-content">
                <div class="event-info-label">å ´æ‰€</div>
                <div class="event-info-value">${Utils.escapeHtml(event.location)}</div>
              </div>
            </div>
          ` : ''}

          <!-- å‡ºæ¬ ç· åˆ‡ -->
          ${event.attendance_deadline ? `
            <div class="event-info-item">
              <div class="event-info-icon">â°</div>
              <div class="event-info-content">
                <div class="event-info-label">å‡ºæ¬ ç· åˆ‡</div>
                <div class="event-info-value">${Utils.formatDateSlash(event.attendance_deadline)}</div>
              </div>
            </div>
          ` : ''}

          <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ç™ºç”Ÿæ—¥ -->
          ${event.cancellation_fee_date ? `
            <div class="event-info-item">
              <div class="event-info-icon">ğŸ’³</div>
              <div class="event-info-content">
                <div class="event-info-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ç™ºç”Ÿæ—¥</div>
                <div class="event-info-value">${formatCancellationFeeDate(event.cancellation_fee_date, event.date)}</div>
              </div>
            </div>
          ` : ''}
        </div>

        <!-- èª¬æ˜æ–‡ -->
        ${displayFields.description !== false && event.description ? `
          <div class="event-description">
            <div class="event-description-title">è©³ç´°</div>
            <div class="event-description-text">${Utils.escapeHtml(event.description)}</div>
          </div>
        ` : ''}

        <!-- ä»»æ„é …ç›®ï¼ˆdisplay_fieldsã§é¸æŠã•ã‚ŒãŸã‚‚ã®ï¼‰ -->
        ${renderOptionalFields(event, displayFields)}
      `;
    }

    // å‡ºæ¬ ãƒœã‚¿ãƒ³ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ—A/Bå¯¾å¿œï¼‰
    function renderAttendanceButtons(event, currentStatus, isPast) {
      // ã‚¿ã‚¤ãƒ—A: ã‚·ãƒ³ãƒ—ãƒ«ãªå‡ºæ¬ 
      if (!event.attendance_type || event.attendance_type === 'A') {
        return `
          <div class="attendance-buttons">
            <button class="attendance-btn ${currentStatus === 'å‡ºå¸­' ? 'selected' : ''}"
                    onclick="selectAttendance('å‡ºå¸­')"
                    ${isPast ? 'disabled' : ''}>
              <div class="attendance-btn-icon">âœ“</div>
              <div class="attendance-btn-content">
                <div class="attendance-btn-label">å‡ºå¸­</div>
                <div class="attendance-btn-desc">ã‚¤ãƒ™ãƒ³ãƒˆã«å‚åŠ ã—ã¾ã™</div>
              </div>
            </button>

            <button class="attendance-btn ${currentStatus === 'å…¬æ¬ ' ? 'selected' : ''}"
                    onclick="selectAttendance('å…¬æ¬ ')"
                    ${isPast ? 'disabled' : ''}>
              <div class="attendance-btn-icon">ğŸ“‹</div>
              <div class="attendance-btn-content">
                <div class="attendance-btn-label">å…¬æ¬ </div>
                <div class="attendance-btn-desc">å…¬å‹™ã«ã‚ˆã‚‹æ¬ å¸­</div>
              </div>
            </button>

            <button class="attendance-btn ${currentStatus === 'æ¬ å¸­' ? 'selected' : ''}"
                    onclick="selectAttendance('æ¬ å¸­')"
                    ${isPast ? 'disabled' : ''}>
              <div class="attendance-btn-icon">âœ—</div>
              <div class="attendance-btn-content">
                <div class="attendance-btn-label">æ¬ å¸­</div>
                <div class="attendance-btn-desc">å‚åŠ ã§ãã¾ã›ã‚“</div>
              </div>
            </button>
          </div>
        `;
      }

      // ã‚¿ã‚¤ãƒ—B: å‚åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const participationOptions = typeof event.participation_options === 'string'
        ? JSON.parse(event.participation_options)
        : (event.participation_options || []);

      let buttonsHTML = '<div class="attendance-buttons">';
      participationOptions.forEach((option, index) => {
        const amountText = option.amount > 0
          ? `${option.amount.toLocaleString()}å††`
          : 'ç„¡æ–™';
        const isSelected = currentStatus === option.label;

        buttonsHTML += `
          <button class="attendance-btn ${isSelected ? 'selected' : ''}"
                  onclick="selectAttendance('${Utils.escapeHtml(option.label)}')"
                  ${isPast ? 'disabled' : ''}>
            <div class="attendance-btn-icon">${option.amount > 0 ? 'ğŸ’°' : 'âœ“'}</div>
            <div class="attendance-btn-content">
              <div class="attendance-btn-label">${Utils.escapeHtml(option.label)}</div>
              <div class="attendance-btn-desc">${amountText}</div>
            </div>
          </button>
        `;
      });
      buttonsHTML += '</div>';
      return buttonsHTML;
    }

    // å‡ºæ¬ ç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
    function displayAttendanceSection() {
      const container = document.getElementById('attendanceSection');
      const event = eventData;
      const now = new Date();

      // ç¾åœ¨ã®å‡ºæ¬ çŠ¶æ³
      const currentStatus = event.my_attendance_status;
      selectedAttendance = currentStatus;

      let statusHTML = '';
      let statusClass = 'pending';

      // ã‚¿ã‚¤ãƒ—Bã®å ´åˆã€é¸æŠã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      if (event.attendance_type === 'B' && currentStatus) {
        if (currentStatus === 'æ¬ å¸­') {
          statusHTML = 'âœ— æ¬ å¸­';
          statusClass = 'absent';
        } else {
          statusHTML = `âœ“ ${currentStatus}`;
          statusClass = 'attend';
        }
      } else if (currentStatus === 'å‡ºå¸­') {
        statusHTML = 'âœ“ å‡ºå¸­äºˆå®š';
        statusClass = 'attend';
      } else if (currentStatus === 'å…¬æ¬ ') {
        statusHTML = 'ğŸ“‹ å…¬æ¬ ';
        statusClass = 'official-absence';
      } else if (currentStatus === 'æ¬ å¸­') {
        statusHTML = 'âœ— æ¬ å¸­';
        statusClass = 'absent';
      } else {
        statusHTML = 'æœªç™»éŒ²';
        statusClass = 'pending';
      }

      // ç· åˆ‡ãƒã‚§ãƒƒã‚¯
      let deadlineNotice = '';
      let isExpired = false;

      if (event.attendance_deadline) {
        const deadline = new Date(event.attendance_deadline);
        const daysUntil = Utils.getDaysUntil(event.attendance_deadline);

        if (now > deadline) {
          deadlineNotice = `
            <div class="deadline-notice expired">
              <span>â°</span>
              <span>ç™»éŒ²ç· åˆ‡ã‚’éãã¦ã„ã¾ã™ï¼ˆ${Utils.formatDateSlash(event.attendance_deadline)}ï¼‰</span>
            </div>
          `;
          isExpired = true;
        } else if (daysUntil <= 1) {
          deadlineNotice = `
            <div class="deadline-notice">
              <span>âš ï¸</span>
              <span>ç· åˆ‡ã¾ã§ã‚ã¨${daysUntil === 0 ? 'ä»Šæ—¥' : '1æ—¥'}ã§ã™ï¼ï¼ˆ${Utils.formatDateSlash(event.attendance_deadline)}ï¼‰</span>
            </div>
          `;
        } else if (daysUntil <= 3) {
          deadlineNotice = `
            <div class="deadline-notice warning">
              <span>â°</span>
              <span>ç· åˆ‡ã¾ã§ã‚ã¨${daysUntil}æ—¥ã§ã™ï¼ˆ${Utils.formatDateSlash(event.attendance_deadline)}ï¼‰</span>
            </div>
          `;
        }
      }

      // éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ãƒã‚§ãƒƒã‚¯
      const eventDate = new Date(event.date);
      const isPast = eventDate < now;

      container.innerHTML = `
        <div class="attendance-header">
          <h3 class="attendance-title">å‡ºæ¬ ç™»éŒ²</h3>
          <div class="current-status ${statusClass}">${statusHTML}</div>
        </div>

        ${deadlineNotice}

        ${isPast ? `
          <div class="deadline-notice expired">
            <span>ğŸ“…</span>
            <span>ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯çµ‚äº†ã—ã¾ã—ãŸ</span>
          </div>
        ` : !isExpired ? `
          ${renderAttendanceButtons(event, currentStatus, isPast)}

          <div class="reason-section" id="reasonSection" style="display: none;">
            <label class="reason-label">ç†ç”±ãƒ»å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
            <textarea
              id="reasonInput"
              class="reason-textarea"
              placeholder="æ¬ å¸­ç†ç”±ã‚„å‚™è€ƒãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„..."
            >${event.my_reason || ''}</textarea>
          </div>

          <div class="action-buttons">
            <button id="submitBtn" class="btn btn-primary btn-lg" disabled>
              ${currentStatus ? 'å‡ºæ¬ ã‚’å¤‰æ›´' : 'å‡ºæ¬ ã‚’ç™»éŒ²'}
            </button>
            ${currentStatus ? `
              <button id="cancelBtn" class="btn btn-outline btn-lg">
                ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
            ` : ''}
          </div>

          ${currentStatus === 'å‡ºå¸­' ? `
            <div class="cancel-section">
              <div class="cancel-title">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼</div>
              <div class="cancel-info">
                ${event.cancellation_fee_date && event.fee_amount > 0 ? `
                  <p>â€¢ ${formatCancellationFeeDate(event.cancellation_fee_date, event.date)}ä»¥é™ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼šç™»éŒ²æ–™ã®100%</p>
                  <p>â€¢ ${formatCancellationFeeDate(event.cancellation_fee_date, event.date)}ã‚ˆã‚Šå‰ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ãªã—</p>
                ` : event.fee_amount > 0 ? `
                  <p>ç™»éŒ²æ–™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚</p>
                ` : `
                  <p>ç™»éŒ²æ–™ç„¡æ–™ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ãŸã‚ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã¯ã‹ã‹ã‚Šã¾ã›ã‚“ã€‚</p>
                `}
              </div>
            </div>
          ` : ''}
        ` : ''}
      `;

      // ç†ç”±å…¥åŠ›æ¬„ã®è¡¨ç¤ºåˆ¶å¾¡
      if (currentStatus === 'æ¬ å¸­') {
        const reasonSection = document.getElementById('reasonSection');
        if (reasonSection) {
          reasonSection.style.display = 'block';
        }
      }
    }

    // å‡ºæ¬ é¸æŠ
    function selectAttendance(status) {
      selectedAttendance = status;

      // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
      document.querySelectorAll('.attendance-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');

      // ç†ç”±å…¥åŠ›æ¬„ã®è¡¨ç¤ºåˆ¶å¾¡
      const reasonSection = document.getElementById('reasonSection');
      if (status === 'æ¬ å¸­') {
        reasonSection.style.display = 'block';
      } else {
        reasonSection.style.display = 'none';
      }

      // ç™»éŒ²ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = false;
    }
    window.selectAttendance = selectAttendance;

    // å‡ºæ¬ ç™»éŒ²
    async function submitAttendance() {
      if (!selectedAttendance) {
        Utils.showError('å‡ºæ¬ ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const reason = document.getElementById('reasonInput')?.value || '';

      // ç¢ºèª
      const confirmMessage = eventData.my_attendance_status
        ? `å‡ºæ¬ ã‚’ã€Œ${selectedAttendance}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`
        : `ã€Œ${selectedAttendance}ã€ã§ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`;

      if (!confirm(confirmMessage)) {
        return;
      }

      Utils.showLoading();

      try {
        const requestData = {
          event_id: eventId,
          member_id: userInfo.memberId,
          status: selectedAttendance,
          memo: reason
        };

        // ã‚¿ã‚¤ãƒ—Bã®å ´åˆã€selected_optionã‚’é€ä¿¡
        if (eventData.attendance_type === 'B') {
          requestData.selected_option = selectedAttendance;
        }

        const result = await API.call('registerAttendance', requestData);

        if (result.success) {
          Utils.showSuccess('å‡ºæ¬ ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
          // ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
          participantsLoaded = false; // å‚åŠ è€…ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ãŸã‚ã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
          await loadEventDetail();
        } else {
          throw new Error(result.message || 'å‡ºæ¬ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Submit attendance error:', error);
        Utils.showError(error.message || 'å‡ºæ¬ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // å‡ºæ¬ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    async function cancelAttendance() {
      if (!confirm('å‡ºæ¬ ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('cancelAttendance', {
          event_id: eventId,
          member_id: userInfo.memberId
        });

        if (result.success) {
          Utils.showSuccess('å‡ºæ¬ ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
          // ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
          participantsLoaded = false; // å‚åŠ è€…ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ãŸã‚ã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
          await loadEventDetail();
        } else {
          throw new Error(result.message || 'å‡ºæ¬ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Cancel attendance error:', error);
        Utils.showError(error.message || 'å‡ºæ¬ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // å‡ºæ¬ ç™»éŒ²ãƒœã‚¿ãƒ³ï¼ˆå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã‚’ä½¿ç”¨ï¼‰
      document.addEventListener('click', (e) => {
        if (e.target.id === 'submitBtn' || e.target.closest('#submitBtn')) {
          submitAttendance();
        }
        if (e.target.id === 'cancelBtn' || e.target.closest('#cancelBtn')) {
          cancelAttendance();
        }
      });
    }
  </script>
</body>
</html>
