<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>æ”¯æ‰•ã„ç®¡ç† - ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/admin.css">
  <style>
    .filter-section {
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      align-items: end;
    }

    .data-section {
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .data-table th,
    .data-table td {
      padding: 1rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: var(--text-color);
      white-space: nowrap;
    }

    .data-table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .status-badge {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-align: center;
    }

    .status-badge.unpaid {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-badge.paid {
      background-color: #d4edda;
      color: #155724;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .empty-state-text {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }

    .empty-state-subtext {
      font-size: 0.875rem;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--primary-color);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="admin-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h1 class="admin-sidebar-title">ç®¡ç†è€…ç”»é¢</h1>
        <p class="admin-sidebar-subtitle">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <nav class="admin-sidebar-nav">
        <a href="dashboard.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“Š</span>
          <span class="admin-sidebar-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
        <a href="events.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“…</span>
          <span class="admin-sidebar-text">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</span>
        </a>
        <a href="members.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ‘¥</span>
          <span class="admin-sidebar-text">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
        </a>
        <a href="analytics.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“ˆ</span>
          <span class="admin-sidebar-text">å‡ºå¸­ç‡åˆ†æ</span>
        </a>
        <a href="payments.html" class="admin-sidebar-item active">
          <span class="admin-sidebar-icon">ğŸ’°</span>
          <span class="admin-sidebar-text">æ”¯æ‰•ã„ç®¡ç†</span>
        </a>
        <a href="checkin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“±</span>
          <span class="admin-sidebar-text">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
        </a>
        <a href="receipts-admin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ§¾</span>
          <span class="admin-sidebar-text">é ˜åæ›¸ç®¡ç†</span>
        </a>

        <div class="admin-sidebar-divider"></div>

        <a href="../home.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ </span>
          <span class="admin-sidebar-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸</span>
        </a>
      </nav>

      <div class="admin-sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block" style="color: white; border-color: rgba(255,255,255,0.3);">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-main">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="admin-topbar">
        <button class="admin-mobile-toggle" id="mobileToggle">
          â˜°
        </button>
        <h2 class="admin-topbar-title">æ”¯æ‰•ã„ç®¡ç†</h2>
        <div class="admin-topbar-actions">
          <div class="admin-user-info">
            <span class="admin-user-icon">ğŸ‘¤</span>
            <div class="admin-user-details">
              <span class="admin-user-name" id="userName">ç®¡ç†è€…</span>
              <span class="admin-user-role">ç®¡ç†è€…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="admin-content">
        <!-- ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ -->
        <div class="filter-section">
          <div class="filter-row">
            <div class="form-group">
              <label for="monthSelect" class="form-label required">å¹´æœˆã‚’é¸æŠ</label>
              <select id="monthSelect" class="form-input" required>
                <option value="">å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>
            <div class="form-group">
              <label for="eventSelect" class="form-label required">ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ</label>
              <select id="eventSelect" class="form-input" required disabled>
                <option value="">ã¾ãšå¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>
            <div class="form-group">
              <label for="memberSearch" class="form-label">ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢</label>
              <input type="text" id="memberSearch" class="form-input" placeholder="åå‰ã§æ¤œç´¢...">
            </div>
            <div class="form-group">
              <label for="statusFilter" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <select id="statusFilter" class="form-input">
                <option value="">ã™ã¹ã¦</option>
                <option value="unpaid">æœªæ‰•ã„</option>
                <option value="paid">æ”¯æ‰•ã„æ¸ˆã¿</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="data-section">
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ãƒ¡ãƒ³ãƒãƒ¼å</th>
                  <th>æ‰€å±</th>
                  <th>å‡ºæ¬ ç™»éŒ²</th>
                  <th>å®Ÿå‡ºå¸­</th>
                  <th>é‡‘é¡</th>
                  <th>ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™</th>
                  <th>æ”¯æ‰•ã„æ–¹æ³•</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th>æ”¯æ‰•ã„æ—¥æ™‚</th>
                  <th>å‚™è€ƒ</th>
                  <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                </tr>
              </thead>
              <tbody id="paymentsTableBody">
                <tr>
                  <td colspan="11">
                    <div class="empty-state">
                      <div class="empty-state-icon">ğŸ’°</div>
                      <div class="empty-state-text">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                      <div class="empty-state-subtext">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨æ”¯æ‰•ã„æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- æ”¯æ‰•ã„æ–¹æ³•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="paymentMethodModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>æ”¯æ‰•ã„æ–¹æ³•ã‚’ç·¨é›†</h3>
      <div class="form-group">
        <label>ãƒ¡ãƒ³ãƒãƒ¼å</label>
        <input type="text" id="modalMemberName" readonly style="background-color: #f5f5f5;">
      </div>
      <div class="form-group">
        <label>é‡‘é¡</label>
        <input type="text" id="modalAmount" readonly style="background-color: #f5f5f5;">
      </div>
      <div class="form-group">
        <label>æ”¯æ‰•ã„æ–¹æ³• <span style="color: red;">*</span></label>
        <select id="modalPaymentMethod" class="form-control">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="ç¾åœ°æ‰•ã„">ç¾åœ°æ‰•ã„</option>
          <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
          <option value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
          <option value="é›»å­ãƒãƒãƒ¼">é›»å­ãƒãƒãƒ¼</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      <div class="action-buttons" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-outline" onclick="closePaymentMethodModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="savePaymentMethod()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- å‚™è€ƒç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="notesModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>å‚™è€ƒã‚’ç·¨é›†</h3>
      <div class="form-group">
        <label>ãƒ¡ãƒ³ãƒãƒ¼å</label>
        <input type="text" id="notesModalMemberName" readonly style="background-color: #f5f5f5;">
      </div>
      <div class="form-group">
        <label>å‚™è€ƒ</label>
        <textarea id="notesModalText" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;" placeholder="ç›¸æ®ºã«ã‚ˆã‚Šå…é™¤ã€ãªã©"></textarea>
      </div>
      <div class="action-buttons" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-outline" onclick="closeNotesModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveNotes()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let allPayments = [];
    let allMembers = [];
    let allEvents = [];
    let currentEvent = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      Auth.requireAdmin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      const userInfo = Auth.getUserInfo();
      if (userInfo) {
        document.getElementById('userName').textContent = userInfo.name || 'ç®¡ç†è€…';
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã¨ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
      await loadEvents();
      await loadMembers();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
    async function loadEvents() {
      Utils.showLoading();

      try {
        const result = await API.call('getEvents', {});

        if (result.success && result.events) {
          // ç™»éŒ²æ–™ãŒã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆAã‚¿ã‚¤ãƒ—ã¾ãŸã¯Bã‚¿ã‚¤ãƒ—ï¼‰
          allEvents = result.events.filter(e => {
            // dateãŒå­˜åœ¨ã—ã€ã‹ã¤ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã«è©²å½“
            // 1. Aã‚¿ã‚¤ãƒ—: fee_amountãŒ0ã‚ˆã‚Šå¤§ãã„
            // 2. Bã‚¿ã‚¤ãƒ—: participation_optionsãŒå­˜åœ¨ã™ã‚‹
            if (!e.date) return false;

            const hasFeeAmount = e.fee_amount && e.fee_amount > 0;
            const hasParticipationOptions = e.participation_options &&
              (typeof e.participation_options === 'string' ? e.participation_options.length > 0 : true);

            return hasFeeAmount || hasParticipationOptions;
          });

          console.log('All events with fee:', allEvents); // ãƒ‡ãƒãƒƒã‚°ç”¨

          // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
          allEvents.sort((a, b) => {
            // æ—¥ä»˜æ–‡å­—åˆ—ã§ç›´æ¥æ¯”è¼ƒ
            const dateA = a.date || '';
            const dateB = b.date || '';
            return dateB.localeCompare(dateA);
          });

          // æœˆã‚»ãƒ¬ã‚¯ã‚¿ã‚’åˆæœŸåŒ–
          populateMonthSelector();
        }

      } catch (error) {
        console.error('Load events error:', error);
        Utils.showError('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // æœˆã‚»ãƒ¬ã‚¯ã‚¿ã‚’ç”Ÿæˆ
    function populateMonthSelector() {
      const monthSelect = document.getElementById('monthSelect');
      monthSelect.innerHTML = '<option value="">å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

      if (allEvents.length === 0) {
        console.warn('No events available for month selector');
        return;
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å¹´æœˆã‚’æŠ½å‡ºï¼ˆé‡è¤‡ãªã—ï¼‰
      const yearMonths = new Set();
      allEvents.forEach(event => {
        // event.dateã¯ "YYYY-MM-DD" å½¢å¼ã®æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
        const dateStr = event.date;
        console.log('Event date:', dateStr); // ãƒ‡ãƒãƒƒã‚°ç”¨

        // YYYY-MM-DDå½¢å¼ã‹ã‚‰å¹´æœˆã‚’æŠ½å‡º
        if (dateStr && typeof dateStr === 'string') {
          const yearMonth = dateStr.substring(0, 7); // "YYYY-MM"
          yearMonths.add(yearMonth);
        }
      });

      console.log('Available year-months:', Array.from(yearMonths)); // ãƒ‡ãƒãƒƒã‚°ç”¨

      // ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
      const sortedYearMonths = Array.from(yearMonths).sort().reverse();

      sortedYearMonths.forEach(yearMonth => {
        const [year, month] = yearMonth.split('-');
        const option = document.createElement('option');
        option.value = yearMonth;
        option.textContent = `${year}å¹´${parseInt(month)}æœˆ`;
        monthSelect.appendChild(option);
      });

      // ç¾åœ¨ã®æœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
      const now = new Date();
      const currentYearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      console.log('Current year-month:', currentYearMonth); // ãƒ‡ãƒãƒƒã‚°ç”¨

      if (sortedYearMonths.includes(currentYearMonth)) {
        monthSelect.value = currentYearMonth;
        filterEventsByMonth(currentYearMonth);
      } else if (sortedYearMonths.length > 0) {
        // ç¾åœ¨ã®æœˆãŒãªã„å ´åˆã¯ã€æœ€æ–°ã®æœˆã‚’é¸æŠ
        monthSelect.value = sortedYearMonths[0];
        filterEventsByMonth(sortedYearMonths[0]);
      }
    }

    // æœˆã§çµã‚Šè¾¼ã‚“ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ã‚’æ›´æ–°
    function filterEventsByMonth(yearMonth) {
      const eventSelect = document.getElementById('eventSelect');
      eventSelect.innerHTML = '<option value="">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

      if (!yearMonth) {
        eventSelect.disabled = true;
        eventSelect.innerHTML = '<option value="">ã¾ãšå¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        return;
      }

      console.log('Filtering events for year-month:', yearMonth); // ãƒ‡ãƒãƒƒã‚°ç”¨

      // é¸æŠã•ã‚ŒãŸæœˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const filteredEvents = allEvents.filter(event => {
        // event.dateã¯ "YYYY-MM-DD" å½¢å¼ã®æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
        const dateStr = event.date;
        if (dateStr && typeof dateStr === 'string') {
          const eventYearMonth = dateStr.substring(0, 7); // "YYYY-MM"
          return eventYearMonth === yearMonth;
        }
        return false;
      });

      console.log('Filtered events count:', filteredEvents.length); // ãƒ‡ãƒãƒƒã‚°ç”¨

      if (filteredEvents.length === 0) {
        eventSelect.disabled = true;
        eventSelect.innerHTML = '<option value="">ã“ã®æœˆã«ã¯ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
        return;
      }

      eventSelect.disabled = false;
      filteredEvents.forEach(event => {
        const option = document.createElement('option');
        option.value = event.event_id;
        option.textContent = `${event.title} (${event.date})`;
        eventSelect.appendChild(option);
      });
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
    async function loadMembers() {
      try {
        const result = await API.call('getMembers');

        if (result.success && result.members) {
          allMembers = result.members;
        }

      } catch (error) {
        console.error('Load members error:', error);
      }
    }

    // Bã‚¿ã‚¤ãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã®é‡‘é¡ã‚’å–å¾—ï¼ˆparticipation_optionsã‹ã‚‰ï¼‰
    function getAmountForTypeB(eventDetail, selectedOption) {
      // participation_optionsãŒãªã„ã€ã¾ãŸã¯selected_optionãŒãªã„å ´åˆã¯fee_amountã‚’è¿”ã™
      if (!eventDetail.participation_options || !selectedOption) {
        return eventDetail.fee_amount || 0;
      }

      try {
        // participation_optionsã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆæ–‡å­—åˆ—ã®å ´åˆï¼‰
        const options = typeof eventDetail.participation_options === 'string'
          ? JSON.parse(eventDetail.participation_options)
          : eventDetail.participation_options;

        // selected_optionã«ä¸€è‡´ã™ã‚‹optionã‚’æ¢ã™
        const matchedOption = options.find(opt => opt.label === selectedOption);

        if (matchedOption && matchedOption.amount !== undefined) {
          return matchedOption.amount;
        }

        // ä¸€è‡´ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯fee_amountã‚’è¿”ã™
        return eventDetail.fee_amount || 0;
      } catch (error) {
        console.error('Error parsing participation_options:', error);
        return eventDetail.fee_amount || 0;
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆåˆ¥æ”¯æ‰•ã„æƒ…å ±èª­ã¿è¾¼ã¿
    async function loadPayments(eventId) {
      if (!eventId) {
        renderEmptyState('ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨æ”¯æ‰•ã„æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™');
        return;
      }

      Utils.showLoading();

      try {
        // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆã¾ã å–å¾—ã—ã¦ã„ãªã„å ´åˆï¼‰
        if (allMembers.length === 0) {
          await loadMembers();
        }

        // å‡ºå¸­ç™»éŒ²æƒ…å ±ã‚’å–å¾—
        const attendanceResult = await API.call('getEventAttendance', {
          event_id: eventId
        });

        // æ”¯æ‰•ã„æƒ…å ±ã‚’å–å¾—
        const paymentResult = await API.call('getPaymentsByEvent', {
          event_id: eventId
        });

        // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
        const checkinResult = await API.call('getCheckinList', {
          event_id: eventId
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã‚’å–å¾—ï¼ˆç™»éŒ²æ–™ã®é‡‘é¡ã‚’å–å¾—ï¼‰
        const eventDetail = allEvents.find(e => e.event_id === eventId);
        const feeAmount = eventDetail ? eventDetail.fee_amount : 0;
        const isTypeB = eventDetail && eventDetail.attendance_type === 'B';

        if (attendanceResult.success && paymentResult.success && checkinResult.success) {
          const attendances = attendanceResult.attendance || [];
          const payments = paymentResult.payments || [];
          const checkins = checkinResult.checkins || [];

          // å‡ºå¸­ç™»éŒ²ã—ãŸãƒ¡ãƒ³ãƒãƒ¼IDã‚’å–å¾—
          const registeredMemberIds = attendances.map(a => a.member_id);

          // å…¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¡¨ç¤ºï¼ˆå‡ºå¸­ç™»éŒ²ã—ãŸäººã‚’å„ªå…ˆï¼‰
          allPayments = allMembers
            .filter(member => registeredMemberIds.includes(member.member_id))
            .map(member => {
              // è©²å½“ãƒ¡ãƒ³ãƒãƒ¼ã®å‡ºå¸­ç™»éŒ²æƒ…å ±ã‚’æ¢ã™
              const attendance = attendances.find(a => a.member_id === member.member_id);

              // è©²å½“ãƒ¡ãƒ³ãƒãƒ¼ã®æ”¯æ‰•ã„æƒ…å ±ã‚’æ¢ã™
              const payment = payments.find(p => p.member_id === member.member_id);

              // è©²å½“ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æƒ…å ±ã‚’æ¢ã™
              const checkin = checkins.find(c => c.member_id === member.member_id);

              // é‡‘é¡ã‚’è¨ˆç®—ï¼ˆBã‚¿ã‚¤ãƒ—ã®å ´åˆã¯selected_optionã‹ã‚‰ã€Aã‚¿ã‚¤ãƒ—ã¯fee_amountï¼‰
              let amount;
              if (payment) {
                // æ”¯æ‰•ã„æƒ…å ±ãŒæ—¢ã«ã‚ã‚‹å ´åˆã¯ãã®é‡‘é¡ã‚’ä½¿ç”¨
                amount = payment.amount;
              } else if (isTypeB && attendance && attendance.selected_option) {
                // Bã‚¿ã‚¤ãƒ—ã§ã€å‡ºå¸­ç™»éŒ²æƒ…å ±ã‹ã‚‰selected_optionã‚’å–å¾—
                amount = getAmountForTypeB(eventDetail, attendance.selected_option);
              } else {
                // Aã‚¿ã‚¤ãƒ—ã¾ãŸã¯selected_optionãŒãªã„å ´åˆã¯fee_amountã‚’ä½¿ç”¨
                amount = feeAmount;
              }

              return {
                payment_id: payment ? payment.payment_id : '',
                member_id: member.member_id,
                member_name: member.name,
                affiliation: member.affiliation,
                attendance_status: attendance ? attendance.status : '-',
                checked_in: checkin ? true : false,
                payment_method: payment ? payment.payment_method : '-',
                amount: amount,
                paid: payment ? payment.paid : false,
                paid_at: payment ? payment.paid_at : '',
                notes: payment ? payment.notes : '',
                is_cancellation_fee: payment ? payment.is_cancellation_fee : false
              };
            });

          // ãƒ¡ãƒ³ãƒãƒ¼IDé †ã«ã‚½ãƒ¼ãƒˆ
          allPayments.sort((a, b) => {
            return a.member_id.localeCompare(b.member_id);
          });

          renderTable();
        } else {
          throw new Error('æ”¯æ‰•ã„æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load payments error:', error);
        Utils.showError('æ”¯æ‰•ã„æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        renderEmptyState('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error.message);
      } finally {
        Utils.hideLoading();
      }
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderTable() {
      const tbody = document.getElementById('paymentsTableBody');

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      let filteredPayments = allPayments;

      // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (searchTerm) {
        filteredPayments = filteredPayments.filter(payment =>
          payment.member_name.toLowerCase().includes(searchTerm)
        );
      }

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (statusFilter === 'unpaid') {
        filteredPayments = filteredPayments.filter(p => !p.paid);
      } else if (statusFilter === 'paid') {
        filteredPayments = filteredPayments.filter(p => p.paid);
      }

      if (filteredPayments.length === 0) {
        renderEmptyState('è©²å½“ã™ã‚‹æ”¯æ‰•ã„æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“', 'æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„');
        return;
      }

      tbody.innerHTML = filteredPayments.map(payment => {
        const statusClass = payment.paid ? 'paid' : 'unpaid';
        const statusText = payment.paid ? 'æ”¯æ‰•ã„æ¸ˆã¿' : 'æœªæ‰•ã„';
        const paidAtText = payment.paid && payment.paid_at ?
          Utils.formatDateTime(payment.paid_at) : '-';

        // å‡ºæ¬ ç™»éŒ²ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤º
        const attendanceStatusText = payment.attendance_status || '-';

        // å®Ÿå‡ºå¸­ã®è¡¨ç¤º
        const checkedInText = payment.checked_in ? 'âœ“' : '-';

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã®è¡¨ç¤º
        const cancellationFeeText = payment.is_cancellation_fee ?
          '<span style="color: #ff6b6b; font-weight: 600;">âš ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™</span>' : '-';

        // å‚™è€ƒã®è¡¨ç¤ºï¼ˆçŸ­ç¸®ç‰ˆï¼‰
        const notesText = payment.notes ?
          (payment.notes.length > 15 ? payment.notes.substring(0, 15) + '...' : payment.notes) : '';

        return `
          <tr>
            <td>${Utils.escapeHtml(payment.member_name)}</td>
            <td>${Utils.escapeHtml(payment.affiliation || '-')}</td>
            <td>${Utils.escapeHtml(attendanceStatusText)}</td>
            <td>${checkedInText}</td>
            <td>${Utils.formatCurrency(payment.amount)}</td>
            <td>${cancellationFeeText}</td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span>${Utils.escapeHtml(payment.payment_method || '-')}</span>
                <button class="btn btn-outline btn-sm" onclick="editPaymentMethod('${payment.payment_id}', '${payment.member_id}', '${Utils.escapeHtml(payment.payment_method || '')}', ${payment.amount})" title="æ”¯æ‰•ã„æ–¹æ³•ã‚’ç·¨é›†">
                  âœï¸
                </button>
              </div>
            </td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${paidAtText}</td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span>${Utils.escapeHtml(notesText)}</span>
                <button class="btn btn-outline btn-sm" onclick="editNotes('${payment.payment_id}', '${payment.member_id}', '${Utils.escapeHtml(payment.notes || '').replace(/'/g, "\\'")}', ${payment.is_cancellation_fee})" title="å‚™è€ƒã‚’ç·¨é›†">
                  ğŸ“
                </button>
              </div>
            </td>
            <td>
              <div class="action-buttons">
                ${payment.is_cancellation_fee && payment.amount > 0 ? `
                  <button class="btn btn-outline btn-sm" onclick="waiveFee('${payment.payment_id}')" style="margin-bottom: 4px;">
                    å…é™¤
                  </button>
                ` : ''}
                ${!payment.paid ? `
                  <button class="btn btn-primary btn-sm" onclick="confirmPayment('${payment.payment_id}', '${payment.member_id}')">
                    æ”¯æ‰•ã„ç¢ºèª
                  </button>
                ` : `
                  <button class="btn btn-outline btn-sm" onclick="unpaidPayment('${payment.payment_id}')">
                    æœªæ‰•ã„ã«æˆ»ã™
                  </button>
                `}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ç©ºçŠ¶æ…‹è¡¨ç¤º
    function renderEmptyState(title, subtitle) {
      const tbody = document.getElementById('paymentsTableBody');
      tbody.innerHTML = `
        <tr>
          <td colspan="11">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ’°</div>
              <div class="empty-state-text">${Utils.escapeHtml(title)}</div>
              <div class="empty-state-subtext">${Utils.escapeHtml(subtitle)}</div>
            </div>
          </td>
        </tr>
      `;
    }

    // æ”¯æ‰•ã„ç¢ºèª
    async function confirmPayment(paymentId, memberId) {
      if (!confirm('ã“ã®æ”¯æ‰•ã„ã‚’ç¢ºèªæ¸ˆã¿ã«ã—ã¾ã™ã‹?')) {
        return;
      }

      Utils.showLoading();

      try {
        // payment_idãŒãªã„å ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ™‚ã®æ”¯æ‰•ã„ç¢ºèªAPIã‚’ä½¿ç”¨
        if (!paymentId) {
          const eventId = document.getElementById('eventSelect').value;
          const result = await API.call('checkinWithPayment', {
            event_id: eventId,
            member_id: memberId,
            payment_confirmed: true
          });

          if (result.success) {
            Utils.showSuccess('æ”¯æ‰•ã„ã‚’ç¢ºèªã—ã¾ã—ãŸ');
            await loadPayments(eventId);
          } else {
            throw new Error(result.message || 'æ”¯æ‰•ã„ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } else {
          // payment_idãŒã‚ã‚‹å ´åˆã¯é€šå¸¸ã®ç¢ºèªAPI
          const result = await API.call('confirmPayment', {
            payment_id: paymentId
          });

          if (result.success) {
            Utils.showSuccess('æ”¯æ‰•ã„ã‚’ç¢ºèªã—ã¾ã—ãŸ');
            const eventId = document.getElementById('eventSelect').value;
            await loadPayments(eventId);
          } else {
            throw new Error(result.message || 'æ”¯æ‰•ã„ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        }

      } catch (error) {
        console.error('Confirm payment error:', error);
        Utils.showError(error.message || 'æ”¯æ‰•ã„ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // æœªæ‰•ã„ã«æˆ»ã™
    async function unpaidPayment(paymentId) {
      if (!confirm('ã“ã®æ”¯æ‰•ã„ã‚’æœªæ‰•ã„ã«æˆ»ã—ã¾ã™ã‹?')) {
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('unpaidPayment', {
          payment_id: paymentId
        });

        if (result.success) {
          Utils.showSuccess('æœªæ‰•ã„ã«æˆ»ã—ã¾ã—ãŸ');
          // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          const eventId = document.getElementById('eventSelect').value;
          await loadPayments(eventId);
        } else {
          throw new Error(result.message || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Unpaid payment error:', error);
        Utils.showError(error.message || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // æ”¯æ‰•ã„æ–¹æ³•ç·¨é›†ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
    let editingPayment = null;

    function editPaymentMethod(paymentId, memberId, currentMethod, amount) {
      const eventId = document.getElementById('eventSelect').value;

      // ç·¨é›†ä¸­ã®æ”¯æ‰•ã„æƒ…å ±ã‚’ä¿å­˜
      editingPayment = {
        payment_id: paymentId,
        member_id: memberId,
        event_id: eventId,
        amount: amount
      };

      // ãƒ¡ãƒ³ãƒãƒ¼åã‚’å–å¾—
      const payment = allPayments.find(p => p.member_id === memberId);
      const memberName = payment ? payment.member_name : '';

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å€¤ã‚’è¨­å®š
      document.getElementById('modalMemberName').value = memberName;
      document.getElementById('modalAmount').value = Utils.formatCurrency(amount);
      document.getElementById('modalPaymentMethod').value = currentMethod || '';

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('paymentMethodModal').style.display = 'flex';
    }
    window.editPaymentMethod = editPaymentMethod;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closePaymentMethodModal() {
      document.getElementById('paymentMethodModal').style.display = 'none';
      editingPayment = null;
    }
    window.closePaymentMethodModal = closePaymentMethodModal;

    // æ”¯æ‰•ã„æ–¹æ³•ã‚’ä¿å­˜
    async function savePaymentMethod() {
      const paymentMethod = document.getElementById('modalPaymentMethod').value;

      if (!paymentMethod) {
        Utils.showError('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (!editingPayment) {
        Utils.showError('ç·¨é›†æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      Utils.showLoading();

      try {
        // payment_idãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãªã—ï¼‰ã€ã‚ã‚‹å ´åˆã¯æ›´æ–°
        if (!editingPayment.payment_id) {
          // æ–°è¦ä½œæˆ: createPaymentRecordã‚’ä½¿ç”¨ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã¯è¡Œã‚ãªã„ï¼‰
          const result = await API.call('createPaymentRecord', {
            event_id: editingPayment.event_id,
            member_id: editingPayment.member_id,
            payment_method: paymentMethod,
            amount: editingPayment.amount
          });

          if (!result.success) {
            throw new Error(result.message || 'æ”¯æ‰•ã„æƒ…å ±ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } else {
          // æ›´æ–°
          await updatePaymentMethod(editingPayment.payment_id, paymentMethod);
        }

        Utils.showSuccess('æ”¯æ‰•ã„æ–¹æ³•ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        await loadPayments(editingPayment.event_id);
        closePaymentMethodModal();

      } catch (error) {
        console.error('Save payment method error:', error);
        Utils.showError(error.message || 'æ”¯æ‰•ã„æ–¹æ³•ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }
    window.savePaymentMethod = savePaymentMethod;

    // æ”¯æ‰•ã„æ–¹æ³•ã‚’æ›´æ–°ï¼ˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼‰
    async function updatePaymentMethod(paymentId, paymentMethod) {
      const result = await API.call('updatePaymentMethod', {
        payment_id: paymentId,
        payment_method: paymentMethod
      });

      if (!result.success) {
        throw new Error(result.message || 'æ”¯æ‰•ã„æ–¹æ³•ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      return result;
    }

    // å‚™è€ƒç·¨é›†ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
    let editingNotes = null;

    function editNotes(paymentId, memberId, currentNotes, isCancellationFee) {
      const eventId = document.getElementById('eventSelect').value;

      // ç·¨é›†ä¸­ã®æƒ…å ±ã‚’ä¿å­˜
      editingNotes = {
        payment_id: paymentId,
        member_id: memberId,
        event_id: eventId,
        is_cancellation_fee: isCancellationFee
      };

      // ãƒ¡ãƒ³ãƒãƒ¼åã‚’å–å¾—
      const payment = allPayments.find(p => p.member_id === memberId);
      const memberName = payment ? payment.member_name : '';

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å€¤ã‚’è¨­å®š
      document.getElementById('notesModalMemberName').value = memberName;
      document.getElementById('notesModalText').value = currentNotes || '';

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('notesModal').style.display = 'flex';
    }
    window.editNotes = editNotes;

    // å‚™è€ƒãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeNotesModal() {
      document.getElementById('notesModal').style.display = 'none';
      editingNotes = null;
    }
    window.closeNotesModal = closeNotesModal;

    // å‚™è€ƒã‚’ä¿å­˜
    async function saveNotes() {
      const notes = document.getElementById('notesModalText').value;

      if (!editingNotes) {
        Utils.showError('ç·¨é›†æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      if (!editingNotes.payment_id) {
        Utils.showError('æ”¯æ‰•ã„æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('updatePaymentNotes', {
          payment_id: editingNotes.payment_id,
          notes: notes
        });

        if (!result.success) {
          throw new Error(result.message || 'å‚™è€ƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        Utils.showSuccess('å‚™è€ƒã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        await loadPayments(editingNotes.event_id);
        closeNotesModal();

      } catch (error) {
        console.error('Save notes error:', error);
        Utils.showError(error.message || 'å‚™è€ƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }
    window.saveNotes = saveNotes;

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã‚’å…é™¤
    async function waiveFee(paymentId) {
      if (!confirm('ã“ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã‚’å…é™¤ã—ã¾ã™ã‹ï¼Ÿ\né‡‘é¡ãŒ0å††ã«ãªã‚Šã€å‚™è€ƒã«ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™å…é™¤ã€ã¨è¨˜è¼‰ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('waiveCancellationFee', {
          payment_id: paymentId,
          reason: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™å…é™¤ï¼ˆç›¸æ®ºã¾ãŸã¯ç‰¹åˆ¥äº‹ç”±ï¼‰'
        });

        if (result.success) {
          Utils.showSuccess('ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã‚’å…é™¤ã—ã¾ã—ãŸ');
          const eventId = document.getElementById('eventSelect').value;
          await loadPayments(eventId);
        } else {
          throw new Error(result.message || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™å…é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Waive fee error:', error);
        Utils.showError(error.message || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™å…é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }
    window.waiveFee = waiveFee;

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
      document.getElementById('mobileToggle').addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.toggle('mobile-open');
      });

      // æœˆé¸æŠ
      document.getElementById('monthSelect').addEventListener('change', (e) => {
        filterEventsByMonth(e.target.value);
        // ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('eventSelect').value = '';
        renderEmptyState('ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨æ”¯æ‰•ã„æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™');
      });

      // ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ
      document.getElementById('eventSelect').addEventListener('change', (e) => {
        loadPayments(e.target.value);
      });

      // ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢
      document.getElementById('memberSearch').addEventListener('input', () => {
        renderTable();
      });

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      document.getElementById('statusFilter').addEventListener('change', () => {
        renderTable();
      });
    }
  </script>
</body>
</html>
