<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>æ”¯æ‰•ã„ç®¡ç† - ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/admin.css">
  <style>
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border-color);
    }

    .tab {
      padding: 1rem 1.5rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
      bottom: -2px;
    }

    .tab:hover {
      color: var(--primary-color);
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .filter-section {
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      align-items: end;
    }

    .data-section {
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .data-table th,
    .data-table td {
      padding: 1rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: var(--text-color);
      white-space: nowrap;
    }

    .data-table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .data-table td {
      color: var(--text-color);
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge-unpaid {
      background-color: #fff3cd;
      color: #856404;
    }

    .badge-paid {
      background-color: #d4edda;
      color: #155724;
    }

    .badge-bank {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .badge-cash {
      background-color: #e2e3e5;
      color: #383d41;
    }

    .badge-cancel {
      background-color: #f8d7da;
      color: #721c24;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 6px;
      white-space: nowrap;
    }

    .btn-confirm {
      background-color: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-confirm:hover {
      background-color: var(--primary-dark);
    }

    .btn-confirm:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .empty-state-subtext {
      font-size: 0.875rem;
      color: var(--text-tertiary);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-card.unpaid {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.paid {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card.cancel {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-label {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
    }

    .notes-cell {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="admin-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h1 class="admin-sidebar-title">ç®¡ç†è€…ç”»é¢</h1>
        <p class="admin-sidebar-subtitle">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <nav class="admin-sidebar-nav">
        <a href="dashboard.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“Š</span>
          <span class="admin-sidebar-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
        <a href="events.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“…</span>
          <span class="admin-sidebar-text">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</span>
        </a>
        <a href="members.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ‘¥</span>
          <span class="admin-sidebar-text">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
        </a>
        <a href="analytics.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“ˆ</span>
          <span class="admin-sidebar-text">å‡ºå¸­ç‡åˆ†æ</span>
        </a>
        <a href="payments.html" class="admin-sidebar-item active">
          <span class="admin-sidebar-icon">ğŸ’°</span>
          <span class="admin-sidebar-text">æ”¯æ‰•ã„ç®¡ç†</span>
        </a>
        <a href="checkin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“±</span>
          <span class="admin-sidebar-text">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
        </a>
        <a href="receipts-admin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ§¾</span>
          <span class="admin-sidebar-text">é ˜åæ›¸ç®¡ç†</span>
        </a>

        <div class="admin-sidebar-divider"></div>

        <a href="../home.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ </span>
          <span class="admin-sidebar-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸</span>
        </a>
      </nav>

      <div class="admin-sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block" style="color: white; border-color: rgba(255,255,255,0.3);">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-main">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="admin-topbar">
        <button class="admin-mobile-toggle" id="mobileToggle">
          â˜°
        </button>
        <h2 class="admin-topbar-title">æ”¯æ‰•ã„ç®¡ç†</h2>
        <div class="admin-topbar-actions">
          <div class="admin-user-info">
            <span class="admin-user-icon">ğŸ‘¤</span>
            <div class="admin-user-details">
              <span class="admin-user-name" id="userName">ç®¡ç†è€…</span>
              <span class="admin-user-role">ç®¡ç†è€…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="admin-content">
        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="stats-grid">
          <div class="stat-card unpaid">
            <div class="stat-label">æœªæ‰•ã„ä»¶æ•°</div>
            <div class="stat-value" id="unpaidCount">0</div>
          </div>
          <div class="stat-card paid">
            <div class="stat-label">æ”¯æ‰•ã„æ¸ˆã¿ä»¶æ•°</div>
            <div class="stat-value" id="paidCount">0</div>
          </div>
          <div class="stat-card cancel">
            <div class="stat-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ä»¶æ•°</div>
            <div class="stat-value" id="cancelCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">æœªæ‰•ã„åˆè¨ˆé‡‘é¡</div>
            <div class="stat-value" id="unpaidTotal">Â¥0</div>
          </div>
        </div>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="tabs">
          <button class="tab active" data-tab="unpaid">æœªæ‰•ã„ä¸€è¦§</button>
          <button class="tab" data-tab="paid">æ”¯æ‰•ã„æ¸ˆã¿ä¸€è¦§</button>
          <button class="tab" data-tab="cancellation">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ä¸€è¦§</button>
        </div>

        <!-- æœªæ‰•ã„ä¸€è¦§ã‚¿ãƒ– -->
        <div class="tab-content active" id="unpaid-content">
          <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <div class="filter-section">
            <div class="filter-row">
              <div class="form-group">
                <label for="unpaidEventFilter" class="form-label">ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ</label>
                <select id="unpaidEventFilter" class="form-input">
                  <option value="">ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                </select>
              </div>
              <div class="form-group">
                <label for="unpaidPaymentMethodFilter" class="form-label">æ”¯æ‰•ã„æ–¹æ³•</label>
                <select id="unpaidPaymentMethodFilter" class="form-input">
                  <option value="">ã™ã¹ã¦</option>
                  <option value="ç¾åœ°æ‰•ã„">ç¾åœ°æ‰•ã„</option>
                  <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                </select>
              </div>
              <div class="form-group">
                <label for="unpaidMemberSearch" class="form-label">ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢</label>
                <input type="text" id="unpaidMemberSearch" class="form-input" placeholder="åå‰ã§æ¤œç´¢...">
              </div>
              <div class="form-group">
                <label class="form-label" style="opacity: 0;">ãƒœã‚¿ãƒ³</label>
                <button id="unpaidFilterBtn" class="btn btn-primary btn-block">çµã‚Šè¾¼ã¿</button>
              </div>
            </div>
          </div>

          <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
          <div class="data-section">
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                    <th>ãƒ¡ãƒ³ãƒãƒ¼å</th>
                    <th>é‡‘é¡</th>
                    <th>æ”¯æ‰•ã„æ–¹æ³•</th>
                    <th>ç· åˆ‡æ—¥</th>
                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                    <th>å‚™è€ƒ</th>
                    <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                  </tr>
                </thead>
                <tbody id="unpaidTableBody">
                  <tr>
                    <td colspan="8">
                      <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’°</div>
                        <div class="empty-state-text">æœªæ‰•ã„ã®æ”¯æ‰•ã„ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                        <div class="empty-state-subtext">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- æ”¯æ‰•ã„æ¸ˆã¿ä¸€è¦§ã‚¿ãƒ– -->
        <div class="tab-content" id="paid-content">
          <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <div class="filter-section">
            <div class="filter-row">
              <div class="form-group">
                <label for="paidEventFilter" class="form-label">ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ</label>
                <select id="paidEventFilter" class="form-input">
                  <option value="">ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                </select>
              </div>
              <div class="form-group">
                <label for="paidPaymentMethodFilter" class="form-label">æ”¯æ‰•ã„æ–¹æ³•</label>
                <select id="paidPaymentMethodFilter" class="form-input">
                  <option value="">ã™ã¹ã¦</option>
                  <option value="ç¾åœ°æ‰•ã„">ç¾åœ°æ‰•ã„</option>
                  <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                </select>
              </div>
              <div class="form-group">
                <label for="paidMemberSearch" class="form-label">ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢</label>
                <input type="text" id="paidMemberSearch" class="form-input" placeholder="åå‰ã§æ¤œç´¢...">
              </div>
              <div class="form-group">
                <label class="form-label" style="opacity: 0;">ãƒœã‚¿ãƒ³</label>
                <button id="paidFilterBtn" class="btn btn-primary btn-block">çµã‚Šè¾¼ã¿</button>
              </div>
            </div>
          </div>

          <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
          <div class="data-section">
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                    <th>ãƒ¡ãƒ³ãƒãƒ¼å</th>
                    <th>é‡‘é¡</th>
                    <th>æ”¯æ‰•ã„æ–¹æ³•</th>
                    <th>æ”¯æ‰•ã„æ—¥æ™‚</th>
                    <th>ç¢ºèªè€…</th>
                    <th>å‚™è€ƒ</th>
                    <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                  </tr>
                </thead>
                <tbody id="paidTableBody">
                  <tr>
                    <td colspan="8">
                      <div class="empty-state">
                        <div class="empty-state-icon">âœ…</div>
                        <div class="empty-state-text">æ”¯æ‰•ã„æ¸ˆã¿ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                        <div class="empty-state-subtext">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ä¸€è¦§ã‚¿ãƒ– -->
        <div class="tab-content" id="cancellation-content">
          <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <div class="filter-section">
            <div class="filter-row">
              <div class="form-group">
                <label for="cancelEventFilter" class="form-label">ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ</label>
                <select id="cancelEventFilter" class="form-input">
                  <option value="">ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                </select>
              </div>
              <div class="form-group">
                <label for="cancelStatusFilter" class="form-label">æ”¯æ‰•ã„çŠ¶æ³</label>
                <select id="cancelStatusFilter" class="form-input">
                  <option value="">ã™ã¹ã¦</option>
                  <option value="unpaid">æœªæ‰•ã„</option>
                  <option value="paid">å—é ˜æ¸ˆã¿</option>
                </select>
              </div>
              <div class="form-group">
                <label for="cancelMemberSearch" class="form-label">ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢</label>
                <input type="text" id="cancelMemberSearch" class="form-input" placeholder="åå‰ã§æ¤œç´¢...">
              </div>
              <div class="form-group">
                <label class="form-label" style="opacity: 0;">ãƒœã‚¿ãƒ³</label>
                <button id="cancelFilterBtn" class="btn btn-primary btn-block">çµã‚Šè¾¼ã¿</button>
              </div>
            </div>
          </div>

          <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
          <div class="data-section">
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                    <th>ãƒ¡ãƒ³ãƒãƒ¼å</th>
                    <th>ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™</th>
                    <th>æ”¯æ‰•ã„çŠ¶æ³</th>
                    <th>å—é ˜æ—¥æ™‚</th>
                    <th>å‚™è€ƒ</th>
                    <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                  </tr>
                </thead>
                <tbody id="cancelTableBody">
                  <tr>
                    <td colspan="7">
                      <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <div class="empty-state-text">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                        <div class="empty-state-subtext">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js?v=2"></script>

  <script>
    const userInfo = Auth.getUserInfo();
    let allUnpaidData = [];
    let allPaidData = [];
    let allCancellationData = [];
    let eventsList = [];

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      Auth.requireAdmin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      await loadAllData();
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
      document.getElementById('mobileToggle').addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.toggle('mobile-open');
      });

      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          switchTab(tabName);
        });
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
      document.getElementById('unpaidFilterBtn').addEventListener('click', () => {
        filterUnpaidData();
      });

      document.getElementById('paidFilterBtn').addEventListener('click', () => {
        filterPaidData();
      });

      document.getElementById('cancelFilterBtn').addEventListener('click', () => {
        filterCancellationData();
      });

      // Enterã‚­ãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      ['unpaidMemberSearch', 'paidMemberSearch', 'cancelMemberSearch'].forEach(id => {
        document.getElementById(id).addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            if (id.startsWith('unpaid')) filterUnpaidData();
            else if (id.startsWith('paid')) filterPaidData();
            else filterCancellationData();
          }
        });
      });
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}-content`).classList.add('active');
    }

    // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadAllData() {
      Utils.showLoading();

      try {
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆå–å¾—
        await loadEventsList();

        // å„ã‚¿ãƒ–ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        await loadUnpaidData();
        await loadPaidData();
        await loadCancellationData();

        // çµ±è¨ˆã‚’æ›´æ–°
        updateStats();

      } catch (error) {
        console.error('Load data error:', error);
        Utils.showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆå–å¾—
    async function loadEventsList() {
      try {
        const result = await API.call('getEvents', {});

        if (result.success && result.events) {
          eventsList = result.events;

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠè‚¢ã‚’è¨­å®š
          const eventSelects = [
            document.getElementById('unpaidEventFilter'),
            document.getElementById('paidEventFilter'),
            document.getElementById('cancelEventFilter')
          ];

          eventSelects.forEach(select => {
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æ®‹ã™ï¼‰
            select.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆ</option>';

            eventsList.forEach(event => {
              const option = document.createElement('option');
              option.value = event.event_id;
              option.textContent = event.title;
              select.appendChild(option);
            });
          });
        }
      } catch (error) {
        console.error('Load events error:', error);
      }
    }

    // æœªæ‰•ã„ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadUnpaidData() {
      try {
        const result = await API.call('getUnpaidList', {});

        if (result.success && result.payments) {
          allUnpaidData = result.payments;
          renderUnpaidTable(allUnpaidData);
        } else {
          allUnpaidData = [];
          renderUnpaidTable([]);
        }
      } catch (error) {
        console.error('Load unpaid data error:', error);
        allUnpaidData = [];
        renderUnpaidTable([]);
      }
    }

    // æ”¯æ‰•ã„æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadPaidData() {
      try {
        const result = await API.call('getPaidList', {});

        if (result.success && result.payments) {
          allPaidData = result.payments;
          renderPaidTable(allPaidData);
        } else {
          allPaidData = [];
          renderPaidTable([]);
        }
      } catch (error) {
        console.error('Load paid data error:', error);
        allPaidData = [];
        renderPaidTable([]);
      }
    }

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadCancellationData() {
      try {
        const result = await API.call('getCancellationFeeList', {});

        if (result.success && result.cancellations) {
          allCancellationData = result.cancellations;
          renderCancellationTable(allCancellationData);
        } else {
          allCancellationData = [];
          renderCancellationTable([]);
        }
      } catch (error) {
        console.error('Load cancellation data error:', error);
        allCancellationData = [];
        renderCancellationTable([]);
      }
    }

    // æœªæ‰•ã„ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterUnpaidData() {
      const eventFilter = document.getElementById('unpaidEventFilter').value;
      const methodFilter = document.getElementById('unpaidPaymentMethodFilter').value;
      const searchText = document.getElementById('unpaidMemberSearch').value.toLowerCase();

      let filtered = allUnpaidData;

      if (eventFilter) {
        filtered = filtered.filter(p => p.event_id === eventFilter);
      }

      if (methodFilter) {
        filtered = filtered.filter(p => p.payment_method === methodFilter);
      }

      if (searchText) {
        filtered = filtered.filter(p =>
          p.member_name.toLowerCase().includes(searchText)
        );
      }

      renderUnpaidTable(filtered);
    }

    // æ”¯æ‰•ã„æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterPaidData() {
      const eventFilter = document.getElementById('paidEventFilter').value;
      const methodFilter = document.getElementById('paidPaymentMethodFilter').value;
      const searchText = document.getElementById('paidMemberSearch').value.toLowerCase();

      let filtered = allPaidData;

      if (eventFilter) {
        filtered = filtered.filter(p => p.event_id === eventFilter);
      }

      if (methodFilter) {
        filtered = filtered.filter(p => p.payment_method === methodFilter);
      }

      if (searchText) {
        filtered = filtered.filter(p =>
          p.member_name.toLowerCase().includes(searchText)
        );
      }

      renderPaidTable(filtered);
    }

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterCancellationData() {
      const eventFilter = document.getElementById('cancelEventFilter').value;
      const statusFilter = document.getElementById('cancelStatusFilter').value;
      const searchText = document.getElementById('cancelMemberSearch').value.toLowerCase();

      let filtered = allCancellationData;

      if (eventFilter) {
        filtered = filtered.filter(c => c.event_id === eventFilter);
      }

      if (statusFilter) {
        if (statusFilter === 'paid') {
          filtered = filtered.filter(c => c.paid);
        } else if (statusFilter === 'unpaid') {
          filtered = filtered.filter(c => !c.paid);
        }
      }

      if (searchText) {
        filtered = filtered.filter(c =>
          c.member_name.toLowerCase().includes(searchText)
        );
      }

      renderCancellationTable(filtered);
    }

    // æœªæ‰•ã„ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderUnpaidTable(data) {
      const tbody = document.getElementById('unpaidTableBody');

      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ’°</div>
                <div class="empty-state-text">æœªæ‰•ã„ã®æ”¯æ‰•ã„ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                <div class="empty-state-subtext">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = data.map(payment => `
        <tr>
          <td>${Utils.escapeHtml(payment.event_title)}</td>
          <td>${Utils.escapeHtml(payment.member_name)}</td>
          <td>Â¥${Utils.formatNumber(payment.amount)}</td>
          <td>
            <span class="badge ${payment.payment_method === 'éŠ€è¡ŒæŒ¯è¾¼' ? 'badge-bank' : 'badge-cash'}">
              ${Utils.escapeHtml(payment.payment_method)}
            </span>
          </td>
          <td>${Utils.formatDate(payment.deadline) || '-'}</td>
          <td>
            <span class="badge badge-unpaid">æœªæ‰•ã„</span>
          </td>
          <td class="notes-cell" title="${Utils.escapeHtml(payment.notes || '')}">
            ${Utils.escapeHtml(payment.notes || '-')}
          </td>
          <td>
            <button class="btn btn-sm btn-confirm" onclick="confirmPayment('${payment.payment_id}')">
              æ”¯æ‰•ã„ç¢ºèª
            </button>
          </td>
        </tr>
      `).join('');
    }

    // æ”¯æ‰•ã„æ¸ˆã¿ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderPaidTable(data) {
      const tbody = document.getElementById('paidTableBody');

      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="empty-state-icon">âœ…</div>
                <div class="empty-state-text">æ”¯æ‰•ã„æ¸ˆã¿ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                <div class="empty-state-subtext">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = data.map(payment => `
        <tr>
          <td>${Utils.escapeHtml(payment.event_title)}</td>
          <td>${Utils.escapeHtml(payment.member_name)}</td>
          <td>Â¥${Utils.formatNumber(payment.amount)}</td>
          <td>
            <span class="badge ${payment.payment_method === 'éŠ€è¡ŒæŒ¯è¾¼' ? 'badge-bank' : 'badge-cash'}">
              ${Utils.escapeHtml(payment.payment_method)}
            </span>
          </td>
          <td>${Utils.formatDateTime(payment.paid_at) || '-'}</td>
          <td>${payment.paid_by_admin ? 'ç®¡ç†è€…ç¢ºèª' : 'QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³'}</td>
          <td class="notes-cell" title="${Utils.escapeHtml(payment.notes || '')}">
            ${Utils.escapeHtml(payment.notes || '-')}
          </td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="unpaidPayment('${payment.payment_id}')">
              æœªæ‰•ã„ã«æˆ»ã™
            </button>
          </td>
        </tr>
      `).join('');
    }

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderCancellationTable(data) {
      const tbody = document.getElementById('cancelTableBody');

      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="empty-state-icon">âŒ</div>
                <div class="empty-state-text">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                <div class="empty-state-subtext">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = data.map(cancel => `
        <tr>
          <td>${Utils.escapeHtml(cancel.event_title)}</td>
          <td>${Utils.escapeHtml(cancel.member_name)}</td>
          <td>Â¥${Utils.formatNumber(cancel.cancellation_fee)}</td>
          <td>
            <span class="badge ${cancel.paid ? 'badge-paid' : 'badge-unpaid'}">
              ${cancel.paid ? 'å—é ˜æ¸ˆã¿' : 'æœªæ‰•ã„'}
            </span>
          </td>
          <td>${cancel.paid ? Utils.formatDateTime(cancel.paid_at) : '-'}</td>
          <td class="notes-cell" title="${Utils.escapeHtml(cancel.notes || '')}">
            ${Utils.escapeHtml(cancel.notes || '-')}
          </td>
          <td>
            ${!cancel.paid ? `
              <button class="btn btn-sm btn-confirm" onclick="confirmCancellationFee('${cancel.payment_id}')">
                å—é ˜ç¢ºèª
              </button>
            ` : '-'}
          </td>
        </tr>
      `).join('');
    }

    // çµ±è¨ˆæ›´æ–°
    function updateStats() {
      // æœªæ‰•ã„ä»¶æ•°
      const unpaidCount = allUnpaidData.length;
      document.getElementById('unpaidCount').textContent = unpaidCount;

      // æ”¯æ‰•ã„æ¸ˆã¿ä»¶æ•°
      const paidCount = allPaidData.length;
      document.getElementById('paidCount').textContent = paidCount;

      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ä»¶æ•°
      const cancelCount = allCancellationData.length;
      document.getElementById('cancelCount').textContent = cancelCount;

      // æœªæ‰•ã„åˆè¨ˆé‡‘é¡
      const unpaidTotal = allUnpaidData.reduce((sum, p) => sum + (p.amount || 0), 0);
      document.getElementById('unpaidTotal').textContent = 'Â¥' + Utils.formatNumber(unpaidTotal);
    }

    // æ”¯æ‰•ã„ç¢ºèª
    async function confirmPayment(paymentId) {
      if (!confirm('ã“ã®æ”¯æ‰•ã„ã‚’ç¢ºèªæ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('confirmPayment', {
          payment_id: paymentId
        });

        if (result.success) {
          Utils.showSuccess('æ”¯æ‰•ã„ã‚’ç¢ºèªã—ã¾ã—ãŸ');

          // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’ä¿å­˜
          const currentEventFilter = document.getElementById('unpaidEventFilter').value;
          const currentMethodFilter = document.getElementById('unpaidPaymentMethodFilter').value;
          const currentSearch = document.getElementById('unpaidMemberSearch').value;

          // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          await loadAllData();

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’å¾©å…ƒ
          document.getElementById('unpaidEventFilter').value = currentEventFilter;
          document.getElementById('unpaidPaymentMethodFilter').value = currentMethodFilter;
          document.getElementById('unpaidMemberSearch').value = currentSearch;

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
          filterUnpaidData();
        } else {
          throw new Error(result.message || 'æ”¯æ‰•ã„ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Confirm payment error:', error);
        Utils.showError(error.message || 'æ”¯æ‰•ã„ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // æœªæ‰•ã„ã«æˆ»ã™
    async function unpaidPayment(paymentId) {
      if (!confirm('ã“ã®æ”¯æ‰•ã„ã‚’æœªæ‰•ã„ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('unpaidPayment', {
          payment_id: paymentId
        });

        if (result.success) {
          Utils.showSuccess('æœªæ‰•ã„ã«æˆ»ã—ã¾ã—ãŸ');

          // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’ä¿å­˜
          const currentEventFilter = document.getElementById('paidEventFilter').value;
          const currentMethodFilter = document.getElementById('paidPaymentMethodFilter').value;
          const currentSearch = document.getElementById('paidMemberSearch').value;

          // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          await loadAllData();

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’å¾©å…ƒ
          document.getElementById('paidEventFilter').value = currentEventFilter;
          document.getElementById('paidPaymentMethodFilter').value = currentMethodFilter;
          document.getElementById('paidMemberSearch').value = currentSearch;

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
          filterPaidData();
        } else {
          throw new Error(result.message || 'æœªæ‰•ã„ã¸ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Unpaid payment error:', error);
        Utils.showError(error.message || 'æœªæ‰•ã„ã¸ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }
    window.unpaidPayment = unpaidPayment;

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™å—é ˜ç¢ºèª
    async function confirmCancellationFee(paymentId) {
      if (!confirm('ã“ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã‚’å—é ˜æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('confirmPayment', {
          payment_id: paymentId
        });

        if (result.success) {
          Utils.showSuccess('ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã‚’å—é ˜ç¢ºèªã—ã¾ã—ãŸ');

          // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’ä¿å­˜
          const currentEventFilter = document.getElementById('cancelEventFilter').value;
          const currentSearch = document.getElementById('cancelMemberSearch').value;

          // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          await loadAllData();

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’å¾©å…ƒ
          document.getElementById('cancelEventFilter').value = currentEventFilter;
          document.getElementById('cancelMemberSearch').value = currentSearch;

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
          filterCancellationData();
        } else {
          throw new Error(result.message || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã®å—é ˜ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Confirm cancellation fee error:', error);
        Utils.showError(error.message || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã®å—é ˜ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }
  </script>
</body>
</html>
