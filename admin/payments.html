<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>æ”¯æ‰•ã„ç®¡ç† - ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/admin.css">
  <style>
    .filter-section {
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      align-items: end;
    }

    .data-section {
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .data-table th,
    .data-table td {
      padding: 1rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: var(--text-color);
      white-space: nowrap;
    }

    .data-table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .status-badge {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-align: center;
    }

    .status-badge.unpaid {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-badge.paid {
      background-color: #d4edda;
      color: #155724;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .empty-state-text {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }

    .empty-state-subtext {
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="admin-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h1 class="admin-sidebar-title">ç®¡ç†è€…ç”»é¢</h1>
        <p class="admin-sidebar-subtitle">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <nav class="admin-sidebar-nav">
        <a href="dashboard.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“Š</span>
          <span class="admin-sidebar-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
        <a href="events.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“…</span>
          <span class="admin-sidebar-text">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</span>
        </a>
        <a href="members.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ‘¥</span>
          <span class="admin-sidebar-text">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
        </a>
        <a href="analytics.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“ˆ</span>
          <span class="admin-sidebar-text">å‡ºå¸­ç‡åˆ†æ</span>
        </a>
        <a href="payments.html" class="admin-sidebar-item active">
          <span class="admin-sidebar-icon">ğŸ’°</span>
          <span class="admin-sidebar-text">æ”¯æ‰•ã„ç®¡ç†</span>
        </a>
        <a href="checkin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“±</span>
          <span class="admin-sidebar-text">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
        </a>
        <a href="receipts-admin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ§¾</span>
          <span class="admin-sidebar-text">é ˜åæ›¸ç®¡ç†</span>
        </a>

        <div class="admin-sidebar-divider"></div>

        <a href="../home.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ </span>
          <span class="admin-sidebar-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸</span>
        </a>
      </nav>

      <div class="admin-sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block" style="color: white; border-color: rgba(255,255,255,0.3);">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-main">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="admin-topbar">
        <button class="admin-mobile-toggle" id="mobileToggle">
          â˜°
        </button>
        <h2 class="admin-topbar-title">æ”¯æ‰•ã„ç®¡ç†</h2>
        <div class="admin-topbar-actions">
          <div class="admin-user-info">
            <span class="admin-user-icon">ğŸ‘¤</span>
            <div class="admin-user-details">
              <span class="admin-user-name" id="userName">ç®¡ç†è€…</span>
              <span class="admin-user-role">ç®¡ç†è€…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="admin-content">
        <!-- ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ -->
        <div class="filter-section">
          <div class="filter-row">
            <div class="form-group">
              <label for="monthSelect" class="form-label required">å¹´æœˆã‚’é¸æŠ</label>
              <select id="monthSelect" class="form-input" required>
                <option value="">å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>
            <div class="form-group">
              <label for="eventSelect" class="form-label required">ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ</label>
              <select id="eventSelect" class="form-input" required disabled>
                <option value="">ã¾ãšå¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>
            <div class="form-group">
              <label for="memberSearch" class="form-label">ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢</label>
              <input type="text" id="memberSearch" class="form-input" placeholder="åå‰ã§æ¤œç´¢...">
            </div>
            <div class="form-group">
              <label for="statusFilter" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <select id="statusFilter" class="form-input">
                <option value="">ã™ã¹ã¦</option>
                <option value="unpaid">æœªæ‰•ã„</option>
                <option value="paid">æ”¯æ‰•ã„æ¸ˆã¿</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="data-section">
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ãƒ¡ãƒ³ãƒãƒ¼å</th>
                  <th>æ‰€å±</th>
                  <th>å‡ºæ¬ ç™»éŒ²</th>
                  <th>å®Ÿå‡ºå¸­</th>
                  <th>é‡‘é¡</th>
                  <th>æ”¯æ‰•ã„æ–¹æ³•</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th>æ”¯æ‰•ã„æ—¥æ™‚</th>
                  <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                </tr>
              </thead>
              <tbody id="paymentsTableBody">
                <tr>
                  <td colspan="9">
                    <div class="empty-state">
                      <div class="empty-state-icon">ğŸ’°</div>
                      <div class="empty-state-text">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                      <div class="empty-state-subtext">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨æ”¯æ‰•ã„æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let allPayments = [];
    let allMembers = [];
    let allEvents = [];
    let currentEvent = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      Auth.requireAdmin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      const userInfo = Auth.getUserInfo();
      if (userInfo) {
        document.getElementById('userName').textContent = userInfo.name || 'ç®¡ç†è€…';
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã¨ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
      await loadEvents();
      await loadMembers();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
    async function loadEvents() {
      Utils.showLoading();

      try {
        const result = await API.call('getEvents', {});

        if (result.success && result.events) {
          // ç™»éŒ²æ–™ãŒã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
          allEvents = result.events.filter(e => e.fee_amount && e.fee_amount > 0);

          // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
          allEvents.sort((a, b) => {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            return dateB - dateA;
          });

          // æœˆã‚»ãƒ¬ã‚¯ã‚¿ã‚’åˆæœŸåŒ–
          populateMonthSelector();
        }

      } catch (error) {
        console.error('Load events error:', error);
        Utils.showError('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // æœˆã‚»ãƒ¬ã‚¯ã‚¿ã‚’ç”Ÿæˆ
    function populateMonthSelector() {
      const monthSelect = document.getElementById('monthSelect');
      monthSelect.innerHTML = '<option value="">å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

      if (allEvents.length === 0) {
        console.warn('No events available for month selector');
        return;
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å¹´æœˆã‚’æŠ½å‡ºï¼ˆé‡è¤‡ãªã—ï¼‰
      const yearMonths = new Set();
      allEvents.forEach(event => {
        // event.dateã¯ "YYYY-MM-DD" å½¢å¼ã®æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
        const dateStr = event.date;
        console.log('Event date:', dateStr); // ãƒ‡ãƒãƒƒã‚°ç”¨

        // YYYY-MM-DDå½¢å¼ã‹ã‚‰å¹´æœˆã‚’æŠ½å‡º
        if (dateStr && typeof dateStr === 'string') {
          const yearMonth = dateStr.substring(0, 7); // "YYYY-MM"
          yearMonths.add(yearMonth);
        }
      });

      console.log('Available year-months:', Array.from(yearMonths)); // ãƒ‡ãƒãƒƒã‚°ç”¨

      // ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
      const sortedYearMonths = Array.from(yearMonths).sort().reverse();

      sortedYearMonths.forEach(yearMonth => {
        const [year, month] = yearMonth.split('-');
        const option = document.createElement('option');
        option.value = yearMonth;
        option.textContent = `${year}å¹´${parseInt(month)}æœˆ`;
        monthSelect.appendChild(option);
      });

      // ç¾åœ¨ã®æœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
      const now = new Date();
      const currentYearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      console.log('Current year-month:', currentYearMonth); // ãƒ‡ãƒãƒƒã‚°ç”¨

      if (sortedYearMonths.includes(currentYearMonth)) {
        monthSelect.value = currentYearMonth;
        filterEventsByMonth(currentYearMonth);
      } else if (sortedYearMonths.length > 0) {
        // ç¾åœ¨ã®æœˆãŒãªã„å ´åˆã¯ã€æœ€æ–°ã®æœˆã‚’é¸æŠ
        monthSelect.value = sortedYearMonths[0];
        filterEventsByMonth(sortedYearMonths[0]);
      }
    }

    // æœˆã§çµã‚Šè¾¼ã‚“ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ã‚’æ›´æ–°
    function filterEventsByMonth(yearMonth) {
      const eventSelect = document.getElementById('eventSelect');
      eventSelect.innerHTML = '<option value="">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

      if (!yearMonth) {
        eventSelect.disabled = true;
        eventSelect.innerHTML = '<option value="">ã¾ãšå¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        return;
      }

      console.log('Filtering events for year-month:', yearMonth); // ãƒ‡ãƒãƒƒã‚°ç”¨

      // é¸æŠã•ã‚ŒãŸæœˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const filteredEvents = allEvents.filter(event => {
        // event.dateã¯ "YYYY-MM-DD" å½¢å¼ã®æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
        const dateStr = event.date;
        if (dateStr && typeof dateStr === 'string') {
          const eventYearMonth = dateStr.substring(0, 7); // "YYYY-MM"
          return eventYearMonth === yearMonth;
        }
        return false;
      });

      console.log('Filtered events count:', filteredEvents.length); // ãƒ‡ãƒãƒƒã‚°ç”¨

      if (filteredEvents.length === 0) {
        eventSelect.disabled = true;
        eventSelect.innerHTML = '<option value="">ã“ã®æœˆã«ã¯ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
        return;
      }

      eventSelect.disabled = false;
      filteredEvents.forEach(event => {
        const option = document.createElement('option');
        option.value = event.event_id;
        option.textContent = `${event.title} (${event.date})`;
        eventSelect.appendChild(option);
      });
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
    async function loadMembers() {
      try {
        const result = await API.call('getMembers');

        if (result.success && result.members) {
          allMembers = result.members;
        }

      } catch (error) {
        console.error('Load members error:', error);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆåˆ¥æ”¯æ‰•ã„æƒ…å ±èª­ã¿è¾¼ã¿
    async function loadPayments(eventId) {
      if (!eventId) {
        renderEmptyState('ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨æ”¯æ‰•ã„æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™');
        return;
      }

      Utils.showLoading();

      try {
        // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆã¾ã å–å¾—ã—ã¦ã„ãªã„å ´åˆï¼‰
        if (allMembers.length === 0) {
          await loadMembers();
        }

        // å‡ºå¸­ç™»éŒ²æƒ…å ±ã‚’å–å¾—
        const attendanceResult = await API.call('getEventAttendance', {
          event_id: eventId
        });

        // æ”¯æ‰•ã„æƒ…å ±ã‚’å–å¾—
        const paymentResult = await API.call('getPaymentsByEvent', {
          event_id: eventId
        });

        // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
        const checkinResult = await API.call('getCheckinList', {
          event_id: eventId
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã‚’å–å¾—ï¼ˆç™»éŒ²æ–™ã®é‡‘é¡ã‚’å–å¾—ï¼‰
        const eventDetail = allEvents.find(e => e.event_id === eventId);
        const feeAmount = eventDetail ? eventDetail.fee_amount : 0;

        if (attendanceResult.success && paymentResult.success && checkinResult.success) {
          const attendances = attendanceResult.attendance || [];
          const payments = paymentResult.payments || [];
          const checkins = checkinResult.checkins || [];

          // å‡ºå¸­äºˆå®šè€…ï¼ˆå‡ºå¸­ã¾ãŸã¯å…¬æ¬ ï¼‰ã®ãƒ¡ãƒ³ãƒãƒ¼IDã‚’å–å¾—
          const attendingMemberIds = attendances
            .filter(a => a.status === 'å‡ºå¸­' || a.status === 'å…¬æ¬ ')
            .map(a => a.member_id);

          // ã™ã¹ã¦ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¡¨ç¤ºï¼ˆå‡ºå¸­äºˆå®šè€…ã®ã¿ï¼‰
          allPayments = allMembers
            .filter(member => attendingMemberIds.includes(member.member_id))
            .map(member => {
              // è©²å½“ãƒ¡ãƒ³ãƒãƒ¼ã®å‡ºå¸­ç™»éŒ²æƒ…å ±ã‚’æ¢ã™
              const attendance = attendances.find(a => a.member_id === member.member_id);

              // è©²å½“ãƒ¡ãƒ³ãƒãƒ¼ã®æ”¯æ‰•ã„æƒ…å ±ã‚’æ¢ã™
              const payment = payments.find(p => p.member_id === member.member_id);

              // è©²å½“ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æƒ…å ±ã‚’æ¢ã™
              const checkin = checkins.find(c => c.member_id === member.member_id);

              return {
                payment_id: payment ? payment.payment_id : '',
                member_id: member.member_id,
                member_name: member.name,
                affiliation: member.affiliation,
                attendance_status: attendance ? attendance.status : '-',
                checked_in: checkin ? true : false,
                payment_method: payment ? payment.payment_method : '-',
                amount: payment ? payment.amount : feeAmount,
                paid: payment ? payment.paid : false,
                paid_at: payment ? payment.paid_at : '',
                notes: payment ? payment.notes : ''
              };
            });

          // ãƒ¡ãƒ³ãƒãƒ¼IDé †ã«ã‚½ãƒ¼ãƒˆ
          allPayments.sort((a, b) => {
            return a.member_id.localeCompare(b.member_id);
          });

          renderTable();
        } else {
          throw new Error('æ”¯æ‰•ã„æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load payments error:', error);
        Utils.showError('æ”¯æ‰•ã„æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        renderEmptyState('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error.message);
      } finally {
        Utils.hideLoading();
      }
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderTable() {
      const tbody = document.getElementById('paymentsTableBody');

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      let filteredPayments = allPayments;

      // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (searchTerm) {
        filteredPayments = filteredPayments.filter(payment =>
          payment.member_name.toLowerCase().includes(searchTerm)
        );
      }

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (statusFilter === 'unpaid') {
        filteredPayments = filteredPayments.filter(p => !p.paid);
      } else if (statusFilter === 'paid') {
        filteredPayments = filteredPayments.filter(p => p.paid);
      }

      if (filteredPayments.length === 0) {
        renderEmptyState('è©²å½“ã™ã‚‹æ”¯æ‰•ã„æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“', 'æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„');
        return;
      }

      tbody.innerHTML = filteredPayments.map(payment => {
        const statusClass = payment.paid ? 'paid' : 'unpaid';
        const statusText = payment.paid ? 'æ”¯æ‰•ã„æ¸ˆã¿' : 'æœªæ‰•ã„';
        const paidAtText = payment.paid && payment.paid_at ?
          Utils.formatDateTime(payment.paid_at) : '-';

        // å‡ºæ¬ ç™»éŒ²ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤º
        const attendanceStatusText = payment.attendance_status || '-';

        // å®Ÿå‡ºå¸­ã®è¡¨ç¤º
        const checkedInText = payment.checked_in ? 'âœ“' : '-';

        return `
          <tr>
            <td>${Utils.escapeHtml(payment.member_name)}</td>
            <td>${Utils.escapeHtml(payment.affiliation || '-')}</td>
            <td>${Utils.escapeHtml(attendanceStatusText)}</td>
            <td>${checkedInText}</td>
            <td>${Utils.formatCurrency(payment.amount)}</td>
            <td>${Utils.escapeHtml(payment.payment_method || '-')}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${paidAtText}</td>
            <td>
              <div class="action-buttons">
                ${!payment.paid ? `
                  <button class="btn btn-primary btn-sm" onclick="confirmPayment('${payment.payment_id}', '${payment.member_id}')">
                    æ”¯æ‰•ã„ç¢ºèª
                  </button>
                ` : `
                  <button class="btn btn-outline btn-sm" onclick="unpaidPayment('${payment.payment_id}')">
                    æœªæ‰•ã„ã«æˆ»ã™
                  </button>
                `}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ç©ºçŠ¶æ…‹è¡¨ç¤º
    function renderEmptyState(title, subtitle) {
      const tbody = document.getElementById('paymentsTableBody');
      tbody.innerHTML = `
        <tr>
          <td colspan="9">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ’°</div>
              <div class="empty-state-text">${Utils.escapeHtml(title)}</div>
              <div class="empty-state-subtext">${Utils.escapeHtml(subtitle)}</div>
            </div>
          </td>
        </tr>
      `;
    }

    // æ”¯æ‰•ã„ç¢ºèª
    async function confirmPayment(paymentId, memberId) {
      if (!confirm('ã“ã®æ”¯æ‰•ã„ã‚’ç¢ºèªæ¸ˆã¿ã«ã—ã¾ã™ã‹?')) {
        return;
      }

      Utils.showLoading();

      try {
        // payment_idãŒãªã„å ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ™‚ã®æ”¯æ‰•ã„ç¢ºèªAPIã‚’ä½¿ç”¨
        if (!paymentId) {
          const eventId = document.getElementById('eventSelect').value;
          const result = await API.call('checkinWithPayment', {
            event_id: eventId,
            member_id: memberId,
            payment_confirmed: true
          });

          if (result.success) {
            Utils.showSuccess('æ”¯æ‰•ã„ã‚’ç¢ºèªã—ã¾ã—ãŸ');
            await loadPayments(eventId);
          } else {
            throw new Error(result.message || 'æ”¯æ‰•ã„ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } else {
          // payment_idãŒã‚ã‚‹å ´åˆã¯é€šå¸¸ã®ç¢ºèªAPI
          const result = await API.call('confirmPayment', {
            payment_id: paymentId
          });

          if (result.success) {
            Utils.showSuccess('æ”¯æ‰•ã„ã‚’ç¢ºèªã—ã¾ã—ãŸ');
            const eventId = document.getElementById('eventSelect').value;
            await loadPayments(eventId);
          } else {
            throw new Error(result.message || 'æ”¯æ‰•ã„ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        }

      } catch (error) {
        console.error('Confirm payment error:', error);
        Utils.showError(error.message || 'æ”¯æ‰•ã„ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // æœªæ‰•ã„ã«æˆ»ã™
    async function unpaidPayment(paymentId) {
      if (!confirm('ã“ã®æ”¯æ‰•ã„ã‚’æœªæ‰•ã„ã«æˆ»ã—ã¾ã™ã‹?')) {
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('unpaidPayment', {
          payment_id: paymentId
        });

        if (result.success) {
          Utils.showSuccess('æœªæ‰•ã„ã«æˆ»ã—ã¾ã—ãŸ');
          // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          const eventId = document.getElementById('eventSelect').value;
          await loadPayments(eventId);
        } else {
          throw new Error(result.message || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Unpaid payment error:', error);
        Utils.showError(error.message || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
      document.getElementById('mobileToggle').addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.toggle('mobile-open');
      });

      // æœˆé¸æŠ
      document.getElementById('monthSelect').addEventListener('change', (e) => {
        filterEventsByMonth(e.target.value);
        // ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('eventSelect').value = '';
        renderEmptyState('ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨æ”¯æ‰•ã„æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™');
      });

      // ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ
      document.getElementById('eventSelect').addEventListener('change', (e) => {
        loadPayments(e.target.value);
      });

      // ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢
      document.getElementById('memberSearch').addEventListener('input', () => {
        renderTable();
      });

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      document.getElementById('statusFilter').addEventListener('change', () => {
        renderTable();
      });
    }
  </script>
</body>
</html>
