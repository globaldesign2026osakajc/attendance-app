<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ - ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/admin.css">
  <style>
    /* QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼é–¢é€£ */
    .scanner-container {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .scanner-section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0 0 1.5rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
    }

    .scanner-video-wrapper {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto 1.5rem auto;
      background-color: #000;
      border-radius: 12px;
      overflow: hidden;
      aspect-ratio: 1 / 1;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #canvas {
      display: none;
    }

    .scanner-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: var(--gray-light);
      color: var(--text-secondary);
    }

    .scanner-placeholder-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .scanner-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 1.5rem;
    }

    .manual-input-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border-color);
    }

    .manual-input-row {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
    }

    .manual-input-row .form-group {
      flex: 1;
    }

    .payment-confirmation {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background-color: var(--warning-bg);
      border-radius: 8px;
      display: none;
    }

    .payment-confirmation.show {
      display: block;
    }

    .payment-confirmation-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--warning-color);
      margin: 0 0 1rem 0;
    }

    .payment-checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .payment-checkbox-wrapper input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .payment-checkbox-wrapper label {
      font-size: 0.938rem;
      font-weight: 600;
      cursor: pointer;
      margin: 0;
    }

    /* ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³çŠ¶æ³ */
    .checkin-stats {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .checkin-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1.5rem;
    }

    .checkin-stat-item {
      text-align: center;
    }

    .checkin-stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .checkin-stat-value.success {
      color: var(--success-color);
    }

    .checkin-stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å±¥æ­´ */
    .checkin-history {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .checkin-history-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-color);
      margin: 0 0 1.5rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
    }

    .checkin-history-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .checkin-history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.3s ease;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .checkin-history-item:hover {
      background-color: var(--gray-light);
    }

    .checkin-history-item:last-child {
      border-bottom: none;
    }

    .checkin-history-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .checkin-history-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .checkin-history-time {
      font-size: 0.813rem;
      color: var(--text-secondary);
    }

    .checkin-history-badge {
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .checkin-history-badge.paid {
      background-color: var(--success-bg);
      color: var(--success-color);
    }

    .checkin-history-badge.unpaid {
      background-color: var(--warning-bg);
      color: var(--warning-color);
    }

    .checkin-history-empty {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .checkin-history-empty-icon {
      font-size: 3rem;
      opacity: 0.5;
      margin-bottom: 1rem;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast {
      position: fixed;
      top: 100px;
      right: 2rem;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      font-weight: 600;
      z-index: 2000;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .toast.success {
      background-color: var(--success-color);
      color: white;
    }

    .toast.error {
      background-color: var(--danger-color);
      color: white;
    }

    .toast.warning {
      background-color: var(--warning-color);
      color: white;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .scanner-container,
      .checkin-stats,
      .checkin-history {
        padding: 1.5rem;
      }

      .manual-input-row {
        flex-direction: column;
      }

      .manual-input-row .btn {
        width: 100%;
      }

      .toast {
        right: 1rem;
        left: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div id="toast" class="toast"></div>

  <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="admin-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h1 class="admin-sidebar-title">ç®¡ç†è€…ç”»é¢</h1>
        <p class="admin-sidebar-subtitle">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <nav class="admin-sidebar-nav">
        <a href="dashboard.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“Š</span>
          <span class="admin-sidebar-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
        <a href="events.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“…</span>
          <span class="admin-sidebar-text">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</span>
        </a>
        <a href="members.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ‘¥</span>
          <span class="admin-sidebar-text">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
        </a>
        <a href="analytics.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“ˆ</span>
          <span class="admin-sidebar-text">å‡ºå¸­ç‡åˆ†æ</span>
        </a>
        <a href="payments.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ’°</span>
          <span class="admin-sidebar-text">æ”¯æ‰•ã„ç®¡ç†</span>
        </a>
        <a href="checkin.html" class="admin-sidebar-item active">
          <span class="admin-sidebar-icon">ğŸ“±</span>
          <span class="admin-sidebar-text">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
        </a>
        <a href="receipts-admin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ§¾</span>
          <span class="admin-sidebar-text">é ˜åæ›¸ç®¡ç†</span>
        </a>

        <div class="admin-sidebar-divider"></div>

        <a href="../home.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ </span>
          <span class="admin-sidebar-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸</span>
        </a>
      </nav>

      <div class="admin-sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block" style="color: white; border-color: rgba(255,255,255,0.3);">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-main">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="admin-topbar">
        <button class="admin-mobile-toggle" id="mobileToggle">
          â˜°
        </button>
        <h2 class="admin-topbar-title">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h2>
        <div class="admin-topbar-actions">
          <div class="admin-user-info">
            <span class="admin-user-icon">ğŸ‘¤</span>
            <div class="admin-user-details">
              <span class="admin-user-name" id="userName">ç®¡ç†è€…</span>
              <span class="admin-user-role">ç®¡ç†è€…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="admin-content">
        <!-- ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ -->
        <div class="scanner-container">
          <h3 class="scanner-section-title">ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ</h3>
          <div class="form-group">
            <label for="monthSelect" class="form-label required">å¹´æœˆã‚’é¸æŠ</label>
            <select id="monthSelect" class="form-input" required>
              <option value="">å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          <div class="form-group">
            <label for="eventSelect" class="form-label required">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ</label>
            <select id="eventSelect" class="form-input" required disabled>
              <option value="">ã¾ãšå¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
        </div>

        <!-- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³çŠ¶æ³ -->
        <div id="checkinStatsContainer" class="checkin-stats" style="display: none;">
          <h3 class="scanner-section-title">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³çŠ¶æ³</h3>
          <div class="checkin-stats-grid">
            <div class="checkin-stat-item">
              <div class="checkin-stat-value" id="expectedCount">0</div>
              <div class="checkin-stat-label">å‡ºå¸­äºˆå®šè€…æ•°</div>
            </div>
            <div class="checkin-stat-item">
              <div class="checkin-stat-value success" id="checkedInCount">0</div>
              <div class="checkin-stat-label">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆ</div>
            </div>
            <div class="checkin-stat-item">
              <div class="checkin-stat-value" id="attendanceRate">0%</div>
              <div class="checkin-stat-label">å‡ºå¸­ç‡</div>
            </div>
          </div>
        </div>

        <!-- QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ -->
        <div id="scannerContainer" class="scanner-container" style="display: none;">
          <h3 class="scanner-section-title">QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h3>

          <div class="scanner-video-wrapper">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div id="scannerPlaceholder" class="scanner-placeholder">
              <div class="scanner-placeholder-icon">ğŸ“·</div>
              <p>ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</p>
            </div>
          </div>

          <div class="scanner-controls">
            <button id="startScanBtn" class="btn btn-primary btn-lg">
              ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
            </button>
            <button id="stopScanBtn" class="btn btn-outline btn-lg" style="display: none;">
              ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
            </button>
          </div>

          <!-- æ”¯æ‰•ã„ç¢ºèªUI -->
          <div id="paymentConfirmation" class="payment-confirmation">
            <div class="payment-confirmation-title">æ”¯æ‰•ã„çŠ¶æ³ã®ç¢ºèª</div>
            <p style="margin: 0 0 0.5rem 0; color: var(--text-color); font-weight: 600;">
              <span id="paymentMemberName"></span>ã•ã‚“
            </p>
            <p style="margin: 0 0 1rem 0; color: var(--text-color); font-size: 1.25rem; font-weight: bold;">
              å‚åŠ è²»: <span id="paymentAmount"></span>
            </p>
            <div style="margin-bottom: 1rem;">
              <div style="display: flex; gap: 1rem; justify-content: center;">
                <label style="display: flex; align-items: center; cursor: pointer; padding: 0.75rem 1.5rem; border: 2px solid var(--border-color); border-radius: 8px; background: white;">
                  <input type="radio" name="paymentStatus" value="paid" style="margin-right: 0.5rem;">
                  <span style="font-weight: 600;">æ”¯æ‰•ã„æ¸ˆã¿</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer; padding: 0.75rem 1.5rem; border: 2px solid var(--border-color); border-radius: 8px; background: white;">
                  <input type="radio" name="paymentStatus" value="unpaid" checked style="margin-right: 0.5rem;">
                  <span style="font-weight: 600;">æœªæ‰•ã„</span>
                </label>
              </div>
            </div>
            <button id="confirmPaymentBtn" class="btn btn-primary btn-lg" style="margin-top: 1rem; width: 100%;">
              ç¢ºå®š
            </button>
          </div>

          <!-- æ‰‹å‹•å…¥åŠ› -->
          <div class="manual-input-section">
            <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color);">
              æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
            </h4>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
              QRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚Œãªã„å ´åˆã‚„é€šä¿¡ä¸è‰¯ã®å ´åˆã¯ã€ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦æ‰‹å‹•ã§ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </p>
            <div class="manual-input-row">
              <div class="form-group">
                <label for="manualMemberSelect" class="form-label">ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ</label>
                <select
                  id="manualMemberSelect"
                  class="form-input"
                >
                  <option value="">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ...</option>
                </select>
              </div>
              <button id="manualCheckinBtn" class="btn btn-primary btn-lg">
                ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
              </button>
            </div>
          </div>
        </div>

        <!-- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å±¥æ­´ -->
        <div id="checkinHistoryContainer" class="checkin-history" style="display: none;">
          <h3 class="checkin-history-title">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å±¥æ­´</h3>
          <div class="checkin-history-list" id="checkinHistoryList">
            <div class="checkin-history-empty">
              <div class="checkin-history-empty-icon">ğŸ“‹</div>
              <p class="checkin-history-empty-text">ã¾ã ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- JavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    let currentEventId = null;
    let videoStream = null;
    let scanningInterval = null;
    let pendingPaymentMemberId = null;
    let membersList = [];
    const userInfo = Auth.getUserInfo();

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      Auth.requireAdmin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã¨ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
      await Promise.all([
        loadEvents(),
        loadMembers()
      ]);

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // å…¨ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    let allEvents = [];

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
    async function loadEvents() {
      Utils.showLoading();

      try {
        const result = await API.call('getEvents');

        if (result.success && result.events) {
          allEvents = result.events;

          // å¹´æœˆãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
          populateMonthSelector();
        }

      } catch (error) {
        console.error('Load events error:', error);
        showToast('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      } finally {
        Utils.hideLoading();
      }
    }

    // å¹´æœˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ç”Ÿæˆ
    function populateMonthSelector() {
      const monthSelect = document.getElementById('monthSelect');
      monthSelect.innerHTML = '<option value="">å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

      // ã‚¤ãƒ™ãƒ³ãƒˆã®å¹´æœˆã‚’æŠ½å‡ºã—ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
      const monthsSet = new Set();

      allEvents.forEach(event => {
        const eventDate = new Date(event.date);
        const yearMonth = `${eventDate.getFullYear()}-${String(eventDate.getMonth() + 1).padStart(2, '0')}`;
        monthsSet.add(yearMonth);
      });

      // å¹´æœˆã‚’é…åˆ—ã«å¤‰æ›ã—ã¦ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
      const months = Array.from(monthsSet).sort((a, b) => b.localeCompare(a));

      // ç¾åœ¨ã®å¹´æœˆã‚’å–å¾—
      const today = new Date();
      const currentYearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      months.forEach(yearMonth => {
        const option = document.createElement('option');
        option.value = yearMonth;

        const [year, month] = yearMonth.split('-');
        option.textContent = `${year}å¹´${parseInt(month)}æœˆ`;

        monthSelect.appendChild(option);

        // ç¾åœ¨ã®æœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
        if (yearMonth === currentYearMonth) {
          option.selected = true;
        }
      });

      // ç¾åœ¨ã®æœˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã€è‡ªå‹•çš„ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€
      if (monthSelect.value) {
        filterEventsByMonth(monthSelect.value);
      }
    }

    // å¹´æœˆã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterEventsByMonth(yearMonth) {
      const eventSelect = document.getElementById('eventSelect');
      eventSelect.innerHTML = '<option value="">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      eventSelect.disabled = false;

      if (!yearMonth) {
        eventSelect.disabled = true;
        eventSelect.innerHTML = '<option value="">ã¾ãšå¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        return;
      }

      // é¸æŠã•ã‚ŒãŸå¹´æœˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const filteredEvents = allEvents.filter(event => {
        const eventDate = new Date(event.date);
        const eventYearMonth = `${eventDate.getFullYear()}-${String(eventDate.getMonth() + 1).padStart(2, '0')}`;
        return eventYearMonth === yearMonth;
      });

      // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
      filteredEvents.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA;
      });

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      filteredEvents.forEach(event => {
        const option = document.createElement('option');
        option.value = event.event_id;
        option.textContent = `${event.title} (${event.date})`;
        eventSelect.appendChild(option);
      });

      if (filteredEvents.length === 0) {
        showToast('é¸æŠã•ã‚ŒãŸå¹´æœˆã«ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
      }
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
    async function loadMembers() {
      try {
        const result = await API.call('getMembers');

        if (result.success && result.members) {
          membersList = result.members;

          const select = document.getElementById('manualMemberSelect');
          select.innerHTML = '<option value="">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ...</option>';

          // åå‰é †ã«ã‚½ãƒ¼ãƒˆ
          membersList.sort((a, b) => a.name.localeCompare(b.name, 'ja'));

          membersList.forEach(member => {
            const option = document.createElement('option');
            option.value = member.member_id;
            option.textContent = `${member.name}${member.affiliation ? ` (${member.affiliation})` : ''}`;
            select.appendChild(option);
          });
        }

      } catch (error) {
        console.error('Load members error:', error);
        showToast('ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠæ™‚ã®å‡¦ç†
    async function onEventSelected() {
      currentEventId = document.getElementById('eventSelect').value;

      if (!currentEventId) {
        // ã‚¤ãƒ™ãƒ³ãƒˆæœªé¸æŠæ™‚ã¯éè¡¨ç¤º
        document.getElementById('scannerContainer').style.display = 'none';
        document.getElementById('checkinStatsContainer').style.display = 'none';
        document.getElementById('checkinHistoryContainer').style.display = 'none';
        return;
      }

      // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã¨å±¥æ­´ã‚’è¡¨ç¤º
      document.getElementById('scannerContainer').style.display = 'block';
      document.getElementById('checkinStatsContainer').style.display = 'block';
      document.getElementById('checkinHistoryContainer').style.display = 'block';

      // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
      await loadCheckinList();
    }

    // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸€è¦§èª­ã¿è¾¼ã¿
    async function loadCheckinList() {
      if (!currentEventId) return;

      Utils.showLoading();

      try {
        const result = await API.call('getCheckinList', {
          event_id: currentEventId
        });

        if (result.success) {
          // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
          updateCheckinStats(result);

          // å±¥æ­´ã‚’è¡¨ç¤º
          displayCheckinHistory(result.checkins || []);

          // æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã‚’é™¤å¤–ï¼‰
          updateManualMemberSelect(result.checkins || []);
        }

      } catch (error) {
        console.error('Load checkin list error:', error);
        showToast('ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      } finally {
        Utils.hideLoading();
      }
    }

    // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³çµ±è¨ˆã‚’æ›´æ–°
    function updateCheckinStats(data) {
      const expectedCount = data.expected_count || 0;
      const checkedInCount = data.checked_in_count || 0;
      const attendanceRate = expectedCount > 0
        ? Math.round((checkedInCount / expectedCount) * 100)
        : 0;

      document.getElementById('expectedCount').textContent = expectedCount;
      document.getElementById('checkedInCount').textContent = checkedInCount;
      document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
    }

    // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å±¥æ­´ã‚’è¡¨ç¤º
    function displayCheckinHistory(checkins) {
      const container = document.getElementById('checkinHistoryList');

      if (!checkins || checkins.length === 0) {
        container.innerHTML = `
          <div class="checkin-history-empty">
            <div class="checkin-history-empty-icon">ğŸ“‹</div>
            <p class="checkin-history-empty-text">ã¾ã ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        `;
        return;
      }

      // æœ€æ–°é †ã«ã‚½ãƒ¼ãƒˆ
      checkins.sort((a, b) => new Date(b.checkin_time) - new Date(a.checkin_time));

      container.innerHTML = checkins.map(checkin => {
        const time = new Date(checkin.checkin_time);
        const timeStr = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;

        let badge = '';
        if (checkin.payment_method === 'ç¾åœ°æ‰•ã„') {
          if (checkin.paid) {
            badge = '<span class="checkin-history-badge paid">æ”¯æ‰•ã„æ¸ˆ</span>';
          } else {
            badge = '<span class="checkin-history-badge unpaid">æœªæ‰•ã„</span>';
          }
        }

        return `
          <div class="checkin-history-item">
            <div class="checkin-history-info">
              <div class="checkin-history-name">${checkin.member_name}</div>
              <div class="checkin-history-time">${timeStr}</div>
            </div>
            ${badge}
          </div>
        `;
      }).join('');
    }

    // æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ç”¨ã®ãƒ¡ãƒ³ãƒãƒ¼é¸æŠã‚’æ›´æ–°ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã‚’é™¤å¤–ï¼‰
    function updateManualMemberSelect(checkins) {
      const select = document.getElementById('manualMemberSelect');

      if (!membersList || membersList.length === 0) {
        return;
      }

      // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ¡ãƒ³ãƒãƒ¼IDã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
      const checkedInMemberIds = new Set(checkins.map(c => c.member_id));

      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å†æ§‹ç¯‰
      select.innerHTML = '<option value="">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ...</option>';

      // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã§ãªã„ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ã‚’è¡¨ç¤º
      const availableMembers = membersList.filter(member => !checkedInMemberIds.has(member.member_id));

      // åå‰é †ã«ã‚½ãƒ¼ãƒˆ
      availableMembers.sort((a, b) => a.name.localeCompare(b.name, 'ja'));

      availableMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member.member_id;
        option.textContent = `${member.name}${member.affiliation ? ` (${member.affiliation})` : ''}`;
        select.appendChild(option);
      });

      // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã§ãªã„ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ãªã„å ´åˆ
      if (availableMembers.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'å…¨å“¡ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã§ã™';
        select.appendChild(option);
        select.disabled = true;
      } else {
        select.disabled = false;
      }
    }

    // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
    function startQRScanner() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const placeholder = document.getElementById('scannerPlaceholder');

      navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
      })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.play();

          // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’éè¡¨ç¤º
          placeholder.style.display = 'none';

          // ãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ
          document.getElementById('startScanBtn').style.display = 'none';
          document.getElementById('stopScanBtn').style.display = 'inline-block';

          // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
          scanQR();

          showToast('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¾ã—ãŸ', 'success');
        })
        .catch(error => {
          console.error('Camera error:', error);
          showToast('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã®æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
        });
    }

    // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†
    function scanQR() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      function scan() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);

          if (code && code.data) {
            const memberId = code.data;
            console.log('QR Code detected:', memberId);

            // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‡¦ç†
            checkin(memberId);

            // ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢
            stopQRScanner();
            return;
          }
        }
        scanningInterval = requestAnimationFrame(scan);
      }

      scan();
    }

    // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢
    function stopQRScanner() {
      const video = document.getElementById('video');
      const placeholder = document.getElementById('scannerPlaceholder');

      // ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢
      if (scanningInterval) {
        cancelAnimationFrame(scanningInterval);
        scanningInterval = null;
      }

      // ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }

      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
      placeholder.style.display = 'flex';

      // ãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('startScanBtn').style.display = 'inline-block';
      document.getElementById('stopScanBtn').style.display = 'none';
    }

    // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‡¦ç†
    async function checkin(memberId) {
      if (!currentEventId) {
        showToast('ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (!memberId || !memberId.trim()) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼IDãŒç„¡åŠ¹ã§ã™', 'error');
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('checkin', {
          event_id: currentEventId,
          member_id: memberId.trim()
        });

        if (result.success) {
          // ç™»éŒ²æ–™ãŒã‚ã‚‹å ´åˆã€æ”¯æ‰•ã„ç¢ºèªUIã‚’è¡¨ç¤º
          if (result.has_fee) {
            showPaymentConfirmation(memberId, result.member_name, result.fee_amount, result.paid);
          } else {
            showToast(`${result.member_name}ã•ã‚“ ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†`, 'success');
          }

          // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
          await loadCheckinList();

          // æ‰‹å‹•é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
          document.getElementById('manualMemberSelect').value = '';

        } else {
          throw new Error(result.message || 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Checkin error:', error);
        showToast(error.message || 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      } finally {
        Utils.hideLoading();
      }
    }

    // æ”¯æ‰•ã„ç¢ºèªUIè¡¨ç¤º
    function showPaymentConfirmation(memberId, memberName, feeAmount, currentPaidStatus) {
      pendingPaymentMemberId = memberId;
      document.getElementById('paymentMemberName').textContent = memberName;

      // é‡‘é¡ã‚’è¡¨ç¤º
      const formattedAmount = 'Â¥' + Number(feeAmount).toLocaleString('ja-JP');
      document.getElementById('paymentAmount').textContent = formattedAmount;

      // æ—¢å­˜ã®æ”¯æ‰•ã„çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
      if (currentPaidStatus) {
        document.querySelector('input[name="paymentStatus"][value="paid"]').checked = true;
      } else {
        document.querySelector('input[name="paymentStatus"][value="unpaid"]').checked = true;
      }

      document.getElementById('paymentConfirmation').classList.add('show');
    }

    // æ”¯æ‰•ã„ç¢ºèªç™»éŒ²
    async function confirmPayment() {
      const paymentStatus = document.querySelector('input[name="paymentStatus"]:checked').value;
      const isPaid = paymentStatus === 'paid';

      if (!pendingPaymentMemberId) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('checkinWithPayment', {
          event_id: currentEventId,
          member_id: pendingPaymentMemberId,
          payment_confirmed: isPaid
        });

        if (result.success) {
          showToast(isPaid ? 'æ”¯æ‰•ã„æ¸ˆã¿ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ' : 'æœªæ‰•ã„ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ', 'success');

          // æ”¯æ‰•ã„ç¢ºèªUIã‚’éè¡¨ç¤º
          document.getElementById('paymentConfirmation').classList.remove('show');
          pendingPaymentMemberId = null;

          // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
          await loadCheckinList();

        } else {
          throw new Error(result.message || 'æ”¯æ‰•ã„ç¢ºèªã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Payment confirmation error:', error);
        showToast(error.message || 'æ”¯æ‰•ã„ç¢ºèªã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      } finally {
        Utils.hideLoading();
      }
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
      document.getElementById('mobileToggle').addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.toggle('mobile-open');
      });

      // å¹´æœˆé¸æŠ
      document.getElementById('monthSelect').addEventListener('change', (e) => {
        filterEventsByMonth(e.target.value);
        // ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('eventSelect').value = '';
        // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã¨å±¥æ­´ã‚’éè¡¨ç¤º
        document.getElementById('scannerContainer').style.display = 'none';
        document.getElementById('checkinStatsContainer').style.display = 'none';
        document.getElementById('checkinHistoryContainer').style.display = 'none';
      });

      // ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ
      document.getElementById('eventSelect').addEventListener('change', onEventSelected);

      // QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼
      document.getElementById('startScanBtn').addEventListener('click', startQRScanner);
      document.getElementById('stopScanBtn').addEventListener('click', stopQRScanner);

      // æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
      document.getElementById('manualCheckinBtn').addEventListener('click', () => {
        const memberId = document.getElementById('manualMemberSelect').value;
        if (!memberId) {
          showToast('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
          return;
        }
        checkin(memberId);
      });

      // æ”¯æ‰•ã„ç¢ºèª
      document.getElementById('confirmPaymentBtn').addEventListener('click', confirmPayment);
    }

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
    window.addEventListener('beforeunload', () => {
      stopQRScanner();
    });
  </script>
</body>
</html>
