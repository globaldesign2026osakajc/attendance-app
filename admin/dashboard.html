<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="admin-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h1 class="admin-sidebar-title">ç®¡ç†è€…ç”»é¢</h1>
        <p class="admin-sidebar-subtitle">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <nav class="admin-sidebar-nav">
        <a href="dashboard.html" class="admin-sidebar-item active">
          <span class="admin-sidebar-icon">ğŸ“Š</span>
          <span class="admin-sidebar-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
        <a href="events.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“…</span>
          <span class="admin-sidebar-text">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</span>
        </a>
        <a href="members.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ‘¥</span>
          <span class="admin-sidebar-text">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
        </a>
        <a href="analytics.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“ˆ</span>
          <span class="admin-sidebar-text">å‡ºå¸­ç‡åˆ†æ</span>
        </a>
        <a href="payments.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ’°</span>
          <span class="admin-sidebar-text">æ”¯æ‰•ã„ç®¡ç†</span>
        </a>
        <a href="checkin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“±</span>
          <span class="admin-sidebar-text">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
        </a>
        <a href="receipts-admin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ§¾</span>
          <span class="admin-sidebar-text">é ˜åæ›¸ç®¡ç†</span>
        </a>

        <div class="admin-sidebar-divider"></div>

        <a href="../home.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ </span>
          <span class="admin-sidebar-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸</span>
        </a>
      </nav>

      <div class="admin-sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block" style="color: white; border-color: rgba(255,255,255,0.3);">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-main">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="admin-topbar">
        <button class="admin-mobile-toggle" id="mobileToggle">
          â˜°
        </button>
        <h2 class="admin-topbar-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
        <div class="admin-topbar-actions">
          <div class="admin-user-info">
            <span class="admin-user-icon">ğŸ‘¤</span>
            <div class="admin-user-details">
              <span class="admin-user-name" id="userName">ç®¡ç†è€…</span>
              <span class="admin-user-role">ç®¡ç†è€…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="admin-content">
        <!-- æœ€é‡è¦æŒ‡æ¨™ã‚«ãƒ¼ãƒ‰ -->
        <div class="stats-grid">
          <div class="stat-card" onclick="location.href='payments.html'" style="cursor: pointer;">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-value" id="unpaidCount">0</div>
                <div class="stat-card-label">æœªæ‰•ã„ä»¶æ•°</div>
              </div>
              <div class="stat-card-icon danger">
                âš ï¸
              </div>
            </div>
            <div class="stat-card-change" id="unpaidAmount">
              é‡‘é¡: Â¥0
            </div>
          </div>

          <div class="stat-card" id="nextEventCard" onclick="handleNextEventClick()" style="cursor: pointer;">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-value" id="nextEventDays">-</div>
                <div class="stat-card-label">ç›´è¿‘ã‚¤ãƒ™ãƒ³ãƒˆ</div>
              </div>
              <div class="stat-card-icon primary">
                ğŸ“…
              </div>
            </div>
            <div class="stat-card-change" id="nextEventTitle">
              ã‚¤ãƒ™ãƒ³ãƒˆãªã—
            </div>
          </div>

          <div class="stat-card" id="pendingCard" onclick="handlePendingClick()" style="cursor: pointer;">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-value" id="pendingCount">0</div>
                <div class="stat-card-label">å‡ºæ¬ æœªç™»éŒ²</div>
              </div>
              <div class="stat-card-icon warning">
                â°
              </div>
            </div>
            <div class="stat-card-change" id="pendingEvent">
              ç›´è¿‘ã‚¤ãƒ™ãƒ³ãƒˆå¯¾è±¡
            </div>
          </div>

          <div class="stat-card" onclick="location.href='payments.html#cancellation'" style="cursor: pointer;">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-value" id="cancellationCount">0</div>
                <div class="stat-card-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™</div>
              </div>
              <div class="stat-card-icon danger">
                ğŸ’°
              </div>
            </div>
            <div class="stat-card-change" id="cancellationAmount">
              é‡‘é¡: Â¥0
            </div>
          </div>
        </div>

        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
        <div id="alertsContainer"></div>

        <!-- ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ -->
        <div class="admin-card" style="margin-bottom: 2rem;">
          <div class="admin-card-header">
            <h3 class="admin-card-title">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</h3>
            <span id="taskCount" class="badge badge-primary">0ä»¶</span>
          </div>
          <div class="admin-card-body">
            <div id="tasksContainer"></div>
          </div>
        </div>

        <!-- ä»Šæœˆã®çµ±è¨ˆ -->
        <div class="admin-card" style="margin-bottom: 2rem;">
          <div class="admin-card-header">
            <h3 class="admin-card-title">ä»Šæœˆã®çµ±è¨ˆ</h3>
          </div>
          <div class="admin-card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; text-align: center;">
              <div>
                <div style="font-size: 2rem; font-weight: 600; color: var(--primary-color);" id="monthlyEvents">0</div>
                <div style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem;">ã‚¤ãƒ™ãƒ³ãƒˆæ•°</div>
              </div>
              <div>
                <div style="font-size: 2rem; font-weight: 600; color: var(--success-color);" id="monthlyAttendanceRate">0%</div>
                <div style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem;">å‡ºå¸­ç‡</div>
              </div>
              <div>
                <div style="font-size: 2rem; font-weight: 600; color: var(--info-color);" id="monthlyRevenue">Â¥0</div>
                <div style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem;">å£²ä¸Š</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
          <!-- ä»Šé€±ã®ã‚¤ãƒ™ãƒ³ãƒˆ -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">ä»Šé€±ã®ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
              <a href="events.html" class="btn btn-sm btn-outline">ã™ã¹ã¦è¦‹ã‚‹</a>
            </div>
            <div class="admin-card-body">
              <div id="upcomingEvents"></div>
            </div>
          </div>

          <!-- æ”¯æ‰•ã„çŠ¶æ³ -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">æ”¯æ‰•ã„çŠ¶æ³</h3>
              <a href="payments.html" class="btn btn-sm btn-outline">ã™ã¹ã¦è¦‹ã‚‹</a>
            </div>
            <div class="admin-card-body">
              <div id="paymentSummary"></div>
            </div>
          </div>
        </div>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
          </div>
          <div class="admin-card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <button class="btn btn-primary btn-block" onclick="location.href='events.html?action=create'" style="padding: 1.5rem; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <span style="font-size: 2rem;">ğŸ“…</span>
                <span>æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²</span>
              </button>
              <button class="btn btn-success btn-block" onclick="location.href='members.html'" style="padding: 1.5rem; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <span style="font-size: 2rem;">ğŸ‘¥</span>
                <span>ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
              </button>
              <button class="btn btn-warning btn-block" onclick="location.href='checkin.html'" style="padding: 1.5rem; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <span style="font-size: 2rem;">ğŸ“±</span>
                <span>QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
              </button>
              <button class="btn btn-info btn-block" onclick="location.href='analytics.html'" style="padding: 1.5rem; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <span style="font-size: 2rem;">ğŸ“ˆ</span>
                <span>å‡ºå¸­ç‡åˆ†æ</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    const userInfo = Auth.getUserInfo();
    let dashboardData = null;
    let nextEventId = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      Auth.requireAdmin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—
      await loadDashboardData();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ1ã¤ã®APIã§å…¨ã¦å–å¾—ï¼‰
    async function loadDashboardData() {
      Utils.showLoading();

      try {
        const result = await API.call('getDashboardSummary', {});

        if (!result.success) {
          throw new Error(result.error || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        dashboardData = result;

        // å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ®µéšçš„ã«è¡¨ç¤º
        updateKeyMetrics(result.key_metrics);
        displayAlerts(result.alerts || []);
        displayTasks(result.tasks || []);
        updateMonthlyStats(result.monthly_stats);
        displayUpcomingEvents(result.upcoming_events || []);
        displayPaymentSummary(result.payment_summary);

      } catch (error) {
        console.error('Load dashboard error:', error);
        Utils.showError('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        Utils.hideLoading();
      }
    }

    // æœ€é‡è¦æŒ‡æ¨™ã‚’æ›´æ–°
    function updateKeyMetrics(metrics) {
      // æœªæ‰•ã„ä»¶æ•°
      document.getElementById('unpaidCount').textContent = metrics.unpaid_count || 0;
      document.getElementById('unpaidAmount').textContent =
        'é‡‘é¡: Â¥' + (metrics.unpaid_amount || 0).toLocaleString();

      // ç›´è¿‘ã‚¤ãƒ™ãƒ³ãƒˆ
      if (metrics.next_event) {
        const event = metrics.next_event;
        nextEventId = event.event_id;

        let daysText = '';
        if (event.days_until === 0) {
          daysText = 'æœ¬æ—¥';
        } else if (event.days_until === 1) {
          daysText = 'æ˜æ—¥';
        } else {
          daysText = event.days_until + 'æ—¥å¾Œ';
        }

        document.getElementById('nextEventDays').textContent = daysText;
        document.getElementById('nextEventTitle').textContent =
          event.title + ' (' + Utils.formatDateSlash(event.date) + ')';
      } else {
        nextEventId = null;
        document.getElementById('nextEventDays').textContent = '-';
        document.getElementById('nextEventTitle').textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆãªã—';
      }

      // å‡ºæ¬ æœªç™»éŒ²è€…æ•°
      document.getElementById('pendingCount').textContent = metrics.pending_registrations || 0;
      if (metrics.next_event) {
        document.getElementById('pendingEvent').textContent = metrics.next_event.title + 'ã®æœªç™»éŒ²';
      }

      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™
      document.getElementById('cancellationCount').textContent = metrics.cancellation_fee_count || 0;
      document.getElementById('cancellationAmount').textContent =
        'é‡‘é¡: Â¥' + (metrics.cancellation_fee_amount || 0).toLocaleString();
    }

    // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    function handleNextEventClick() {
      if (nextEventId) {
        location.href = 'events.html?id=' + nextEventId;
      }
    }

    function handlePendingClick() {
      if (nextEventId) {
        location.href = 'events.html?id=' + nextEventId + '#unregistered';
      }
    }
    window.handleNextEventClick = handleNextEventClick;
    window.handlePendingClick = handlePendingClick;

    // ä»Šé€±ã®ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º
    function displayUpcomingEvents(events) {
      const container = document.getElementById('upcomingEvents');

      if (events.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">ä»Šé€±ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      container.innerHTML = events.map(event => {
        const eventDate = Utils.formatDateSlash(event.date);
        const dayOfWeek = Utils.getDayOfWeek(event.date);
        const attendCount = event.attend_count || 0;
        const pendingCount = event.pending_count || 0;

        return `
          <div style="padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer;"
               onclick="location.href='events.html?id=${event.event_id}'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <div style="font-weight: 600; color: var(--text-color);">${Utils.escapeHtml(event.title)}</div>
            </div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
              ${eventDate}ï¼ˆ${dayOfWeek}ï¼‰ã€€å‡ºå¸­: ${attendCount}å / æœªç™»éŒ²: ${pendingCount}å
            </div>
          </div>
        `;
      }).join('');
    }

    // ã‚¿ã‚¹ã‚¯è¡¨ç¤º
    function displayTasks(tasks) {
      const container = document.getElementById('tasksContainer');
      const countBadge = document.getElementById('taskCount');

      countBadge.textContent = tasks.length + 'ä»¶';

      if (tasks.length === 0) {
        container.innerHTML = '<p style="color: var(--success-color); text-align: center; padding: 2rem;">âœ“ ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      container.innerHTML = tasks.map(task => {
        let icon = 'ğŸ“‹';
        if (task.type === 'reminder') icon = 'ğŸ””';
        if (task.type === 'checkin') icon = 'ğŸ“±';
        if (task.type === 'payment') icon = 'ğŸ’°';

        let priorityClass = 'info';
        if (task.priority === 'high') priorityClass = 'danger';
        if (task.priority === 'medium') priorityClass = 'warning';

        let actionButton = '';
        if (task.action === 'copy_reminder') {
          actionButton = `
            <button class="btn btn-sm btn-${priorityClass}"
                    onclick="copyReminderMessage('${task.id}', event)"
                    style="margin-right: 0.5rem;">
              ğŸ“‹ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼
            </button>
            <button class="btn btn-sm btn-outline" onclick="markTaskComplete('${task.id}', event)">
              å®Œäº†
            </button>
          `;
        } else if (task.action_url) {
          actionButton = `
            <button class="btn btn-sm btn-${priorityClass}" onclick="location.href='${task.action_url}'">
              é–‹ã
            </button>
          `;
        }

        return `
          <div class="task-item" data-task-id="${task.id}"
               style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--${priorityClass}-color);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.25rem;">
                  ${icon} ${Utils.escapeHtml(task.title)}
                </div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                  ${Utils.escapeHtml(task.description)}
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
              ${actionButton}
            </div>
          </div>
        `;
      }).join('');
    }

    // ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼
    function copyReminderMessage(taskId, event) {
      event.stopPropagation();

      const task = dashboardData.tasks.find(t => t.id === taskId);
      if (!task || !task.message_template) {
        Utils.showError('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      navigator.clipboard.writeText(task.message_template).then(() => {
        Utils.showSuccess('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nLINEã«è²¼ã‚Šä»˜ã‘ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
      }).catch(err => {
        console.error('Copy failed:', err);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã§è¡¨ç¤º
        const textarea = document.createElement('textarea');
        textarea.value = task.message_template;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        Utils.showSuccess('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      });
    }

    // ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹
    function markTaskComplete(taskId, event) {
      event.stopPropagation();

      if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ')) {
        const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
        if (taskElement) {
          taskElement.style.opacity = '0.5';
          taskElement.style.textDecoration = 'line-through';
          setTimeout(() => {
            taskElement.remove();
            // ã‚¿ã‚¹ã‚¯æ•°ã‚’æ›´æ–°
            const remaining = document.querySelectorAll('.task-item').length;
            document.getElementById('taskCount').textContent = remaining + 'ä»¶';
            if (remaining === 0) {
              document.getElementById('tasksContainer').innerHTML =
                '<p style="color: var(--success-color); text-align: center; padding: 2rem;">âœ“ ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            }
          }, 300);
        }
      }
    }

    window.copyReminderMessage = copyReminderMessage;
    window.markTaskComplete = markTaskComplete;

    // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function displayAlerts(alerts) {
      const container = document.getElementById('alertsContainer');

      if (!alerts || alerts.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = `
        <div style="margin-bottom: 2rem;">
          ${alerts.map(alert => {
            const typeClass = alert.type || 'info';
            const icon = {
              danger: 'ğŸ”´',
              warning: 'ğŸŸ¡',
              info: 'â„¹ï¸',
              success: 'âœ“'
            }[typeClass] || 'â„¹ï¸';

            const actionButton = alert.action_url ? `
              <button class="btn btn-sm btn-${typeClass}" onclick="location.href='${alert.action_url}'" style="margin-top: 0.5rem;">
                è©³ç´°ã‚’è¦‹ã‚‹
              </button>
            ` : '';

            return `
              <div class="admin-alert ${typeClass}" style="margin-bottom: 1rem; padding: 1rem; border-left: 4px solid var(--${typeClass}-color); background: var(--card-background); border-radius: 4px;">
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                  <div style="font-size: 1.5rem;">${icon}</div>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.25rem;">
                      ${Utils.escapeHtml(alert.title)}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                      ${Utils.escapeHtml(alert.message)}
                    </div>
                    ${actionButton}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // ä»Šæœˆã®çµ±è¨ˆã‚’æ›´æ–°
    function updateMonthlyStats(stats) {
      document.getElementById('monthlyEvents').textContent = stats.event_count || 0;
      document.getElementById('monthlyAttendanceRate').textContent = (stats.attendance_rate || 0) + '%';
      document.getElementById('monthlyRevenue').textContent = 'Â¥' + (stats.revenue || 0).toLocaleString();
    }

    // æ”¯æ‰•ã„çŠ¶æ³ã‚µãƒãƒªãƒ¼è¡¨ç¤º
    function displayPaymentSummary(summary) {
      const container = document.getElementById('paymentSummary');

      container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;"
               onclick="location.href='payments.html'">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">æœªæ‰•ã„</div>
                <div style="font-size: 1.5rem; font-weight: 600; color: var(--danger-color);">
                  ${summary.unpaid.count}ä»¶
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--danger-color);">
                  Â¥${summary.unpaid.amount.toLocaleString()}
                </div>
              </div>
            </div>
          </div>

          <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;"
               onclick="location.href='payments.html#paid'">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">æ”¯æ‰•æ¸ˆ</div>
                <div style="font-size: 1.5rem; font-weight: 600; color: var(--success-color);">
                  ${summary.paid.count}ä»¶
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--success-color);">
                  Â¥${summary.paid.amount.toLocaleString()}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }


    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
      document.getElementById('mobileToggle').addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.toggle('mobile-open');
      });

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('adminSidebar');
        const toggle = document.getElementById('mobileToggle');

        if (window.innerWidth <= 1024 &&
            sidebar.classList.contains('mobile-open') &&
            !sidebar.contains(e.target) &&
            !toggle.contains(e.target)) {
          sidebar.classList.remove('mobile-open');
        }
      });
    }
  </script>
</body>
</html>
