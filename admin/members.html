<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç† - ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/admin.css">
  <style>
    /* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ */
    .search-filter-bar {
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .search-filter-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
      gap: 1rem;
      align-items: end;
    }

    /* ãƒ¡ãƒ³ãƒãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« */
    .member-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background-color: var(--bg-gray);
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .member-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .member-kana {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }

    .modal-grid-full {
      grid-column: 1 / -1;
    }

    .photo-upload-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem;
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .photo-upload-area:hover {
      border-color: var(--primary-color);
      background-color: var(--bg-secondary);
    }

    .photo-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      background-color: var(--bg-gray);
      border: 3px solid var(--border-color);
    }

    .photo-upload-text {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    #photoFileInput {
      display: none;
    }

    @media (max-width: 1200px) {
      .search-filter-row {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .search-filter-row {
        grid-template-columns: 1fr;
      }

      .modal-grid {
        grid-template-columns: 1fr;
      }

      .data-table {
        min-width: 800px;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="admin-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h1 class="admin-sidebar-title">ç®¡ç†è€…ç”»é¢</h1>
        <p class="admin-sidebar-subtitle">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <nav class="admin-sidebar-nav">
        <a href="dashboard.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“Š</span>
          <span class="admin-sidebar-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
        <a href="events.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“…</span>
          <span class="admin-sidebar-text">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</span>
        </a>
        <a href="members.html" class="admin-sidebar-item active">
          <span class="admin-sidebar-icon">ğŸ‘¥</span>
          <span class="admin-sidebar-text">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
        </a>
        <a href="analytics.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“ˆ</span>
          <span class="admin-sidebar-text">å‡ºå¸­ç‡åˆ†æ</span>
        </a>
        <a href="payments.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ’°</span>
          <span class="admin-sidebar-text">æ”¯æ‰•ã„ç®¡ç†</span>
        </a>
        <a href="checkin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“±</span>
          <span class="admin-sidebar-text">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
        </a>
        <a href="receipts-admin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ§¾</span>
          <span class="admin-sidebar-text">é ˜åæ›¸ç®¡ç†</span>
        </a>

        <div class="admin-sidebar-divider"></div>

        <a href="../home.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ </span>
          <span class="admin-sidebar-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸</span>
        </a>
      </nav>

      <div class="admin-sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block" style="color: white; border-color: rgba(255,255,255,0.3);">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-main">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="admin-topbar">
        <button class="admin-mobile-toggle" id="mobileToggle">
          â˜°
        </button>
        <h2 class="admin-topbar-title">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h2>
        <div class="admin-topbar-actions">
          <div class="admin-user-info">
            <span class="admin-user-icon">ğŸ‘¤</span>
            <div class="admin-user-details">
              <span class="admin-user-name" id="userName">ç®¡ç†è€…</span>
              <span class="admin-user-role">ç®¡ç†è€…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="admin-content">
        <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="search-filter-bar">
          <div class="search-filter-row">
            <div class="form-group" style="margin-bottom: 0;">
              <label for="searchInput" class="form-label">æ¤œç´¢</label>
              <input
                type="text"
                id="searchInput"
                class="form-input"
                placeholder="åå‰ã€ãµã‚ŠãŒãªã€ãƒ­ã‚°ã‚¤ãƒ³IDã§æ¤œç´¢..."
              >
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="filterAffiliation" class="form-label">æ‰€å±</label>
              <select id="filterAffiliation" class="form-input">
                <option value="">ã™ã¹ã¦</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="filterPosition" class="form-label">å½¹è·</label>
              <select id="filterPosition" class="form-input">
                <option value="">ã™ã¹ã¦</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="filterBirthMonth" class="form-label">èª•ç”Ÿæœˆ</label>
              <select id="filterBirthMonth" class="form-input">
                <option value="">ã™ã¹ã¦</option>
                <option value="1">1æœˆ</option>
                <option value="2">2æœˆ</option>
                <option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option>
                <option value="5">5æœˆ</option>
                <option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option>
                <option value="8">8æœˆ</option>
                <option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option>
                <option value="12">12æœˆ</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="filterRole" class="form-label">æ¨©é™</label>
              <select id="filterRole" class="form-input">
                <option value="">ã™ã¹ã¦</option>
                <option value="staff">ã‚¹ã‚¿ãƒƒãƒ•</option>
                <option value="member">ãƒ¡ãƒ³ãƒãƒ¼</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="data-table-container">
          <div class="data-table-header">
            <h3 class="data-table-title">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</h3>
            <div class="data-table-actions">
              <button class="btn btn-primary" id="addMemberBtn">
                + æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²
              </button>
            </div>
          </div>

          <div style="overflow-x: auto;">
            <table class="data-table" id="membersTable">
              <thead>
                <tr>
                  <th>å†™çœŸ</th>
                  <th>æ°å</th>
                  <th>ãƒ­ã‚°ã‚¤ãƒ³ID</th>
                  <th>æ‰€å±</th>
                  <th>å½¹è·</th>
                  <th>èª•ç”Ÿæ—¥</th>
                  <th>æ¨©é™</th>
                  <th>ç™»éŒ²æ—¥</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="membersTableBody">
                <tr>
                  <td colspan="9" class="data-table-empty">
                    <div class="data-table-empty-icon">ğŸ‘¥</div>
                    <div class="data-table-empty-text">ãƒ¡ãƒ³ãƒãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="admin-modal" id="memberModal">
    <div class="admin-modal-content">
      <div class="admin-modal-header">
        <h3 class="admin-modal-title" id="modalTitle">æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²</h3>
        <button class="admin-modal-close" id="closeModalBtn">Ã—</button>
      </div>

      <div class="admin-modal-body">
        <form id="memberForm">
          <input type="hidden" id="memberId">

          <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ -->
          <div class="form-group">
            <label class="form-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ</label>
            <div class="photo-upload-area" id="photoUploadArea">
              <img
                id="photoPreview"
                class="photo-preview"
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23f1f5f9' width='100' height='100'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%2394a3b8' font-size='40'%3EğŸ‘¤%3C/text%3E%3C/svg%3E"
                alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ"
              >
              <div class="photo-upload-text">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                <div style="font-size: 0.75rem;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠï¼ˆJPG, PNG, æœ€å¤§5MBï¼‰</div>
              </div>
              <input type="file" id="photoFileInput" accept="image/jpeg,image/png">
            </div>
          </div>

          <div class="modal-grid">
            <!-- åŸºæœ¬æƒ…å ± -->
            <div class="form-group">
              <label for="memberName" class="form-label required">æ°å</label>
              <input
                type="text"
                id="memberName"
                class="form-input"
                required
                placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ"
              >
            </div>

            <div class="form-group">
              <label for="memberKana" class="form-label">ãµã‚ŠãŒãª</label>
              <input
                type="text"
                id="memberKana"
                class="form-input"
                placeholder="ä¾‹ï¼šã‚„ã¾ã ãŸã‚ã†"
              >
            </div>

            <div class="form-group">
              <label for="memberNickname" class="form-label">ã‚ã å</label>
              <input
                type="text"
                id="memberNickname"
                class="form-input"
                placeholder="ä¾‹ï¼šãŸã‚ã¡ã‚ƒã‚“"
              >
            </div>

            <div class="form-group">
              <label for="memberLoginId" class="form-label required">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
              <input
                type="text"
                id="memberLoginId"
                class="form-input"
                required
                placeholder="ä¾‹ï¼šM001"
              >
            </div>

            <div class="form-group">
              <label for="memberPassword" class="form-label" id="passwordLabel">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <input
                type="password"
                id="memberPassword"
                class="form-input"
                placeholder="8æ–‡å­—ä»¥ä¸Š"
              >
              <small class="form-help">ç·¨é›†æ™‚ã¯å¤‰æ›´ã™ã‚‹å ´åˆã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„</small>
            </div>

            <!-- çµ„ç¹”æƒ…å ± -->
            <div class="form-group">
              <label for="memberPosition" class="form-label">å½¹è·</label>
              <select id="memberPosition" class="form-input">
                <option value="">æœªè¨­å®š</option>
              </select>
            </div>

            <div class="form-group">
              <label for="memberAffiliation" class="form-label">æ‰€å±</label>
              <select id="memberAffiliation" class="form-input">
                <option value="">æœªè¨­å®š</option>
              </select>
            </div>

            <div class="form-group">
              <label for="memberBirthday" class="form-label">èª•ç”Ÿæ—¥</label>
              <input
                type="date"
                id="memberBirthday"
                class="form-input"
              >
            </div>

            <div class="form-group">
              <label for="memberCommittee" class="form-label">å§”å“¡ä¼š</label>
              <select id="memberCommittee" class="form-input">
                <option value="">æœªè¨­å®š</option>
              </select>
            </div>

            <div class="modal-grid-full">
              <div class="form-group">
                <label for="memberComment" class="form-label">ä¸€è¨€</label>
                <textarea
                  id="memberComment"
                  class="form-input"
                  rows="2"
                  placeholder="ä¾‹ï¼šã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™"
                ></textarea>
              </div>
            </div>

            <div class="form-group">
              <label for="memberLineName" class="form-label">LINEå</label>
              <input
                type="text"
                id="memberLineName"
                class="form-input"
                placeholder="ä¾‹ï¼šãŸã‚ã†"
              >
            </div>

            <div class="form-group">
              <label for="memberJoinYear" class="form-label">å…¥ä¼šå¹´åº¦</label>
              <select id="memberJoinYear" class="form-input">
                <option value="">æœªè¨­å®š</option>
              </select>
            </div>

            <div class="form-group">
              <label for="memberSecondment" class="form-label">å‡ºå‘å…ˆ</label>
              <input
                type="text"
                id="memberSecondment"
                class="form-input"
                placeholder="ä¾‹ï¼šâ—‹â—‹éƒ¨"
              >
            </div>

            <div class="form-group">
              <label for="memberPhone" class="form-label">é›»è©±ç•ªå·</label>
              <input
                type="tel"
                id="memberPhone"
                class="form-input"
                placeholder="ä¾‹ï¼š090-1234-5678"
              >
            </div>

            <div class="form-group">
              <label for="memberCompanyName" class="form-label">ä¼šç¤¾å</label>
              <input
                type="text"
                id="memberCompanyName"
                class="form-input"
                placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«"
              >
            </div>

            <div class="form-group">
              <label for="memberIndustry" class="form-label">æ¥­ç¨®</label>
              <input
                type="text"
                id="memberIndustry"
                class="form-input"
                placeholder="ä¾‹ï¼šIT"
              >
            </div>

            <div class="form-group">
              <label for="memberAllergy" class="form-label">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
              <input
                type="text"
                id="memberAllergy"
                class="form-input"
                placeholder="ä¾‹ï¼šåµã€ãã°"
              >
            </div>

            <div class="form-group">
              <label for="memberFavorite" class="form-label">å¥½ããªã‚‚ã®</label>
              <input
                type="text"
                id="memberFavorite"
                class="form-input"
                placeholder="ä¾‹ï¼šæ—…è¡Œã€èª­æ›¸"
              >
            </div>

            <div class="form-group">
              <label for="memberDislike" class="form-label">å«Œã„ãªã‚‚ã®</label>
              <input
                type="text"
                id="memberDislike"
                class="form-input"
                placeholder="ä¾‹ï¼šè™«"
              >
            </div>

            <div class="form-group">
              <label for="memberFavoriteCountry" class="form-label">å¥½ããªå›½</label>
              <input
                type="text"
                id="memberFavoriteCountry"
                class="form-input"
                placeholder="ä¾‹ï¼šæ—¥æœ¬ã€ã‚¤ã‚¿ãƒªã‚¢"
              >
            </div>

            <div class="modal-grid-full">
              <div class="form-group">
                <label for="memberFavoriteWord" class="form-label">å¥½ããªè¨€è‘‰</label>
                <input
                  type="text"
                  id="memberFavoriteWord"
                  class="form-input"
                  placeholder="ä¾‹ï¼šä¸€æœŸä¸€ä¼š"
                >
              </div>
            </div>

            <div class="form-group">
              <label for="memberRole" class="form-label required">æ¨©é™</label>
              <select id="memberRole" class="form-input" required>
                <option value="member">ãƒ¡ãƒ³ãƒãƒ¼</option>
                <option value="staff">ã‚¹ã‚¿ãƒƒãƒ•</option>
              </select>
            </div>
          </div>
        </form>
      </div>

      <div class="admin-modal-footer">
        <button type="button" class="btn btn-outline" id="cancelModalBtn">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="submit" form="memberForm" class="btn btn-primary" id="saveMemberBtn">
          ä¿å­˜
        </button>
      </div>
    </div>
  </div>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    let members = [];
    let filteredMembers = [];
    let currentEditingMemberId = null;
    let selectedPhotoFile = null;
    const userInfo = Auth.getUserInfo();

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      Auth.requireAdmin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();

      // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
      await loadMasterData();
      await loadMembers();
    });

    // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadMasterData() {
      try {
        const result = await API.call('getMasters');

        if (result.success && result.masters) {
          const masters = result.masters;

          // æ‰€å±ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
          populateSelect('filterAffiliation', masters.affiliations);
          populateSelect('memberAffiliation', masters.affiliations);

          // å½¹è·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
          populateSelect('filterPosition', masters.positions);
          populateSelect('memberPosition', masters.positions);

          // å§”å“¡ä¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
          populateSelect('filterCommittee', masters.committees);
          populateSelect('memberCommittee', masters.committees);

          // å…¥ä¼šå¹´åº¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
          const currentYear = new Date().getFullYear();
          const yearSelect = document.getElementById('memberJoinYear');
          for (let year = currentYear; year >= 2010; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year + 'å¹´';
            yearSelect.appendChild(option);
          }
        }
      } catch (error) {
        console.error('Load master data error:', error);
      }
    }

    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¨­å®š
    function populateSelect(selectId, options) {
      const select = document.getElementById(selectId);
      const isFilter = selectId.startsWith('filter');

      if (Array.isArray(options)) {
        options.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option;
          opt.textContent = option;
          select.appendChild(opt);
        });
      }
    }

    // SELECTè¦ç´ ã«å€¤ã‚’è¨­å®šï¼ˆé¸æŠè‚¢ã«ãªã„å ´åˆã¯è¿½åŠ ï¼‰
    function setSelectValue(selectElement, value) {
      if (!value) {
        selectElement.value = '';
        return;
      }

      // é¸æŠè‚¢ã«å€¤ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      let optionExists = false;
      for (let i = 0; i < selectElement.options.length; i++) {
        if (selectElement.options[i].value === value) {
          optionExists = true;
          break;
        }
      }

      // é¸æŠè‚¢ã«ãªã„å ´åˆã¯è¿½åŠ 
      if (!optionExists) {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        selectElement.appendChild(option);
      }

      selectElement.value = value;
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
    async function loadMembers() {
      Utils.showLoading();

      try {
        const result = await API.call('getMembers');

        if (result.success && result.members) {
          members = result.members;
          filteredMembers = [...members];
          renderMembers();
        } else {
          throw new Error(result.message || 'ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load members error:', error);
        Utils.showError('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        document.getElementById('membersTableBody').innerHTML = `
          <tr>
            <td colspan="9" class="data-table-empty">
              <div class="data-table-empty-icon">âš ï¸</div>
              <div class="data-table-empty-text">ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            </td>
          </tr>
        `;
      } finally {
        Utils.hideLoading();
      }
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§è¡¨ç¤º
    function renderMembers() {
      const tbody = document.getElementById('membersTableBody');

      if (filteredMembers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="data-table-empty">
              <div class="data-table-empty-icon">ğŸ‘¥</div>
              <div class="data-table-empty-text">ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredMembers.map(member => {
        const photoUrl = member.PhotoURL ||
          "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23f1f5f9' width='100' height='100'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%2394a3b8' font-size='40'%3EğŸ‘¤%3C/text%3E%3C/svg%3E";

        const registeredDate = member.registered_at ?
          new Date(member.registered_at).toLocaleDateString('ja-JP') : '-';

        const birthday = member.birthday ?
          new Date(member.birthday).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' }) : '-';

        return `
          <tr>
            <td>
              <img src="${photoUrl}" alt="${member.name}" class="member-photo">
            </td>
            <td>
              <div class="member-info">
                <div>
                  <div class="member-name">${member.name}</div>
                  ${member.kana ? `<div class="member-kana">${member.kana}</div>` : ''}
                </div>
              </div>
            </td>
            <td>${member.login_id}</td>
            <td>${member.affiliation || '-'}</td>
            <td>${member.position || '-'}</td>
            <td>${birthday}</td>
            <td>
              <span class="badge ${member.role === 'staff' ? 'badge-warning' : 'badge-secondary'}">
                ${member.role === 'staff' ? 'ã‚¹ã‚¿ãƒƒãƒ•' : 'ãƒ¡ãƒ³ãƒãƒ¼'}
              </span>
            </td>
            <td>${registeredDate}</td>
            <td>
              <div class="action-buttons">
                <button class="table-action-btn" onclick="editMember('${member.member_id}')">
                  ç·¨é›†
                </button>
                <button class="table-action-btn danger" onclick="deleteMember('${member.member_id}', '${member.name}')">
                  å‰Šé™¤
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    function applyFilters() {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      const filterAffiliation = document.getElementById('filterAffiliation').value;
      const filterPosition = document.getElementById('filterPosition').value;
      const filterBirthMonth = document.getElementById('filterBirthMonth').value;
      const filterRole = document.getElementById('filterRole').value;

      filteredMembers = members.filter(member => {
        // æ¤œç´¢æ¡ä»¶
        const matchSearch = !searchText ||
          member.name.toLowerCase().includes(searchText) ||
          (member.kana && member.kana.toLowerCase().includes(searchText)) ||
          member.login_id.toLowerCase().includes(searchText);

        // æ‰€å±ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const matchAffiliation = !filterAffiliation || member.affiliation === filterAffiliation;

        // å½¹è·ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const matchPosition = !filterPosition || member.position === filterPosition;

        // èª•ç”Ÿæœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        let matchBirthMonth = true;
        if (filterBirthMonth && member.birthday) {
          const birthDate = new Date(member.birthday);
          matchBirthMonth = (birthDate.getMonth() + 1) === parseInt(filterBirthMonth);
        } else if (filterBirthMonth) {
          matchBirthMonth = false;
        }

        // æ¨©é™ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const matchRole = !filterRole || member.role === filterRole;

        return matchSearch && matchAffiliation && matchPosition && matchBirthMonth && matchRole;
      });

      renderMembers();
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆæ–°è¦ç™»éŒ²ï¼‰
    function openAddModal() {
      currentEditingMemberId = null;
      selectedPhotoFile = null;

      document.getElementById('modalTitle').textContent = 'æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²';
      document.getElementById('memberForm').reset();
      document.getElementById('memberId').value = '';
      document.getElementById('passwordLabel').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰';
      document.getElementById('memberPassword').required = true;

      // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('photoPreview').src =
        "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23f1f5f9' width='100' height='100'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%2394a3b8' font-size='40'%3EğŸ‘¤%3C/text%3E%3C/svg%3E";

      document.getElementById('memberModal').classList.add('active');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆç·¨é›†ï¼‰
    function editMember(memberId) {
      const member = members.find(m => m.member_id === memberId);
      if (!member) return;

      currentEditingMemberId = memberId;
      selectedPhotoFile = null;

      document.getElementById('modalTitle').textContent = 'ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†';
      document.getElementById('memberId').value = memberId;
      document.getElementById('memberName').value = member.name || '';
      document.getElementById('memberKana').value = member.kana || '';
      document.getElementById('memberLoginId').value = member.login_id || '';
      document.getElementById('memberPassword').value = '';
      document.getElementById('passwordLabel').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ã™ã‚‹å ´åˆã®ã¿ï¼‰';
      document.getElementById('memberPassword').required = false;

      // SELECTè¦ç´ ã®å€¤ã‚’è¨­å®šï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€é¸æŠè‚¢ã¯å­˜åœ¨ã™ã‚‹ï¼‰
      const affiliationSelect = document.getElementById('memberAffiliation');
      const positionSelect = document.getElementById('memberPosition');
      const committeeSelect = document.getElementById('memberCommittee');

      // æ—¢å­˜ã®å€¤ã‚’è¨­å®šã€é¸æŠè‚¢ã«ãªã„å ´åˆã¯è¿½åŠ 
      setSelectValue(affiliationSelect, member.affiliation || '');
      setSelectValue(positionSelect, member.position || '');
      setSelectValue(committeeSelect, member.committee || '');

      // æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’è¨­å®š
      document.getElementById('memberNickname').value = member['ã‚ã å'] || '';
      document.getElementById('memberBirthday').value = member.birthday || '';
      document.getElementById('memberComment').value = member['ä¸€è¨€'] || '';
      document.getElementById('memberLineName').value = member['LINEå'] || '';
      document.getElementById('memberJoinYear').value = member['å…¥ä¼šå¹´åº¦'] || '';
      document.getElementById('memberSecondment').value = member['å‡ºå‘å…ˆ'] || '';
      document.getElementById('memberPhone').value = member['é›»è©±ç•ªå·'] || '';
      document.getElementById('memberCompanyName').value = member.company_name || '';
      document.getElementById('memberIndustry').value = member['æ¥­ç¨®'] || '';
      document.getElementById('memberAllergy').value = member['ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼'] || '';
      document.getElementById('memberFavorite').value = member['å¥½ããªã‚‚ã®'] || '';
      document.getElementById('memberDislike').value = member['å«Œã„ãªã‚‚ã®'] || '';
      document.getElementById('memberFavoriteCountry').value = member['å¥½ããªå›½'] || '';
      document.getElementById('memberFavoriteWord').value = member['å¥½ããªè¨€è‘‰'] || '';
      document.getElementById('memberRole').value = member.role || 'member';

      // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      if (member.PhotoURL) {
        document.getElementById('photoPreview').src = member.PhotoURL;
      } else {
        document.getElementById('photoPreview').src =
          "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23f1f5f9' width='100' height='100'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%2394a3b8' font-size='40'%3EğŸ‘¤%3C/text%3E%3C/svg%3E";
      }

      document.getElementById('memberModal').classList.add('active');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
      document.getElementById('memberModal').classList.remove('active');
      currentEditingMemberId = null;
      selectedPhotoFile = null;
    }

    // å†™çœŸé¸æŠ
    function handlePhotoSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBï¼‰
      if (file.size > 5 * 1024 * 1024) {
        Utils.showError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
        return;
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
      if (!file.type.match(/^image\/(jpeg|png)$/)) {
        Utils.showError('JPEGã¾ãŸã¯PNGå½¢å¼ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      selectedPhotoFile = file;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('photoPreview').src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ä¿å­˜
    async function saveMember(e) {
      e.preventDefault();

      const formData = {
        name: document.getElementById('memberName').value.trim(),
        login_id: document.getElementById('memberLoginId').value.trim(),
        kana: document.getElementById('memberKana').value.trim(),
        'ã‚ã å': document.getElementById('memberNickname').value.trim(),
        position: document.getElementById('memberPosition').value,
        affiliation: document.getElementById('memberAffiliation').value,
        birthday: document.getElementById('memberBirthday').value,
        committee: document.getElementById('memberCommittee').value,
        'ä¸€è¨€': document.getElementById('memberComment').value.trim(),
        'LINEå': document.getElementById('memberLineName').value.trim(),
        'å…¥ä¼šå¹´åº¦': document.getElementById('memberJoinYear').value,
        'å‡ºå‘å…ˆ': document.getElementById('memberSecondment').value.trim(),
        'é›»è©±ç•ªå·': document.getElementById('memberPhone').value.trim(),
        company_name: document.getElementById('memberCompanyName').value.trim(),
        'æ¥­ç¨®': document.getElementById('memberIndustry').value.trim(),
        'ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼': document.getElementById('memberAllergy').value.trim(),
        'å¥½ããªã‚‚ã®': document.getElementById('memberFavorite').value.trim(),
        'å«Œã„ãªã‚‚ã®': document.getElementById('memberDislike').value.trim(),
        'å¥½ããªå›½': document.getElementById('memberFavoriteCountry').value.trim(),
        'å¥½ããªè¨€è‘‰': document.getElementById('memberFavoriteWord').value.trim(),
        role: document.getElementById('memberRole').value
      };

      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ–°è¦ç™»éŒ²æ™‚ã¯å¿…é ˆã€ç·¨é›†æ™‚ã¯å¤‰æ›´ã™ã‚‹å ´åˆã®ã¿ï¼‰
      const password = document.getElementById('memberPassword').value;
      if (currentEditingMemberId) {
        if (password) {
          formData.password = password;
        }
        formData.member_id = currentEditingMemberId;
      } else {
        if (!password || password.length < 8) {
          Utils.showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        formData.password = password;
      }

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!formData.name) {
        Utils.showError('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (!formData.login_id) {
        Utils.showError('ãƒ­ã‚°ã‚¤ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // ç¢ºèª
      const confirmMessage = currentEditingMemberId ?
        'ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ' : 'æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ';
      if (!confirm(confirmMessage)) {
        return;
      }

      Utils.showLoading();

      try {
        // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if (selectedPhotoFile) {
          const photoResult = await uploadPhoto(selectedPhotoFile);
          if (photoResult.success) {
            formData.PhotoURL = photoResult.photo_url;
          }
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ä¿å­˜
        const action = currentEditingMemberId ? 'updateMember' : 'addMember';
        const result = await API.call(action, { data: JSON.stringify(formData) });

        if (result.success) {
          Utils.showSuccess(currentEditingMemberId ?
            'ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
          closeModal();
          await loadMembers();
        } else {
          throw new Error(result.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Save member error:', error);
        Utils.showError(error.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    async function uploadPhoto(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const base64Data = e.target.result.split(',')[1];
            const uploadParams = {
              file_data: base64Data,
              file_name: file.name,
              mime_type: file.type
            };

            // ç·¨é›†ä¸­ã®ãƒ¡ãƒ³ãƒãƒ¼IDã‚’è¿½åŠ ï¼ˆç®¡ç†è€…ãŒä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ã™ã‚‹å ´åˆï¼‰
            if (currentEditingMemberId) {
              uploadParams.member_id = currentEditingMemberId;
            }

            const result = await API.call('uploadProfilePhoto', uploadParams);
            resolve(result);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤
    async function deleteMember(memberId, memberName) {
      if (!confirm(`${memberName}ã•ã‚“ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('deleteMember', { member_id: memberId });

        if (result.success) {
          Utils.showSuccess('ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          await loadMembers();
        } else {
          throw new Error(result.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Delete member error:', error);
        Utils.showError(error.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
      document.getElementById('mobileToggle').addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.toggle('mobile-open');
      });

      // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('filterAffiliation').addEventListener('change', applyFilters);
      document.getElementById('filterPosition').addEventListener('change', applyFilters);
      document.getElementById('filterBirthMonth').addEventListener('change', applyFilters);
      document.getElementById('filterRole').addEventListener('change', applyFilters);

      // ãƒ¢ãƒ¼ãƒ€ãƒ«
      document.getElementById('addMemberBtn').addEventListener('click', openAddModal);
      document.getElementById('closeModalBtn').addEventListener('click', closeModal);
      document.getElementById('cancelModalBtn').addEventListener('click', closeModal);
      document.getElementById('memberForm').addEventListener('submit', saveMember);

      // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      document.getElementById('photoUploadArea').addEventListener('click', () => {
        document.getElementById('photoFileInput').click();
      });
      document.getElementById('photoFileInput').addEventListener('change', handlePhotoSelect);

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.getElementById('memberModal').addEventListener('click', (e) => {
        if (e.target.id === 'memberModal') {
          closeModal();
        }
      });
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
    window.editMember = editMember;
    window.deleteMember = deleteMember;
  </script>
</body>
</html>
