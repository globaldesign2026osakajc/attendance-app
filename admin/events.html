<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç† - ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="admin-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h1 class="admin-sidebar-title">ç®¡ç†è€…ç”»é¢</h1>
        <p class="admin-sidebar-subtitle">å‡ºæ¬ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <nav class="admin-sidebar-nav">
        <a href="dashboard.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“Š</span>
          <span class="admin-sidebar-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
        <a href="events.html" class="admin-sidebar-item active">
          <span class="admin-sidebar-icon">ğŸ“…</span>
          <span class="admin-sidebar-text">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</span>
        </a>
        <a href="members.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ‘¥</span>
          <span class="admin-sidebar-text">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
        </a>
        <a href="analytics.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“ˆ</span>
          <span class="admin-sidebar-text">å‡ºå¸­ç‡åˆ†æ</span>
        </a>
        <a href="payments.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ’°</span>
          <span class="admin-sidebar-text">æ”¯æ‰•ã„ç®¡ç†</span>
        </a>
        <a href="checkin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ“±</span>
          <span class="admin-sidebar-text">QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
        </a>
        <a href="receipts-admin.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ§¾</span>
          <span class="admin-sidebar-text">é ˜åæ›¸ç®¡ç†</span>
        </a>

        <div class="admin-sidebar-divider"></div>

        <a href="../home.html" class="admin-sidebar-item">
          <span class="admin-sidebar-icon">ğŸ </span>
          <span class="admin-sidebar-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸</span>
        </a>
      </nav>

      <div class="admin-sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block" style="color: white; border-color: rgba(255,255,255,0.3);">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-main">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="admin-topbar">
        <button class="admin-mobile-toggle" id="mobileToggle">
          â˜°
        </button>
        <h2 class="admin-topbar-title">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</h2>
        <div class="admin-topbar-actions">
          <div class="admin-user-info">
            <span class="admin-user-icon">ğŸ‘¤</span>
            <div class="admin-user-details">
              <span class="admin-user-name" id="userName">ç®¡ç†è€…</span>
              <span class="admin-user-role">ç®¡ç†è€…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="admin-content">
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ -->
        <div class="filter-bar">
          <h3 class="filter-bar-title">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
          <div class="filter-bar-row">
            <div class="form-group">
              <label class="form-label">æœŸé–“</label>
              <select id="periodFilter" class="form-input">
                <option value="all">ã™ã¹ã¦</option>
                <option value="upcoming">ä»Šå¾Œ</option>
                <option value="past">éå»</option>
                <option value="this-month">ä»Šæœˆ</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">æ¤œç´¢</label>
              <input
                type="text"
                id="searchInput"
                class="form-input"
                placeholder="ã‚¤ãƒ™ãƒ³ãƒˆåã§æ¤œç´¢..."
              >
            </div>

            <div class="form-group">
              <label class="form-label">ä¸¦ã³æ›¿ãˆ</label>
              <select id="sortSelect" class="form-input">
                <option value="date-desc">é–‹å‚¬æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰</option>
                <option value="date-asc">é–‹å‚¬æ—¥ï¼ˆå¤ã„é †ï¼‰</option>
                <option value="name-asc">åå‰ï¼ˆæ˜‡é †ï¼‰</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="data-table-container">
          <div class="data-table-header">
            <h3 class="data-table-title">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ï¼ˆ<span id="eventCount">0</span>ä»¶ï¼‰</h3>
            <div class="data-table-actions">
              <button class="btn btn-primary" onclick="location.href='event-form.html'">
                ï¼‹ æ–°è¦ç™»éŒ²
              </button>
            </div>
          </div>

          <div id="eventsTableContainer"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- å‡ºæ¬ çŠ¶æ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="attendanceModal" class="admin-modal">
    <div class="admin-modal-content" style="max-width: 1000px;">
      <div class="admin-modal-header">
        <h3 class="admin-modal-title" id="modalEventName">å‡ºæ¬ çŠ¶æ³</h3>
        <button class="admin-modal-close" onclick="closeAttendanceModal()">Ã—</button>
      </div>
      <div class="admin-modal-body">
        <!-- çµ±è¨ˆ -->
        <div class="modal-stats" style="margin-bottom: 2rem;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 1rem;">
            <div style="text-align: center; padding: 1rem; background: var(--success-bg); border-radius: 8px;">
              <div style="font-size: 2rem; font-weight: 700; color: var(--success-color);" id="modalAttendCount">0</div>
              <div style="font-size: 0.813rem; color: var(--success-color);">å‡ºå¸­</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #fff4e6; border-radius: 8px;">
              <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;" id="modalOfficialAbsenceCount">0</div>
              <div style="font-size: 0.813rem; color: #f59e0b;">å…¬æ¬ </div>
            </div>
            <div style="text-align: center; padding: 1rem; background: var(--danger-bg); border-radius: 8px;">
              <div style="font-size: 2rem; font-weight: 700; color: var(--danger-color);" id="modalAbsentCount">0</div>
              <div style="font-size: 0.813rem; color: var(--danger-color);">æ¬ å¸­</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: var(--warning-bg); border-radius: 8px;">
              <div style="font-size: 2rem; font-weight: 700; color: var(--warning-color);" id="modalPendingCount">0</div>
              <div style="font-size: 0.813rem; color: var(--warning-color);">æœªç™»éŒ²</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: var(--primary-bg); border-radius: 8px;">
              <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="modalCheckinCount">0</div>
              <div style="font-size: 0.813rem; color: var(--primary-color);">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆ</div>
            </div>
          </div>
        </div>

        <!-- ä¸€æ‹¬è¨­å®šUI -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <label class="form-label" style="margin-bottom: 0.5rem; display: block;">ä¸€æ‹¬è¨­å®š</label>
              <select id="bulkStatusSelect" class="form-input">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="å‡ºå¸­">å‡ºå¸­</option>
                <option value="å…¬æ¬ ">å…¬æ¬ </option>
                <option value="æ¬ å¸­">æ¬ å¸­</option>
              </select>
            </div>
            <div style="padding-top: 1.5rem;">
              <button class="btn btn-primary" onclick="applyBulkAttendance()" style="white-space: nowrap;">
                é¸æŠã—ãŸãƒ¡ãƒ³ãƒãƒ¼ã«é©ç”¨
              </button>
            </div>
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.813rem; color: var(--text-secondary);">
            <span id="selectedCount">0</span>åé¸æŠä¸­
          </div>
        </div>

        <!-- å‡ºæ¬ ãƒªã‚¹ãƒˆ -->
        <div id="attendanceList"></div>
      </div>
      <div class="admin-modal-footer">
        <button class="btn btn-outline" onclick="exportAttendanceCSV()">CSVå‡ºåŠ›</button>
        <button class="btn btn-secondary" onclick="closeAttendanceModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- å‡ºæ¬ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editAttendanceModal" class="admin-modal">
    <div class="admin-modal-content" style="max-width: 600px;">
      <div class="admin-modal-header">
        <h3 class="admin-modal-title">å‡ºæ¬ ç·¨é›†</h3>
        <button class="admin-modal-close" onclick="closeEditAttendanceModal()">Ã—</button>
      </div>
      <div class="admin-modal-body">
        <div style="margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background-color: var(--primary-bg); border-radius: 8px; margin-bottom: 1.5rem;">
            <span style="font-size: 1.25rem;">ğŸ‘¤</span>
            <div>
              <div style="font-weight: 700; color: var(--text-color);" id="editMemberName">ãƒ¡ãƒ³ãƒãƒ¼å</div>
              <div style="font-size: 0.813rem; color: var(--text-secondary);" id="editEventName">ã‚¤ãƒ™ãƒ³ãƒˆå</div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">å‡ºæ¬ çŠ¶æ³ <span style="color: var(--danger-color);">*</span></label>
            <div id="editStatusContainer">
              <!-- ã‚¿ã‚¤ãƒ—Aã¾ãŸã¯ã‚¿ã‚¤ãƒ—Bã®é¸æŠè‚¢ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="editMemo">ãƒ¡ãƒ¢</label>
            <textarea id="editMemo" class="form-input" rows="3" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›"></textarea>
          </div>
        </div>
      </div>
      <div class="admin-modal-footer">
        <button class="btn btn-outline" onclick="closeEditAttendanceModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveAttendance()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    let allEvents = [];
    let filteredEvents = [];
    let currentEventId = null;
    let currentEvent = null;
    let currentEditMemberId = null;
    let currentAttendanceList = [];
    const userInfo = Auth.getUserInfo();

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
    let filters = {
      period: 'all',
      search: '',
      sort: 'date-desc'
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      Auth.requireAdmin();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º
      document.getElementById('userName').textContent = userInfo.name;

      // ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
      await loadEvents();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
    async function loadEvents() {
      Utils.showLoading();

      try {
        // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€member_idã¯ä¸è¦ã ãŒçµ±è¨ˆã¯å¸¸ã«è¿”ã•ã‚Œã‚‹
        const result = await API.call('getEvents', {});

        if (result.success) {
          allEvents = result.events || [];
          applyFilters();
        } else {
          throw new Error(result.message || 'ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Load events error:', error);
        Utils.showError('ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    function applyFilters() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      filteredEvents = allEvents.filter(event => {
        const eventDate = new Date(event.date);

        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (filters.period === 'upcoming' && eventDate < today) {
          return false;
        }
        if (filters.period === 'past' && eventDate >= today) {
          return false;
        }
        if (filters.period === 'this-month') {
          if (eventDate.getMonth() !== now.getMonth() || eventDate.getFullYear() !== now.getFullYear()) {
            return false;
          }
        }

        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (filters.search && !event.title.toLowerCase().includes(filters.search.toLowerCase())) {
          return false;
        }

        return true;
      });

      // ã‚½ãƒ¼ãƒˆ
      filteredEvents.sort((a, b) => {
        switch (filters.sort) {
          case 'date-asc':
            return new Date(a.date) - new Date(b.date);
          case 'date-desc':
            return new Date(b.date) - new Date(a.date);
          case 'name-asc':
            return a.title.localeCompare(b.title, 'ja');
          default:
            return 0;
        }
      });

      displayEvents();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º
    function displayEvents() {
      const container = document.getElementById('eventsTableContainer');
      const countElement = document.getElementById('eventCount');

      countElement.textContent = filteredEvents.length;

      if (filteredEvents.length === 0) {
        container.innerHTML = `
          <div class="data-table-empty">
            <div class="data-table-empty-icon">ğŸ“…</div>
            <div class="data-table-empty-text">è©²å½“ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
              <th>é–‹å‚¬æ—¥</th>
              <th>å ´æ‰€</th>
              <th>å‡ºæ¬ çŠ¶æ³</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${filteredEvents.map(event => createEventRow(event)).join('')}
          </tbody>
        </table>
      `;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆè¡Œä½œæˆ
    function createEventRow(event) {
      const eventDate = Utils.formatDateSlash(event.date);
      const dayOfWeek = Utils.getDayOfWeek(event.date);
      const attendCount = event.attend_count || 0;
      const absentCount = event.absent_count || 0;
      const pendingCount = event.pending_count || 0;
      const isPast = new Date(event.date) < new Date();

      return `
        <tr>
          <td>
            <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.25rem;">
              ${Utils.escapeHtml(event.title)}
              ${event.urgent ? '<span class="badge badge-danger" style="margin-left: 0.5rem;">ç·Šæ€¥</span>' : ''}
              ${isPast ? '<span class="badge badge-secondary" style="margin-left: 0.5rem;">çµ‚äº†</span>' : ''}
            </div>
            ${event.attendance_deadline ? `<div style="font-size: 0.75rem; color: var(--text-light);">ç· åˆ‡: ${Utils.formatDateSlash(event.attendance_deadline)}</div>` : ''}
          </td>
          <td>
            <div>${eventDate}</div>
            <div style="font-size: 0.75rem; color: var(--text-light);">${dayOfWeek}</div>
          </td>
          <td>${Utils.escapeHtml(event.location || '-')}</td>
          <td>
            <div style="font-size: 0.813rem;">
              <span style="color: var(--success-color);">âœ“ ${attendCount}</span> /
              <span style="color: var(--text-secondary);">âœ— ${absentCount}</span> /
              <span style="color: var(--warning-color);">? ${pendingCount}</span>
            </div>
          </td>
          <td>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="table-action-btn" onclick="viewAttendance('${event.event_id}')">
                å‡ºæ¬ ç¢ºèª
              </button>
              <button class="table-action-btn" onclick="location.href='event-form.html?id=${event.event_id}'">
                ç·¨é›†
              </button>
              <button class="table-action-btn" onclick="deleteEvent('${event.event_id}')">
                å‰Šé™¤
              </button>
            </div>
          </td>
        </tr>
      `;
    }

    // å‡ºæ¬ çŠ¶æ³è¡¨ç¤º
    async function viewAttendance(eventId) {
      currentEventId = eventId;
      Utils.showLoading();

      try {
        const result = await API.call('getEventAttendance', {
          event_id: eventId
        });

        if (result.success) {
          displayAttendanceModal(result.event, result.attendance);
        } else {
          throw new Error(result.message || 'å‡ºæ¬ çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('View attendance error:', error);
        Utils.showError('å‡ºæ¬ çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }
    window.viewAttendance = viewAttendance;

    // å‡ºæ¬ çŠ¶æ³ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function displayAttendanceModal(event, attendanceList) {
      // ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨å‡ºæ¬ ãƒªã‚¹ãƒˆã‚’ä¿å­˜
      currentEvent = event;
      currentAttendanceList = attendanceList;

      // ã‚¤ãƒ™ãƒ³ãƒˆå
      document.getElementById('modalEventName').textContent = event.title + ' - å‡ºæ¬ çŠ¶æ³';

      // çµ±è¨ˆï¼ˆã‚¿ã‚¤ãƒ—Bã§ã¯æ¬ å¸­ä»¥å¤–ã‚’å‡ºå¸­ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆï¼‰
      const isTypeB = event.attendance_type === 'B';
      let attendCount, officialAbsenceCount, absentCount;
      let optionBreakdown = '';

      if (isTypeB) {
        // ã‚¿ã‚¤ãƒ—B: æ¬ å¸­ã‚’æ¬ å¸­ã€ãã‚Œä»¥å¤–ï¼ˆstatusãŒã‚ã‚‹ã‚‚ã®ï¼‰ã‚’å‡ºå¸­ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
        absentCount = attendanceList.filter(a => a.status === 'æ¬ å¸­').length;
        attendCount = attendanceList.filter(a => a.status && a.status !== 'æ¬ å¸­').length;
        officialAbsenceCount = 0; // ã‚¿ã‚¤ãƒ—Bã«ã¯å…¬æ¬ ãªã—

        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³åã”ã¨ã®é›†è¨ˆ
        const optionCounts = {};
        attendanceList.forEach(a => {
          if (a.status && a.selected_option) {
            const option = a.selected_option;
            optionCounts[option] = (optionCounts[option] || 0) + 1;
          }
        });

        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ¥é›†è¨ˆã‚’æ–‡å­—åˆ—ã§è¡¨ç¤º
        if (Object.keys(optionCounts).length > 0) {
          optionBreakdown = '<div style="margin-top: 1rem; padding: 1rem; background-color: var(--primary-bg); border-radius: 8px;">' +
            '<h4 style="font-size: 0.875rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--text-color);">ğŸ“Š ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ¥é›†è¨ˆ</h4>' +
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">';

          for (const [option, count] of Object.entries(optionCounts)) {
            const isAbsent = option === 'æ¬ å¸­';
            const badgeClass = isAbsent ? 'badge-danger' : 'badge-success';
            optionBreakdown += `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0.75rem; background-color: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <span style="font-size: 0.813rem; font-weight: 600; color: var(--text-color);">${Utils.escapeHtml(option)}</span>
                <span class="badge ${badgeClass}" style="font-size: 0.875rem; font-weight: 700;">${count}å</span>
              </div>
            `;
          }

          optionBreakdown += '</div></div>';
        }
      } else {
        // ã‚¿ã‚¤ãƒ—A: å‡ºå¸­/å…¬æ¬ /æ¬ å¸­ã‚’å€‹åˆ¥ã«ã‚«ã‚¦ãƒ³ãƒˆ
        attendCount = attendanceList.filter(a => a.status === 'å‚åŠ ' || a.status === 'å‡ºå¸­').length;
        officialAbsenceCount = attendanceList.filter(a => a.status === 'å…¬æ¬ ').length;
        absentCount = attendanceList.filter(a => a.status === 'ä¸å‚åŠ ' || a.status === 'æ¬ å¸­').length;
      }

      const unregisteredCount = attendanceList.filter(a => !a.status).length;
      const checkinCount = attendanceList.filter(a => a.checked_in).length;

      document.getElementById('modalAttendCount').textContent = attendCount;
      document.getElementById('modalOfficialAbsenceCount').textContent = officialAbsenceCount;
      document.getElementById('modalAbsentCount').textContent = absentCount;
      document.getElementById('modalPendingCount').textContent = unregisteredCount;
      document.getElementById('modalCheckinCount').textContent = checkinCount;

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ¥é›†è¨ˆã‚’çµ±è¨ˆæƒ…å ±ã®å¾Œã«æŒ¿å…¥
      const statsContainer = document.querySelector('.modal-stats');
      if (statsContainer) {
        // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³é›†è¨ˆãŒã‚ã‚Œã°å‰Šé™¤
        const existingBreakdown = statsContainer.querySelector('.option-breakdown-container');
        if (existingBreakdown) {
          existingBreakdown.remove();
        }

        // æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³é›†è¨ˆã‚’è¿½åŠ 
        if (optionBreakdown) {
          const breakdownDiv = document.createElement('div');
          breakdownDiv.className = 'option-breakdown-container';
          breakdownDiv.innerHTML = optionBreakdown;
          statsContainer.appendChild(breakdownDiv);
        }
      }

      // ãƒªã‚¹ãƒˆè¡¨ç¤º
      const listContainer = document.getElementById('attendanceList');
      listContainer.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 40px;">
                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" style="cursor: pointer;">
              </th>
              <th>æ°å</th>
              <th>æ‰€å±</th>
              <th>å‡ºæ¬ </th>
              <th>ãƒ¡ãƒ¢</th>
              <th>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</th>
              <th>ç™»éŒ²æ—¥æ™‚</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${attendanceList.map(item => {
              // å‡ºæ¬ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
              let statusText = item.status || 'æœªç™»éŒ²';
              let statusBadge;

              if (!item.status) {
                // æœªç™»éŒ²
                statusBadge = '<span class="badge badge-secondary">æœªç™»éŒ²</span>';
              } else if (event.attendance_type === 'B') {
                // ã‚¿ã‚¤ãƒ—B: selected_optionã‚’è¡¨ç¤º
                statusText = item.selected_option || item.status;
                if (item.status === 'æ¬ å¸­') {
                  statusBadge = `<span class="badge badge-danger">${Utils.escapeHtml(statusText)}</span>`;
                } else {
                  // æ¬ å¸­ä»¥å¤–ã¯å‡ºå¸­æ‰±ã„
                  statusBadge = `<span class="badge badge-success">${Utils.escapeHtml(statusText)}</span>`;
                }
              } else {
                // ã‚¿ã‚¤ãƒ—A: é€šå¸¸ã®å‡ºå¸­/æ¬ å¸­/å…¬æ¬ 
                if (item.status === 'å‚åŠ ' || item.status === 'å‡ºå¸­') {
                  statusBadge = `<span class="badge badge-success">${Utils.escapeHtml(statusText)}</span>`;
                } else if (item.status === 'å…¬æ¬ ') {
                  statusBadge = `<span class="badge" style="background-color: #fff4e6; color: #f59e0b;">${Utils.escapeHtml(statusText)}</span>`;
                } else if (item.status === 'ä¸å‚åŠ ' || item.status === 'æ¬ å¸­') {
                  statusBadge = `<span class="badge badge-danger">${Utils.escapeHtml(statusText)}</span>`;
                } else if (item.status === 'æœªå®š') {
                  statusBadge = `<span class="badge badge-warning">${Utils.escapeHtml(statusText)}</span>`;
                } else {
                  statusBadge = `<span class="badge badge-secondary">${Utils.escapeHtml(statusText)}</span>`;
                }
              }

              const checkinBadge = item.checked_in
                ? '<span class="badge badge-primary">æ¸ˆ</span>'
                : '<span style="color: var(--text-light);">-</span>';

              const registeredAt = item.registered_at
                ? new Date(item.registered_at).toLocaleString('ja-JP', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                  })
                : '-';

              // æ‰€å±ã‚«ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯è¡Œã«èƒŒæ™¯è‰²ã‚’é©ç”¨
              const rowStyle = item.affiliation_color
                ? `style="background: linear-gradient(to right, ${item.affiliation_color}10, transparent);"`
                : '';

              const affiliationStyle = item.affiliation_color
                ? `style="color: ${item.affiliation_color}; font-weight: 600; padding: 0.25rem 0.5rem; background-color: ${item.affiliation_color}20; border-radius: 4px; display: inline-block;"`
                : '';

              return `
                <tr ${rowStyle}>
                  <td style="text-align: center;">
                    <input type="checkbox" class="member-checkbox" data-member-id="${Utils.escapeHtml(item.member_id)}" data-member-name="${Utils.escapeHtml(item.member_name)}" onchange="updateSelectedCount()" style="cursor: pointer;">
                  </td>
                  <td style="font-weight: 600;">${Utils.escapeHtml(item.member_name)}</td>
                  <td><span ${affiliationStyle}>${Utils.escapeHtml(item.affiliation || '-')}</span></td>
                  <td>${statusBadge}</td>
                  <td style="max-width: 200px; white-space: pre-wrap;">${Utils.escapeHtml(item.memo || '-')}</td>
                  <td>${checkinBadge}</td>
                  <td style="font-size: 0.813rem; color: var(--text-secondary);">${registeredAt}</td>
                  <td>
                    <button class="table-action-btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="editAttendance('${Utils.escapeHtml(item.member_id)}', '${Utils.escapeHtml(item.member_name)}', '${Utils.escapeHtml(item.status || '')}', '${Utils.escapeHtml(item.selected_option || '')}', '${Utils.escapeHtml(item.memo || '')}')">
                      ç·¨é›†
                    </button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      // ä¸€æ‹¬è¨­å®šã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
      updateBulkStatusOptions(event);

      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      document.getElementById('attendanceModal').classList.add('active');

      // é¸æŠã‚«ã‚¦ãƒ³ãƒˆã‚’åˆæœŸåŒ–
      updateSelectedCount();
    }

    // ä¸€æ‹¬è¨­å®šã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
    function updateBulkStatusOptions(event) {
      const bulkStatusSelect = document.getElementById('bulkStatusSelect');

      if (event.attendance_type === 'B') {
        // ã‚¿ã‚¤ãƒ—B: ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const options = typeof event.participation_options === 'string'
          ? JSON.parse(event.participation_options)
          : (event.participation_options || []);

        let optionsHtml = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        options.forEach(option => {
          optionsHtml += `<option value="${Utils.escapeHtml(option.label)}">${Utils.escapeHtml(option.label)}</option>`;
        });

        bulkStatusSelect.innerHTML = optionsHtml;
      } else {
        // ã‚¿ã‚¤ãƒ—A: é€šå¸¸ã®å‡ºå¸­/å…¬æ¬ /æ¬ å¸­
        bulkStatusSelect.innerHTML = `
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="å‡ºå¸­">å‡ºå¸­</option>
          <option value="å…¬æ¬ ">å…¬æ¬ </option>
          <option value="æ¬ å¸­">æ¬ å¸­</option>
        `;
      }
    }

    // å…¨é¸æŠ/å…¨è§£é™¤
    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const memberCheckboxes = document.querySelectorAll('.member-checkbox');

      memberCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });

      updateSelectedCount();
    }
    window.toggleSelectAll = toggleSelectAll;

    // é¸æŠæ•°ã‚’æ›´æ–°
    function updateSelectedCount() {
      const selectedCheckboxes = document.querySelectorAll('.member-checkbox:checked');
      const count = selectedCheckboxes.length;
      document.getElementById('selectedCount').textContent = count;

      // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
      const memberCheckboxes = document.querySelectorAll('.member-checkbox');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = memberCheckboxes.length > 0 && count === memberCheckboxes.length;
      }
    }
    window.updateSelectedCount = updateSelectedCount;

    // ä¸€æ‹¬å‡ºæ¬ è¨­å®š
    async function applyBulkAttendance() {
      const bulkStatus = document.getElementById('bulkStatusSelect').value;

      if (!bulkStatus) {
        Utils.showError('å‡ºæ¬ çŠ¶æ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const selectedCheckboxes = document.querySelectorAll('.member-checkbox:checked');

      if (selectedCheckboxes.length === 0) {
        Utils.showError('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const memberIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.memberId);
      const memberNames = Array.from(selectedCheckboxes).map(cb => cb.dataset.memberName);

      if (!confirm(`${memberNames.join('ã€')} ã®${memberNames.length}åã«ã€Œ${bulkStatus}ã€ã‚’è¨­å®šã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      Utils.showLoading();

      try {
        // ä¸€æ‹¬ç™»éŒ²APIã‚’å‘¼ã³å‡ºã™
        const attendances = memberIds.map(memberId => ({
          member_id: memberId,
          status: bulkStatus,
          selected_option: currentEvent.attendance_type === 'B' ? bulkStatus : '',
          memo: ''
        }));

        const result = await API.call('registerAttendanceBatch', {
          event_id: currentEventId,
          attendances: attendances
        }, true); // POSTãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨

        if (result.success) {
          Utils.showSuccess(result.message || 'ä¸€æ‹¬ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ');

          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
          selectedCheckboxes.forEach(cb => cb.checked = false);
          document.getElementById('selectAllCheckbox').checked = false;
          document.getElementById('bulkStatusSelect').value = '';

          // å‡ºæ¬ çŠ¶æ³ã‚’å†èª­ã¿è¾¼ã¿
          await viewAttendance(currentEventId);
        } else {
          throw new Error(result.error || 'ä¸€æ‹¬ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Bulk attendance error:', error);
        Utils.showError(error.message || 'ä¸€æ‹¬ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }
    window.applyBulkAttendance = applyBulkAttendance;

    // å‡ºæ¬ çŠ¶æ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeAttendanceModal() {
      document.getElementById('attendanceModal').classList.remove('active');
      currentEventId = null;
    }
    window.closeAttendanceModal = closeAttendanceModal;

    // CSVå‡ºåŠ›
    function exportAttendanceCSV() {
      alert('CSVå‡ºåŠ›æ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™');
    }
    window.exportAttendanceCSV = exportAttendanceCSV;

    // å‡ºæ¬ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function editAttendance(memberId, memberName, currentStatus, currentOption, currentMemo) {
      currentEditMemberId = memberId;

      // ãƒ¡ãƒ³ãƒãƒ¼åã¨ã‚¤ãƒ™ãƒ³ãƒˆåã‚’è¡¨ç¤º
      document.getElementById('editMemberName').textContent = memberName;
      document.getElementById('editEventName').textContent = currentEvent.title;

      // ãƒ¡ãƒ¢ã‚’è¨­å®š
      document.getElementById('editMemo').value = currentMemo;

      // å‡ºæ¬ çŠ¶æ³ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
      const statusContainer = document.getElementById('editStatusContainer');

      if (currentEvent.attendance_type === 'B') {
        // ã‚¿ã‚¤ãƒ—B: ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const options = typeof currentEvent.participation_options === 'string'
          ? JSON.parse(currentEvent.participation_options)
          : (currentEvent.participation_options || []);

        let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

        options.forEach(option => {
          const isChecked = currentOption === option.label ? 'checked' : '';
          html += `
            <label class="radio-label" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
              <input type="radio" name="editStatus" value="${Utils.escapeHtml(option.label)}" ${isChecked} style="margin: 0;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text-color);">${Utils.escapeHtml(option.label)}</div>
                ${option.amount > 0 ? `<div style="font-size: 0.813rem; color: var(--text-secondary);">Â¥${option.amount.toLocaleString()}</div>` : ''}
              </div>
            </label>
          `;
        });

        html += '</div>';
        statusContainer.innerHTML = html;
      } else {
        // ã‚¿ã‚¤ãƒ—A: é€šå¸¸ã®å‡ºå¸­/å…¬æ¬ /æ¬ å¸­
        const statusOptions = [
          { value: 'å‡ºå¸­', label: 'å‡ºå¸­' },
          { value: 'å…¬æ¬ ', label: 'å…¬æ¬ ' },
          { value: 'æ¬ å¸­', label: 'æ¬ å¸­' }
        ];

        let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

        statusOptions.forEach(option => {
          const isChecked = currentStatus === option.value ? 'checked' : '';
          html += `
            <label class="radio-label" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
              <input type="radio" name="editStatus" value="${option.value}" ${isChecked} style="margin: 0;">
              <div style="font-weight: 600; color: var(--text-color);">${option.label}</div>
            </label>
          `;
        });

        html += '</div>';
        statusContainer.innerHTML = html;
      }

      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
      const radioLabels = statusContainer.querySelectorAll('.radio-label');
      radioLabels.forEach(label => {
        const radio = label.querySelector('input[type="radio"]');

        // åˆæœŸçŠ¶æ…‹ã®é©ç”¨
        if (radio.checked) {
          label.style.borderColor = 'var(--primary-color)';
          label.style.backgroundColor = 'var(--primary-bg)';
        }

        // å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        radio.addEventListener('change', function() {
          radioLabels.forEach(l => {
            l.style.borderColor = 'var(--border-color)';
            l.style.backgroundColor = 'white';
          });

          if (this.checked) {
            label.style.borderColor = 'var(--primary-color)';
            label.style.backgroundColor = 'var(--primary-bg)';
          }
        });
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('editAttendanceModal').classList.add('active');
    }
    window.editAttendance = editAttendance;

    // å‡ºæ¬ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeEditAttendanceModal() {
      document.getElementById('editAttendanceModal').classList.remove('active');
      currentEditMemberId = null;
    }
    window.closeEditAttendanceModal = closeEditAttendanceModal;

    // å‡ºæ¬ ã‚’ä¿å­˜
    async function saveAttendance() {
      const selectedStatus = document.querySelector('input[name="editStatus"]:checked');

      if (!selectedStatus) {
        Utils.showError('å‡ºæ¬ çŠ¶æ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const memo = document.getElementById('editMemo').value.trim();

      Utils.showLoading();

      try {
        // ç®¡ç†è€…ç”¨ã®å‡ºæ¬ ç™»éŒ²APIã‚’å‘¼ã³å‡ºã™
        // æ—¢å­˜ã®registerAttendance APIã‚’ä½¿ç”¨ã—ã€ç®¡ç†è€…ãŒmember_idã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«æ‹¡å¼µãŒå¿…è¦
        const params = {
          event_id: currentEventId,
          member_id: currentEditMemberId,
          status: selectedStatus.value,
          memo: memo
        };

        // ã‚¿ã‚¤ãƒ—Bã®å ´åˆã¯selected_optionã‚‚é€ä¿¡
        if (currentEvent.attendance_type === 'B') {
          params.selected_option = selectedStatus.value;
        }

        const result = await API.call('registerAttendance', params);

        if (result.success) {
          Utils.showSuccess('å‡ºæ¬ ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          closeEditAttendanceModal();
          // å‡ºæ¬ çŠ¶æ³ã‚’å†èª­ã¿è¾¼ã¿
          await viewAttendance(currentEventId);
        } else {
          throw new Error(result.error || 'å‡ºæ¬ ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Save attendance error:', error);
        Utils.showError(error.message || 'å‡ºæ¬ ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }
    window.saveAttendance = saveAttendance;

    // ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤
    async function deleteEvent(eventId) {
      if (!confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»å‡ºæ¬ ç™»éŒ²ã‚‚å«ã‚ã¦ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      Utils.showLoading();

      try {
        const result = await API.call('deleteEvent', {
          event_id: eventId
        });

        if (result.success) {
          Utils.showSuccess('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          await loadEvents();
        } else {
          throw new Error(result.message || 'ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('Delete event error:', error);
        Utils.showError(error.message || 'ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        Utils.hideLoading();
      }
    }
    window.deleteEvent = deleteEvent;

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          await Auth.logout();
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«
      document.getElementById('mobileToggle').addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.toggle('mobile-open');
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´
      document.getElementById('periodFilter').addEventListener('change', (e) => {
        filters.period = e.target.value;
        applyFilters();
      });

      let searchTimeout;
      document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          filters.search = e.target.value.trim();
          applyFilters();
        }, 300);
      });

      document.getElementById('sortSelect').addEventListener('change', (e) => {
        filters.sort = e.target.value;
        applyFilters();
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.getElementById('attendanceModal').addEventListener('click', (e) => {
        if (e.target.id === 'attendanceModal') {
          closeAttendanceModal();
        }
      });

      document.getElementById('editAttendanceModal').addEventListener('click', (e) => {
        if (e.target.id === 'editAttendanceModal') {
          closeEditAttendanceModal();
        }
      });
    }
  </script>
</body>
</html>
