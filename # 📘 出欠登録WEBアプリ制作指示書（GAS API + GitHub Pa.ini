# 📘 出欠登録WEBアプリ制作指示書（GAS API + GitHub Pages版）

## 1️⃣ プロジェクト概要

### 目的
月に複数回開催されるイベントに対して、50名規模のメンバーが出欠登録できるWEBアプリを構築する。管理者はイベントの登録・出欠状況の確認・メンバー管理・出席率分析・受付での実出席記録などを行える。

### 使用技術
- **バックエンド**: Google Apps Script（REST API）
- **データベース**: Google Sheets
- **フロントエンド**: GitHub Pages（HTML/CSS/JavaScript）

### アーキテクチャ
```
GitHub Pages (フロントエンド)
    ↓ REST API通信
Cloudflare Workers (プロキシ)
    ↓ リクエスト転送
Google Apps Script (バックエンドAPI)
    ↓ データ操作
Google Sheets (データベース)
```

**セキュリティ強化ポイント**:
- **Cloudflare Workers** を経由させることで、GAS APIのURLをフロントエンドに直接記載しない
- フロントエンドからは Cloudflare Workers のエンドポイントのみを呼び出す
- GAS の実際のデプロイURLは Workers の環境変数に保存

---

## 2️⃣ 機能一覧

### 一般ユーザー機能
- ログイン（ID・パスワード）
- HOME画面（次のイベント表示、出欠状況、QRコード表示）
- イベント一覧（フィルター付き）
- 出欠登録（タイプA/B　メモ）
- 自分の履歴確認・編集

### 管理者機能
- イベント登録・編集・削除
- 出欠状況確認（表形式）
- メンバー管理（登録・編集・削除）
- 出席率分析（役職・所属・タグ別）
- Googleカレンダー連携（団体カレンダーに予定登録）
- 受付用URL生成・QRコード表示
- 実出席記録（QRコード読み取り）

---

## 3️⃣ データ構造（Google Sheets）

### 3.1 メンバー一覧（members）
| member_id | name | login_id | password | kana | affiliation | position | birthday | PhotoURL | role | committee | company_name | registered_at |

- **role**: `admin` または `user`
- **password**: 平文保存（ハッシュ化不要）
- **affiliation**: 所属部署（例：営業部、企画部、総務部）※領収書発行画面のフィルターで使用
- **committee**: 所属委員会名（例：グローバルデザイン推進委員会、総務委員会）
- **company_name**: 会社名（領収書発行時のデフォルト宛名として使用）

### 3.2 イベント一覧（events）
| event_id | title | date | start_time | end_time | location | map_url | host | description | attendance_type | custom_options | memo | urgent | attendance_deadline | registration_deadline | cancellation_fee_date | fee_amount | fee_currency | payment_methods | dress_code | dress_code_note | tags | notes | target_group | visibility | qr_enabled | csv_enabled | calendar_sync | display_fields | receipt_note_default | receipt_enabled |

- **display_fields**: メンバーに表示する項目の設定（JSON形式）
  ```json
  {
    "date": true,
    "time": true,
    "location": true,
    "map_url": false,
    "host": true,
    "description": true,
    "fee_amount": true,
    "payment_methods": false,
    "dress_code": true,
    "notes": false
  }
  ```
- **receipt_note_default**: 領収書の但し書きデフォルト値（空欄の場合は「イベント名 参加費として」）
- **receipt_enabled**: 領収書発行を有効にするか（true/false）このイベントで領収書を発行する場合はtrue

### 3.3 出欠登録（attendance）
| event_id | member_id | status | selected_option | memo | registered_at |

### 3.4 支払い管理（payments）
| payment_id | event_id | member_id | payment_method | amount | paid | paid_at | paid_by_admin | receipt_issued | receipt_number | receipt_url | receipt_issued_at | notes |

- **payment_method**: 現地払い / 銀行振込
- **paid**: 支払い済みフラグ（true/false）
- **paid_at**: 支払い日時
- **paid_by_admin**: 管理者が手動で支払い確認したか
- **receipt_issued**: 領収書発行済みフラグ
- **receipt_number**: 領収書番号（例：2025-0001）
- **receipt_url**: Google Driveの領収書PDF URL
- **receipt_issued_at**: 領収書発行日時

### 3.5 領収書発行履歴（receipts）
| receipt_id | receipt_number | event_id | member_id | member_ids | is_combined | company_name | amount | receipt_note | detail_note | issued_at | pdf_url |

- **member_id**: 対象メンバーID（単独の場合）
- **member_ids**: 対象メンバーID（複数の場合、カンマ区切り）例: "M001,M002,M003"
- **is_combined**: 合算領収書フラグ（true/false）
- **detail_note**: 内訳メモ（例：「山田、佐藤、鈴木の3名分」）

### 3.6 実出席記録（checkin）
| event_id | member_id | checked_in_at |

### 3.7 セッション管理（sessions）
| token | member_id | role | created_at | expires_at |

### 3.8 マスタシート（プルダウン用）
- **hosts_master**: 主催者一覧（例：グローバルデザイン推進委員会、総務委員会）
- **tags_master**: タグ一覧（例：委員会、月例会、総会）
- **payment_methods_master**: 支払い方法一覧（例：現地払い、銀行振込）
- **dress_codes_master**: 服装規定一覧（例：スーツ、ビジネスカジュアル）
- **positions_master**: 役職一覧（例：委員長、副委員長、幹事）
- **affiliations_master**: 所属部署一覧（例：営業部、企画部、総務部）※領収書発行のフィルターで使用
- **committees_master**: 委員会一覧（例：グローバルデザイン推進委員会、総務委員会）

---

## 4️⃣ バックエンドAPI仕様（Google Apps Script）

### 4.1 Code.gs の構造

```javascript
// エントリーポイント
function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

// リクエスト処理
function handleRequest(e) {
  const action = e.parameter.action;
  const token = e.parameter.token;
  
  const output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  
  try {
    // トークン認証（ログイン以外）
    if (action !== 'login' && !isValidToken(token)) {
      return output.setContent(JSON.stringify({
        error: 'Unauthorized',
        message: '認証が必要です'
      }));
    }
    
    let result;
    switch(action) {
      // 認証
      case 'login':
        result = login(e.parameter);
        break;
      case 'logout':
        result = logout(token);
        break;
      
      // イベント
      case 'getEvents':
        result = getEvents(token, e.parameter);
        break;
      case 'getEventDetail':
        result = getEventDetail(token, e.parameter.event_id);
        break;
      case 'addEvent':
        result = addEvent(token, JSON.parse(e.parameter.data));
        break;
      case 'updateEvent':
        result = updateEvent(token, JSON.parse(e.parameter.data));
        break;
      case 'deleteEvent':
        result = deleteEvent(token, e.parameter.event_id);
        break;
      
      // 出欠
      case 'registerAttendance':
        result = registerAttendance(token, e.parameter);
        break;
      case 'getMyAttendance':
        result = getMyAttendance(token);
        break;
      case 'getEventAttendance':
        result = getEventAttendance(token, e.parameter.event_id);
        break;
      
      // メンバー
      case 'getMembers':
        result = getMembers(token);
        break;
      case 'addMember':
        result = addMember(token, JSON.parse(e.parameter.data));
        break;
      case 'updateMember':
        result = updateMember(token, JSON.parse(e.parameter.data));
        break;
      case 'deleteMember':
        result = deleteMember(token, e.parameter.member_id);
        break;
      
      // チェックイン
      case 'checkin':
        result = checkin(token, e.parameter);
        break;
      case 'checkinWithPayment':
        result = checkinWithPayment(token, e.parameter);
        break;
      case 'getCheckinList':
        result = getCheckinList(token, e.parameter.event_id);
        break;
      
      // 支払い管理
      case 'confirmPayment':
        result = confirmPayment(token, e.parameter);
        break;
      case 'getUnpaidList':
        result = getUnpaidList(token);
        break;
      case 'getCancellationFeeList':
        result = getCancellationFeeList(token);
        break;
      
      // 領収書
      case 'getReceiptableEvents':
        result = getReceiptableEvents(token);
        break;
      case 'issueReceipt':
        result = issueReceipt(token, e.parameter);
        break;
      
      // 分析
      case 'getAnalytics':
        result = getAnalytics(token, e.parameter);
        break;
      
      // マスタ
      case 'getMasters':
        result = getMasters(token);
        break;
      
      default:
        result = {error: 'Invalid action'};
    }
    
    output.setContent(JSON.stringify(result));
  } catch(error) {
    output.setContent(JSON.stringify({
      error: error.toString()
    }));
  }
  
  return output;
}
```

### 4.2 主要API関数

#### 認証系
- `login(params)`: ログイン処理、トークン発行
- `logout(token)`: ログアウト、トークン削除
- `isValidToken(token)`: トークン検証

#### イベント系
- `getEvents(token, filters)`: イベント一覧取得
- `getEventDetail(token, event_id)`: イベント詳細取得
- `addEvent(token, data)`: イベント登録
- `updateEvent(token, data)`: イベント更新
- `deleteEvent(token, event_id)`: イベント削除

#### 出欠系
- `registerAttendance(token, data)`: 出欠登録
- `getMyAttendance(token)`: 自分の出欠履歴
- `getEventAttendance(token, event_id)`: イベントの出欠状況

#### メンバー系
- `getMembers(token)`: メンバー一覧
- `getMemberProfile(token)`: 自分のプロフィール取得
- `updateMemberProfile(token, data)`: 自分のプロフィール更新（一般ユーザー用）
  - パラメータ: `kana`, `affiliation`, `position`, `committee`, `company_name`, `birthday`
  - 自分の情報のみ更新可能
- `uploadProfilePhoto(token, fileData)`: プロフィール写真アップロード
  - Google Driveに保存
  - PhotoURLを返却
- `changePassword(token, data)`: パスワード変更
  - パラメータ: `current_password`, `new_password`
  - 現在のパスワードを検証してから変更
- `addMember(token, data)`: メンバー追加（管理者専用）
- `updateMember(token, data)`: メンバー更新（管理者専用）
- `deleteMember(token, member_id)`: メンバー削除（管理者専用）

#### チェックイン系
- `checkin(token, data)`: 実出席記録
- `checkinWithPayment(token, data)`: 実出席記録＋現地払い確認
- `getCheckinList(token, event_id)`: チェックイン一覧

#### 支払い管理系
- `confirmPayment(token, data)`: 支払い確認（管理者）
- `getUnpaidList(token)`: 未払い一覧取得
- `getCancellationFeeList(token)`: キャンセル料一覧取得

#### 領収書系
- `getReceiptableEvents(token)`: 領収書関連イベント一覧取得（メンバー用）
  - `receipt_enabled=true`のイベントのみ
  - 自分が出欠登録したイベント
  - イベント情報、出欠状況、実出欠、支払い状況、キャンセル料、領収書発行状態を返す
- `getAdminReceiptableEvents(token, event_id, affiliation)`: 領収書発行対象メンバー一覧取得（管理者用）
  - 指定イベントの支払済メンバー一覧
  - affiliation指定時: 指定所属のメンバーのみフィルタリング
  - 各メンバーの金額、所属（affiliation）、支払い状況、領収書発行状態を返す
- `issueReceipt(token, data)`: 領収書発行（単独）
  - パラメータ: `event_id`, `member_id`, `company_name`（宛名）, `receipt_note`（但し書き）
  - 発行可能条件チェック（支払い済み、未発行）
  - PDF生成、Google Drive保存
  - `receipts`と`payments`テーブル更新
- `issueCombinedReceipt(token, data)`: 合算領収書発行（管理者専用）
  - パラメータ: `event_id`, `member_ids`（配列）, `company_name`（宛名）, `receipt_note`（但し書き）, `detail_note`（内訳メモ）
  - 全メンバーの支払い済みチェック
  - 合計金額を計算
  - PDF生成、Google Drive保存
  - `receipts`テーブルに`is_combined=true`で記録
  - 各メンバーの`payments`テーブル更新
- `generateReceiptPDF(data)`: PDF生成（Google Docsテンプレート使用）
- `generateReceiptNumber(eventId, memberId, isCombined)`: 領収書番号生成
  - 通常: `YYYYMM-EventID-MemberID`
  - 合算: `YYYYMM-EventID-COMBINED-連番`

#### 分析系
- `getAnalytics(token, filters)`: 出席率分析

#### マスタ系
- `getMasters(token)`: マスタデータ取得

---

## 5️⃣ フロントエンド構成（GitHub Pages）

### 5.1 ファイル構造

```
attendance-app/
├── index.html              # ログイン画面
├── home.html               # HOME画面
├── events.html             # イベント一覧
├── event-detail.html       # イベント詳細・出欠登録
├── history.html            # 出欠履歴
├── qr.html                 # QRコード表示（新規）
├── receipts.html           # 領収書発行
├── profile.html            # プロフィール編集（新規）
├── admin/
│   ├── dashboard.html      # 管理者ダッシュボード
│   ├── events.html         # イベント管理
│   ├── event-form.html     # イベント登録・編集
│   ├── members.html        # メンバー管理
│   ├── analytics.html      # 出席率分析
│   ├── payments.html       # 支払い管理
│   └── checkin.html        # QRコードリーダー
├── receipts.html           # 領収書発行
├── css/
│   ├── common.css          # 共通スタイル
│   ├── user.css            # ユーザー画面用
│   └── admin.css           # 管理者画面用
└── js/
    ├── config.js           # 設定（API URL等）
    ├── api.js              # API通信
    ├── auth.js             # 認証処理
    ├── cache.js            # キャッシュ管理
    ├── events.js           # イベント処理
    ├── attendance.js       # 出欠処理
    ├── members.js          # メンバー処理
    ├── checkin.js          # チェックイン処理
    ├── qr.js               # QRコード生成処理（新規）
    ├── qr-scanner.js       # QRコードスキャン処理（jsQR利用）
    ├── payments.js         # 支払い管理処理
    ├── receipts.js         # 領収書処理
    ├── analytics.js        # 分析処理
    └── utils.js            # ユーティリティ
```

### 5.2 共通JavaScriptモジュール

#### config.js
```javascript
const CONFIG = {
  API_URL: 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec',
  APP_NAME: 'グローバルデザイン推進委員会 出欠管理',
  CACHE_TTL: 5 * 60 * 1000 // 5分
};
```

#### api.js
```javascript
const API = {
  async call(action, params = {}) {
    const token = localStorage.getItem('authToken');
    const url = new URL(CONFIG.API_URL);
    
    url.searchParams.append('action', action);
    if (token) url.searchParams.append('token', token);
    
    Object.keys(params).forEach(key => {
      if (typeof params[key] === 'object') {
        url.searchParams.append(key, JSON.stringify(params[key]));
      } else {
        url.searchParams.append(key, params[key]);
      }
    });
    
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.error === 'Unauthorized') {
      Auth.logout();
      window.location.href = '/index.html';
      throw new Error('認証エラー');
    }
    
    return data;
  }
};
```

#### auth.js
```javascript
const Auth = {
  async login(login_id, password) {
    const result = await API.call('login', { login_id, password });
    
    if (result.success) {
      localStorage.setItem('authToken', result.token);
      localStorage.setItem('userRole', result.role);
      localStorage.setItem('memberId', result.member_id);
      localStorage.setItem('userName', result.name);
      return true;
    }
    return false;
  },
  
  logout() {
    const token = localStorage.getItem('authToken');
    if (token) {
      API.call('logout', {}).catch(() => {});
    }
    localStorage.clear();
  },
  
  isLoggedIn() {
    return !!localStorage.getItem('authToken');
  },
  
  isAdmin() {
    return localStorage.getItem('userRole') === 'admin';
  },
  
  getUserInfo() {
    return {
      memberId: localStorage.getItem('memberId'),
      name: localStorage.getItem('userName'),
      role: localStorage.getItem('userRole')
    };
  }
};
```

#### cache.js
```javascript
const Cache = {
  set(key, value, ttl = CONFIG.CACHE_TTL) {
    const item = {
      value: value,
      timestamp: Date.now(),
      ttl: ttl
    };
    localStorage.setItem(`cache_${key}`, JSON.stringify(item));
  },
  
  get(key) {
    const itemStr = localStorage.getItem(`cache_${key}`);
    if (!itemStr) return null;
    
    const item = JSON.parse(itemStr);
    if (Date.now() - item.timestamp > item.ttl) {
      localStorage.removeItem(`cache_${key}`);
      return null;
    }
    
    return item.value;
  },
  
  remove(key) {
    localStorage.removeItem(`cache_${key}`);
  },
  
  clear() {
    const keys = Object.keys(localStorage);
    keys.forEach(key => {
      if (key.startsWith('cache_')) {
        localStorage.removeItem(key);
      }
    });
  }
};
```

#### events.js
```javascript
const Events = {
  async getAll(forceRefresh = false) {
    if (!forceRefresh) {
      const cached = Cache.get('events');
      if (cached) return cached;
    }
    
    const events = await API.call('getEvents');
    Cache.set('events', events);
    return events;
  },
  
  async getDetail(event_id) {
    const cached = Cache.get(`event_${event_id}`);
    if (cached) return cached;
    
    const event = await API.call('getEventDetail', { event_id });
    Cache.set(`event_${event_id}`, event);
    return event;
  },
  
  async add(data) {
    const result = await API.call('addEvent', { data: data });
    Cache.remove('events');
    return result;
  },
  
  async update(data) {
    const result = await API.call('updateEvent', { data: data });
    Cache.remove('events');
    Cache.remove(`event_${data.event_id}`);
    return result;
  },
  
  async delete(event_id) {
    const result = await API.call('deleteEvent', { event_id });
    Cache.remove('events');
    Cache.remove(`event_${event_id}`);
    return result;
  }
};
```

#### qr.js（QRコード生成）
```javascript
const QR = {
  generateQRCodeURL(memberId) {
    const baseUrl = 'https://chart.googleapis.com/chart';
    const params = new URLSearchParams({
      cht: 'qr',           // QRコード
      chs: '300x300',      // サイズ: 300x300
      chl: memberId        // データ: member_id
    });
    return `${baseUrl}?${params.toString()}`;
  },

  displayMemberQR() {
    const userInfo = Auth.getUserInfo();
    const qrUrl = this.generateQRCodeURL(userInfo.memberId);

    document.getElementById('memberName').textContent = `${userInfo.name}さん`;
    document.getElementById('memberId').textContent = userInfo.memberId;
    document.getElementById('qrImage').src = qrUrl;
    document.getElementById('qrImage').alt = `${userInfo.memberId} QR Code`;
  }
};
```

#### qr-scanner.js（QRコードスキャン）
```javascript
// jsQRライブラリを使用（CDN: https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js）
const QRScanner = {
  video: null,
  canvas: null,
  ctx: null,
  scanning: false,

  init() {
    this.video = document.getElementById('qr-video');
    this.canvas = document.getElementById('qr-canvas');
    this.ctx = this.canvas.getContext('2d');
  },

  async start() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
      });
      this.video.srcObject = stream;
      this.video.play();
      this.scanning = true;
      this.scan();
    } catch (error) {
      alert('カメラへのアクセスが拒否されました');
    }
  },

  scan() {
    if (!this.scanning) return;

    if (this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
      this.canvas.width = this.video.videoWidth;
      this.canvas.height = this.video.videoHeight;
      this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);

      const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code) {
        this.onScanSuccess(code.data);
        this.stop();
        return;
      }
    }

    requestAnimationFrame(() => this.scan());
  },

  stop() {
    this.scanning = false;
    if (this.video.srcObject) {
      this.video.srcObject.getTracks().forEach(track => track.stop());
    }
  },

  onScanSuccess(memberId) {
    // チェックイン処理（admin/checkin.htmlで実装）
    console.log('Scanned member_id:', memberId);
  }
};
```

---

## 6️⃣ UI設計

### 6.1 ユーザー画面

#### ログイン画面（index.html）
- ID・パスワード入力
- **「ログイン情報を保存」チェックボックス**
  - チェックON: ログイン情報をlocalStorageに保存
  - チェックOFF: セッションのみ（ブラウザ閉じたら再入力）
- ログインボタン
- エラーメッセージ表示

**ログイン情報保存機能**:
- 初回ログイン時に「ログイン情報を保存」にチェックを入れてログイン
- 次回アクセス時、保存されたIDとパスワードが自動入力される
- 「ログイン」ボタンをクリックするだけでログイン可能
- セキュリティ上、パスワードは暗号化してlocalStorageに保存
- ログアウト時に「ログイン情報を削除」オプションを表示

#### HOME画面（home.html）
- 至急登録イベント表示
- 直近3つイベント表示
- 出欠未登録のイベントを締切日が近い順で表示
- **QRコード表示ボタン**（タップでqr.htmlへ遷移）
- ナビゲーション（イベント一覧、履歴、領収書、プロフィール、ログアウト）

#### QRコード表示画面（qr.html）新規
- **自分のQRコード表示**
  - member_idを含むQRコード
  - Google Charts APIで生成: `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl={member_id}`
  - 名前表示: 「山田太郎さんのQRコード」
  - 説明文: 「受付でこのQRコードを提示してください」
- **表示例**:
  ```
  ┌─────────────────────┐
  │  山田太郎さん       │
  │                     │
  │   ■■■■■■■■■   │
  │   ■      ■      ■   │
  │   ■ ■■■ ■ ■■ ■   │
  │   ■ ■■■ ■ ■■ ■   │
  │   ■■■■■■■■■   │
  │                     │
  │  M001               │
  │                     │
  │ 受付でこのQRコード  │
  │ を提示してください  │
  └─────────────────────┘
  ```
- 戻るボタン（HOME画面へ）

#### イベント一覧（events.html）
- カード型表示
- フィルター（日付、タグ、主催者）
- 出欠状況アイコン表示

#### イベント詳細（event-detail.html）
- イベント情報表示（**display_fieldsの設定に従って表示/非表示を切り替え**）
- 出欠登録フォーム（タイプA/B対応）
- メモ入力
- MAPリンク（表示設定がONの場合のみ）

#### 履歴画面（history.html）
- 過去の出欠一覧
- 実出席記録表示
- 締切日前イベントは「編集」ボタン

#### 領収書発行画面（receipts.html）新規
- **表示条件**: イベント登録時に`receipt_enabled=true`のイベントのみ表示
- **対象**: 自分が参加したイベント（出欠登録済み）のみ
- **表形式表示**:
  - イベント開催日
  - イベント名
  - 出欠（事前登録）: ○ / × / 未定
  - 実出欠: ○（チェックイン済み） / ×（未チェックイン）
  - 登録料: 支払済 / 未払い
  - キャンセル料発生: キャンセル料ありの場合「済」「未」表示
  - 領収書発行: 「発行可能」「発行済み」「発行不可」

**発行可能条件**:
- `receipt_enabled=true`（イベントで領収書発行が有効）
- かつ、以下のいずれか:
  - 登録料が支払済（`payments.paid=true`）
  - キャンセル料が支払済（キャンセル料レコードの`paid=true`）
- 未発行（`payments.receipt_issued=false`）

**表示例**:
```
イベント開催日 | イベント名      | 出欠 | 実出欠 | 登録料 | キャンセル料 | 領収書発行
2025-12-02   | 理事長卒業式    | ○   | ○     | 済    | -          | [発行可能]
2025-12-05   | 最終委員会      | ○   | ○     | 未    | -          | 発行不可
2025-11-25   | 11月度委員会    | ○   | ×     | -     | 未         | 発行不可
2025-10-20   | 10月度委員会    | ○   | ×     | 済    | -          | [発行可能] or [PDF表示]
```

- **領収書発行モーダル**（「発行可能」ボタンクリック時）:
  - **宛名入力**（デフォルト：会社名）
    - `members.company_name`を初期表示
    - 変更可能（例：個人名、別の会社名など）
  - **但し書き入力**（デフォルト：イベントのreceipt_note_default）
    - プルダウン + 自由入力
    - 変更可能
  - 発行ボタン
- 発行後、PDFを新しいタブで表示
- 発行済みの場合、PDFリンクをクリックで再表示可能

#### プロフィール編集画面（profile.html）新規
- **プロフィール情報表示・編集**
  - 名前（name）: 表示のみ（編集不可）
  - ふりがな（kana）: 編集可能
  - 所属（affiliation）: プルダウン選択（affiliations_master）
  - 役職（position）: プルダウン選択（positions_master）
  - 委員会（committee）: プルダウン選択（committees_master）
  - 会社名（company_name）: 編集可能
  - 誕生日（birthday）: カレンダー選択
  - **プロフィール写真**:
    - 現在の写真を表示（PhotoURLがある場合）
    - 「写真を変更」ボタン
    - ファイル選択（jpg, png, 最大5MB）
    - アップロード後、Google Driveに保存しURLを取得
  - 「保存」ボタン

- **パスワード変更セクション**
  - 現在のパスワード入力
  - 新しいパスワード入力
  - 新しいパスワード（確認）入力
  - 「パスワード変更」ボタン
  - パスワード要件表示: 「8文字以上」

- **ナビゲーション**
  - 「HOME画面へ戻る」ボタン

### 6.2 管理者画面

#### ダッシュボード（admin/dashboard.html）
- イベント数
- 出欠率
- 未回答者数
- 最近のイベント一覧

#### イベント管理（admin/events.html）
- イベント一覧（表形式）
- 編集・削除ボタン
- 出欠確認ボタン
- 新規登録ボタン

#### イベント登録・編集（admin/event-form.html）
- 詳細項目入力フォーム
- カレンダー連携ON/OFF
- プレビュー機能

#### メンバー管理（admin/members.html）
- メンバー一覧
- 編集・削除ボタン
- 新規登録フォーム
- 写真アップロード対応

#### 出席率分析（admin/analytics.html）
- グラフ表示
- フィルター（期間、役職、所属、タグ）
- CSV出力ボタン

#### 誕生日一覧
- メンバー一覧から表示

#### QRコードリーダー（admin/checkin.html）
- イベント選択
- **QRコード読み取り機能**
  - カメラ起動ボタン
  - QRコードスキャン（jsQRライブラリ使用）
  - member_idを読み取り → 自動的にチェックイン処理
  - 成功時: 「山田太郎さん チェックイン完了」と表示
  - エラー時: エラーメッセージ表示
- **ID手動入力**
  - member_id手動入力フィールド
  - 「チェックイン」ボタン
- **現地払いの場合、支払い確認チェックボックス表示**
  - QRコード読み取り後、現地払いの場合のみ表示
  - 「支払い確認」チェックボックス
  - チェック時: `payments.paid=true`に更新
- **チェックイン状況表示**
  - 出席予定者数
  - チェックイン済メンバー数
  - 出席率（%）
- **チェックイン履歴**（リアルタイム更新）
  - 時刻、メンバー名、member_id、支払い状況
  - 最新のチェックインが上に表示

#### 支払い管理（admin/payments.html）新規
- 未払い一覧（タブ）
- 支払い済み一覧（タブ）
- キャンセル料一覧（タブ）
- 銀行振込確認ボタン
- キャンセル料受領確認ボタン
- フィルター機能（イベント、メンバー、支払い方法）

#### 領収書管理（admin/receipts.html）新規
- **通常発行**:
  - イベント選択
  - **メンバー選択UI**:
    - 所属（affiliation）フィルター（プルダウン）
    - 選択した所属のメンバーのみ表示
    - メンバー選択（ラジオボタン）
  - 宛名入力（デフォルト: 選択メンバーの会社名、変更可能）
  - 但し書き入力
  - 発行ボタン

- **合算発行**（代理支払い対応）:
  - イベント選択
  - **メンバー複数選択UI**:
    - 所属（affiliation）フィルター（プルダウン）「全て表示」も選択可能
    - 選択した所属のメンバーのみ表示（支払済のみ）
    - メンバー複数選択（チェックボックス）
      ```
      [所属フィルター: 営業部 ▼]

      ☑ 山田太郎（5,000円）- 支払済
      ☑ 佐藤花子（5,000円）- 支払済
      ☑ 鈴木一郎（5,000円）- 支払済
      合計金額: 15,000円
      ```
  - 宛名入力（代理支払者の会社名・個人名）
  - 但し書き入力
  - 内訳メモ（任意）：「山田、佐藤、鈴木の3名分」
  - 発行ボタン

- **発行済み領収書一覧**:
  - 領収書番号、発行日、イベント名、宛名、金額、PDF表示
  - 合算領収書は「合算」バッジ表示
  - フィルター機能（イベント、所属、発行日）

---

## 7️⃣ 処理仕様

### 7.1 ログイン認証

#### 基本フロー
1. `login_id` と `password` を照合（平文）
2. 認証成功時、トークンを生成・返却
3. トークンを `sessions` シートに保存（有効期限24時間）
4. フロントエンドは `localStorage` にトークン保存

#### ログイン情報保存機能

**保存処理**:
1. ユーザーが「ログイン情報を保存」にチェックを入れてログイン
2. ログイン成功後、以下の情報をlocalStorageに保存:
   - `saved_login_id`: ログインID（平文）
   - `saved_password`: パスワード（Base64エンコード）
   - `remember_me`: true
3. 次回ログイン画面表示時、localStorageから読み込み自動入力

**自動入力フロー**:
1. ログイン画面を開く
2. localStorageに `remember_me=true` が存在するかチェック
3. 存在する場合:
   - `saved_login_id` を読み込み、IDフィールドに自動入力
   - `saved_password` をBase64デコードし、パスワードフィールドに自動入力
   - 「ログイン情報を保存」チェックボックスをON
4. ユーザーは「ログイン」ボタンをクリックするだけでログイン完了

**削除処理**:
1. ログアウト画面に「ログイン情報を削除」チェックボックスを表示
2. チェックONでログアウトすると、以下を削除:
   - `saved_login_id`
   - `saved_password`
   - `remember_me`
3. 次回ログイン時は手動入力が必要

**実装例（フロントエンド）**:
```javascript
// auth.js - ログイン情報保存機能

const Auth = {
  // ログイン処理
  async login(loginId, password, rememberMe) {
    const result = await API.call('login', {
      login_id: loginId,
      password: password
    });

    if (result.success) {
      // トークンを保存
      localStorage.setItem('token', result.token);
      localStorage.setItem('user', JSON.stringify(result.user));

      // ログイン情報を保存（チェックONの場合）
      if (rememberMe) {
        localStorage.setItem('saved_login_id', loginId);
        localStorage.setItem('saved_password', btoa(password)); // Base64エンコード
        localStorage.setItem('remember_me', 'true');
      }

      return result;
    }
    throw new Error(result.error || 'ログインに失敗しました');
  },

  // ログイン画面で保存済みログイン情報を読み込み
  loadSavedCredentials() {
    const rememberMe = localStorage.getItem('remember_me') === 'true';

    if (rememberMe) {
      const loginId = localStorage.getItem('saved_login_id');
      const encodedPassword = localStorage.getItem('saved_password');

      if (loginId && encodedPassword) {
        return {
          loginId: loginId,
          password: atob(encodedPassword), // Base64デコード
          rememberMe: true
        };
      }
    }

    return null;
  },

  // ログアウト時にログイン情報を削除
  logout(clearCredentials = false) {
    // トークンとユーザー情報を削除
    localStorage.removeItem('token');
    localStorage.removeItem('user');

    // ログイン情報も削除する場合
    if (clearCredentials) {
      localStorage.removeItem('saved_login_id');
      localStorage.removeItem('saved_password');
      localStorage.removeItem('remember_me');
    }

    window.location.href = 'index.html';
  }
};
```

**ログイン画面の実装例（index.html）**:
```html
<form id="loginForm">
  <div>
    <label>ログインID</label>
    <input type="text" id="loginId" required>
  </div>
  <div>
    <label>パスワード</label>
    <input type="password" id="password" required>
  </div>
  <div>
    <label>
      <input type="checkbox" id="rememberMe">
      ログイン情報を保存
    </label>
  </div>
  <button type="submit">ログイン</button>
  <div id="error" style="color:red;"></div>
</form>

<script>
// ページ読み込み時に保存済みログイン情報を復元
window.addEventListener('DOMContentLoaded', () => {
  const saved = Auth.loadSavedCredentials();

  if (saved) {
    document.getElementById('loginId').value = saved.loginId;
    document.getElementById('password').value = saved.password;
    document.getElementById('rememberMe').checked = saved.rememberMe;
  }
});

// ログインフォーム送信
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const loginId = document.getElementById('loginId').value;
  const password = document.getElementById('password').value;
  const rememberMe = document.getElementById('rememberMe').checked;

  try {
    await Auth.login(loginId, password, rememberMe);
    window.location.href = 'home.html';
  } catch (error) {
    document.getElementById('error').textContent = error.message;
  }
});
</script>
```

**ログアウト画面の実装例**:
```html
<div id="logoutModal">
  <h3>ログアウトしますか？</h3>
  <label>
    <input type="checkbox" id="clearCredentials">
    ログイン情報を削除
  </label>
  <button onclick="logout()">ログアウト</button>
  <button onclick="closeModal()">キャンセル</button>
</div>

<script>
function logout() {
  const clearCredentials = document.getElementById('clearCredentials').checked;
  Auth.logout(clearCredentials);
}
</script>
```

**セキュリティ注意事項**:
- パスワードはBase64エンコードのみ（暗号化ではない）
- 共有PCでは「ログイン情報を保存」を使用しない
- 公共のデバイスでは必ず「ログイン情報を削除」してログアウト
- より高度なセキュリティが必要な場合は、Web Crypto APIで暗号化を検討

### 7.2 出欠登録
1. `attendance` テーブルに記録
2. 締切日チェック
3. 既存登録がある場合は更新
4. キャッシュクリア

### 7.3 実出席記録（QR受付）

#### メンバーQRコード生成
1. メンバーがqr.htmlを開く
2. Google Charts APIを使用してQRコード画像を生成
   - URL: `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl={member_id}`
   - 例: `chl=M001`（member_idのみをエンコード）
3. QRコードをIMGタグで表示
4. メンバー名とIDを併記

**実装例（フロントエンド）**:
```javascript
// qr.html
const memberId = Auth.getUserInfo().memberId;
const memberName = Auth.getUserInfo().name;
const qrCodeUrl = `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=${encodeURIComponent(memberId)}`;

document.getElementById('memberName').textContent = `${memberName}さん`;
document.getElementById('memberId').textContent = memberId;
document.getElementById('qrImage').src = qrCodeUrl;
```

#### QRコード読み取りフロー
1. 管理者が受付端末で`/admin/checkin.html`を開く
2. イベント選択（event_id）
3. **QRコードスキャン**:
   - カメラボタンをクリック → カメラ起動
   - jsQRライブラリでQRコードを読み取り
   - member_idを取得
4. **チェックイン処理**:
   - GAS APIに`event_id`と`member_id`を送信
   - GASが`checkin`テーブルに記録
   - 重複チェック（同じevent_id + member_idは登録済みエラー）
5. **現地払いの場合**:
   - チェックイン成功後、支払い方法を確認
   - 現地払いの場合、「支払い確認」チェックボックスを表示
   - チェック時、`payments.paid=true`、`paid_at`に現在時刻を記録
6. **成功メッセージ表示**: 「山田太郎さん チェックイン完了」

**実装例（QRスキャン）**:
```javascript
// admin/checkin.html
import jsQR from 'jsqr';

function startQRScanner() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      video.srcObject = stream;
      video.play();
      scanQR();
    });

  function scanQR() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code) {
        const memberId = code.data; // member_idを取得
        checkin(memberId); // チェックイン処理
        stopScanner();
      }
    }
    requestAnimationFrame(scanQR);
  }
}

async function checkin(memberId) {
  const result = await API.call('checkin', {
    event_id: currentEventId,
    member_id: memberId
  });

  if (result.success) {
    showMessage(`${result.member_name}さん チェックイン完了`);

    // 現地払いの場合、支払い確認UIを表示
    if (result.payment_method === '現地払い' && !result.paid) {
      showPaymentConfirmation(memberId);
    }
  }
}
```

### 7.4 支払い管理
#### 現地払いの場合
1. メンバーが出欠登録（参加・現地払い選択）
2. `payments`テーブルにレコード作成（paid=false）
3. イベント当日、受付でQRコード読み取り時に「支払い完了」チェック
4. `paid=true`に更新、`paid_at`に日時記録

#### 銀行振込の場合
1. メンバーが出欠登録（参加・銀行振込選択）
2. `payments`テーブルにレコード作成（paid=false）
3. メンバーが銀行振込実施
4. 管理者が管理画面（admin/payments.html）で確認
5. 「振込確認」ボタンクリック → `paid=true`、`paid_by_admin=true`に更新

#### キャンセル料の場合
1. メンバーがキャンセル（以下のいずれかの場合にキャンセル料発生）:
   - **パターン1**: 出席で登録 → キャンセル料発生日以降に欠席に変更
   - **パターン2**: 出席で登録 → 当日欠席（実出席なし）
2. `payments`テーブルにキャンセル料レコード作成
3. 管理者が振込/現金受領確認
4. 「受領確認」ボタンクリック → `paid=true`に更新

### 7.5 領収書発行

#### 発行可能条件
1. イベントで領収書発行が有効（`events.receipt_enabled=true`）
2. 自分が出欠登録しているイベント
3. 以下のいずれかを満たす:
   - 登録料の支払いが完了（`payments.paid=true`）
   - キャンセル料の支払いが完了（キャンセル料レコードの`paid=true`）
4. まだ領収書が発行されていない（`payments.receipt_issued=false`）

#### 発行フロー
1. メンバーが領収書発行画面（receipts.html）を開く
2. `receipt_enabled=true`のイベント一覧を表示
   - イベント開催日、イベント名
   - 出欠（事前登録）: ○ / × / 未定
   - 実出欠（チェックイン）: ○ / ×
   - 登録料: 支払済 / 未払い
   - キャンセル料: 済 / 未 / -
   - 領収書発行: 発行可能 / 発行済み / 発行不可
3. 「発行可能」ボタンクリック → モーダル表示
4. 宛名、但し書きを入力
   - **宛名**: デフォルトで`members.company_name`を表示、変更可能
   - **但し書き**: デフォルトで`events.receipt_note_default`を表示、変更可能（空欄の場合「イベント名 参加費として」）
5. 発行ボタンクリック
6. GASで領収書番号生成（**年月-イベントID-メンバーID形式：202506-EVT001-M001**）
7. Google DocsテンプレートからPDF生成
8. Google Driveの指定フォルダに保存
9. `receipts`テーブルに記録
10. `payments`テーブルの`receipt_issued=true`、`receipt_url`、`receipt_number`、`receipt_issued_at`を更新
11. PDFをブラウザで表示

**領収書番号の形式**:
- `YYYYMM-EventID-MemberID`
- 例: `202506-EVT001-M001`（2025年6月、イベントEVT001、メンバーM001）
- この形式により重複の心配がなく、どのイベント・誰の領収書かが一目で分かる

**キャンセル料の領収書**:
- キャンセル料を支払った場合も領収書発行可能
- 但し書きは「キャンセル料として」などに変更可能

### 7.6 合算領収書発行（管理者専用）

#### 用途
- 代理支払い: 1人が複数人分の参加費をまとめて支払った場合
- 例: Aさんが自分とB、Cの3名分（合計15,000円）を支払い、Aさんの会社名で領収書発行

#### 発行フロー
1. 管理者が領収書管理画面（admin/receipts.html）を開く
2. 「合算発行」タブを選択
3. イベントを選択
4. **所属フィルター**を選択（プルダウン）
   - affiliations_masterから所属一覧を表示
   - 「全て表示」も選択可能
5. 支払済のメンバーから複数選択（チェックボックス）
   - 選択した所属のメンバーのみ表示
   - 各メンバーの金額を表示
   - 合計金額を自動計算
6. 宛名入力（代理支払者の会社名・個人名）
7. 但し書き入力（デフォルト: イベントのreceipt_note_default）
8. 内訳メモ入力（任意）：「山田、佐藤、鈴木の3名分」
9. 発行ボタンクリック
10. GASで領収書番号生成（**年月-イベントID-COMBINED-連番形式：202506-EVT001-COMBINED-001**）
11. Google DocsテンプレートからPDF生成
    - 宛名: 入力された宛名
    - 金額: 合計金額
    - 内訳: 内訳メモ（PDFに記載）
12. Google Driveの指定フォルダに保存
13. `receipts`テーブルに記録
    - `is_combined=true`
    - `member_ids`に対象メンバーID（カンマ区切り）
    - `detail_note`に内訳メモ
14. 各メンバーの`payments`テーブルの`receipt_issued=true`、`receipt_url`、`receipt_number`を更新
15. PDFをブラウザで表示

**領収書番号の形式（合算の場合）**:
- `YYYYMM-EventID-COMBINED-連番`
- 例: `202506-EVT001-COMBINED-001`（2025年6月、イベントEVT001、合算領収書の1枚目）
- 連番は同じイベントの合算領収書ごとに増加

**注意事項**:
- 合算対象のメンバーは全員「支払済」である必要がある
- 合算発行後、各メンバーは個別に領収書を再発行できない（合算領収書のPDFを共有）

### 7.7 プロフィール編集

#### プロフィール情報更新
1. メンバーがprofile.htmlを開く
2. 現在のプロフィール情報を取得して表示
3. フィールドを編集
   - kana, affiliation, position, committee, company_name, birthday
4. 「保存」ボタンクリック
5. GAS APIに更新データを送信
6. `members`テーブルの自分のレコードを更新
7. 成功メッセージ表示

#### プロフィール写真アップロード
1. 「写真を変更」ボタンクリック
2. ファイル選択ダイアログ表示
3. 画像ファイル選択（jpg, png, 最大5MB）
4. **Base64エンコード**してGAS APIに送信
5. GAS側の処理:
   - Base64をデコード
   - Google Driveの指定フォルダ（例: `profile_photos/`）に保存
   - ファイル名: `{member_id}_{timestamp}.jpg`
   - 共有設定: リンクを知っている全員が閲覧可能
   - ファイルURLを取得
6. `members`テーブルの`PhotoURL`を更新
7. 画面に新しい写真を表示

**実装例（フロントエンド）**:
```javascript
// profile.html
async function uploadPhoto(file) {
  if (file.size > 5 * 1024 * 1024) {
    alert('ファイルサイズは5MB以下にしてください');
    return;
  }

  const reader = new FileReader();
  reader.onload = async (e) => {
    const base64Data = e.target.result.split(',')[1];

    const result = await API.call('uploadProfilePhoto', {
      fileData: base64Data,
      fileName: file.name,
      mimeType: file.type
    });

    if (result.success) {
      document.getElementById('profilePhoto').src = result.photoURL;
      alert('写真を更新しました');
    }
  };
  reader.readAsDataURL(file);
}
```

**実装例（GAS）**:
```javascript
function uploadProfilePhoto(token, params) {
  const session = getSession(token);
  if (!session) return { error: 'Unauthorized' };

  const memberId = session.member_id;
  const fileData = Utilities.base64Decode(params.fileData);
  const fileName = `${memberId}_${Date.now()}.jpg`;

  // Google Driveに保存
  const folder = DriveApp.getFolderById('YOUR_FOLDER_ID');
  const blob = Utilities.newBlob(fileData, params.mimeType, fileName);
  const file = folder.createFile(blob);

  // 共有設定
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

  const photoURL = file.getUrl();

  // membersテーブル更新
  updateMemberPhotoURL(memberId, photoURL);

  return { success: true, photoURL: photoURL };
}
```

#### パスワード変更
1. パスワード変更セクションで入力
   - 現在のパスワード
   - 新しいパスワード（8文字以上）
   - 新しいパスワード（確認）
2. 「パスワード変更」ボタンクリック
3. フロントエンドで新しいパスワードの一致を確認
4. GAS APIに送信
5. GAS側の処理:
   - 現在のパスワードを検証
   - 検証成功時、新しいパスワードに更新
   - `members`テーブルの`password`を更新
6. 成功メッセージ表示
7. 既存のセッショントークンは無効化（再ログイン不要）

**実装例（GAS）**:
```javascript
function changePassword(token, params) {
  const session = getSession(token);
  if (!session) return { error: 'Unauthorized' };

  const memberId = session.member_id;
  const currentPassword = params.current_password;
  const newPassword = params.new_password;

  // 現在のパスワード検証
  const member = getMemberById(memberId);
  if (member.password !== currentPassword) {
    return { success: false, error: '現在のパスワードが正しくありません' };
  }

  // パスワード要件チェック
  if (newPassword.length < 8) {
    return { success: false, error: 'パスワードは8文字以上にしてください' };
  }

  // パスワード更新
  updateMemberPassword(memberId, newPassword);

  return { success: true, message: 'パスワードを変更しました' };
}
```

### 7.8 Googleカレンダー連携
1. 団体カレンダーID（例：`jci-events@group.calendar.google.com`）に予定登録
2. OAuth認証 + イベント情報送信
3. GAS側で Calendar API 使用

---

## 8️⃣ 実装順序

### フェーズ1：バックエンド構築
1. Google Sheets のテーブル作成
2. Code.gs の基本構造実装
3. 認証API実装（login, logout, isValidToken）
4. イベントAPI実装（CRUD操作）
5. 出欠API実装
6. Web App としてデプロイ
7. APIテスト

### フェーズ2：管理者画面（先に作成）
1. 共通JSモジュール作成（config, api, auth, cache）
2. 管理者ログイン画面（index.html）
3. メンバー管理（admin/members.html）
   - メンバー一覧表示
   - メンバー登録フォーム
   - テストユーザー作成
4. イベント登録・編集（admin/event-form.html）
   - イベント登録フォーム
   - 表示項目選択機能
   - **領収書 但し書きデフォルト設定**
   - テストイベント作成
5. イベント管理（admin/events.html）
   - イベント一覧表示
   - 編集・削除機能
6. 支払い管理（admin/payments.html）
   - 未払い一覧
   - 支払い確認機能
   - キャンセル料管理
7. ダッシュボード（admin/dashboard.html）
8. 出席率分析（admin/analytics.html）
9. QRコードリーダー（admin/checkin.html）
   - 支払い確認機能追加

### フェーズ3：ユーザー画面（管理者画面でデータ作成後）
1. ユーザーログイン機能追加（index.html）
2. HOME画面（home.html）
3. イベント一覧（events.html）
4. イベント詳細・出欠登録（event-detail.html）
   - display_fields対応
5. 履歴画面（history.html）
6. 領収書発行画面（receipts.html）
   - 発行可能イベント一覧
   - 宛名・但し書き入力
   - PDF生成・ダウンロード
7. QRコード表示機能

### フェーズ4：高度な機能
1. Googleカレンダー連携
2. CSV出力機能
3. 写真アップロード機能
4. 分析グラフ表示
5. 領収書PDF生成の最適化
6. Google Drive連携の強化

---

## 9️⃣ デプロイ手順

### GAS側
1. Google Sheets 作成
2. Apps Script エディタでコード実装
3. 「デプロイ」→「新しいデプロイ」
4. 種類：ウェブアプリ
5. アクセス権限：「全員」
6. デプロイURLを取得

### GitHub Pages側
1. GitHubリポジトリ作成
2. HTMLファイルをプッシュ
3. **検索エンジン対策ファイルを追加**:
   - `robots.txt` をルートに配置（後述）
   - 全HTMLファイルの`<head>`に noindex メタタグを追加
4. Settings → Pages → Source: main branch
5. `js/config.js` に Cloudflare Workers のエンドポイントURLを設定
6. 公開URLアクセス

### Cloudflare Workers側
1. Cloudflareアカウント作成（無料プラン可）
2. Workers & Pages → Create application → Create Worker
3. Worker名を設定（例: `attendance-api-proxy`）
4. プロキシコードをデプロイ（後述）
5. 環境変数に GAS デプロイURLを設定
6. Workers URLを取得（例: `https://attendance-api-proxy.yourname.workers.dev`）
7. このURLを `js/config.js` の `API_URL` に設定

---

## 🔒 セキュリティ設定詳細

### 1. 検索エンジン対策

#### robots.txt（ルートディレクトリに配置）
```
User-agent: *
Disallow: /
```

#### HTMLファイルの`<head>`タグ内に追加
すべての HTML ファイルに以下を追加:
```html
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 検索エンジン対策 -->
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>出欠管理システム</title>
  ...
</head>
```

**効果**:
- Google、Bing、その他の検索エンジンでインデックスされない
- 検索結果に表示されない
- URLを知っている人のみアクセス可能

---

### 2. Cloudflare Workers プロキシ設定

#### Workers コード例

```javascript
/**
 * Cloudflare Workers - GAS API Proxy
 * フロントエンドとGAS APIの間に立ち、実際のGAS URLを隠蔽する
 */

// 環境変数に設定するGAS API URL
// Cloudflare Dashboard → Workers → Settings → Variables → Environment Variables
// 変数名: GAS_API_URL
// 値: https://script.google.com/macros/s/AKfycbxxx.../exec

export default {
  async fetch(request, env) {
    // CORS対応
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*', // 本番環境では特定のドメインに制限推奨
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
    };

    // プリフライトリクエスト対応
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        status: 204,
        headers: corsHeaders,
      });
    }

    try {
      // リクエストボディを取得
      const body = await request.text();

      // GAS APIにリクエストを転送
      const gasResponse = await fetch(env.GAS_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: body,
      });

      // GASからのレスポンスを取得
      const responseData = await gasResponse.text();

      // CORSヘッダーを付けてレスポンスを返す
      return new Response(responseData, {
        status: gasResponse.status,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json',
        },
      });
    } catch (error) {
      // エラーハンドリング
      return new Response(
        JSON.stringify({
          error: 'Proxy Error',
          message: error.message,
        }),
        {
          status: 500,
          headers: {
            ...corsHeaders,
            'Content-Type': 'application/json',
          },
        }
      );
    }
  },
};
```

#### 環境変数の設定手順
1. Cloudflare Dashboard → Workers & Pages
2. 作成したWorkerを選択
3. Settings → Variables
4. Environment Variables → Add variable
   - Variable name: `GAS_API_URL`
   - Value: `https://script.google.com/macros/s/AKfycbxxx.../exec`（実際のGAS デプロイURL）
   - Type: `Secret` を選択（暗号化される）
5. Deploy

#### フロントエンド側の設定（js/config.js）
```javascript
const CONFIG = {
  // Cloudflare Workers のエンドポイント（GAS URLではない）
  API_URL: 'https://attendance-api-proxy.yourname.workers.dev',

  APP_NAME: 'グローバルデザイン推進委員会 出欠管理',
  CACHE_TTL: 5 * 60 * 1000, // 5分
  SESSION_TIMEOUT: 24 * 60 * 60 * 1000 // 24時間
};
```

**セキュリティ効果**:
- フロントエンドのコードに GAS の実際のURLが記載されない
- ブラウザの開発者ツールで GAS URLを直接確認できない
- Cloudflare Workers の環境変数は暗号化されて保存される
- 不正アクセスのリスクが大幅に低減

**注意事項**:
- 本番環境では `Access-Control-Allow-Origin` を特定のドメインに制限することを推奨
  ```javascript
  'Access-Control-Allow-Origin': 'https://yourusername.github.io'
  ```
- Cloudflare Workers の無料プランでは 1日あたり 100,000 リクエストまで利用可能
- それ以上のトラフィックが見込まれる場合は有料プランを検討

---

## 🔟 拡張・注意事項

### セキュリティ
- トークン認証必須（ログイン以外のすべてのAPI）
- トークン有効期限管理（24時間）
- 管理者権限チェック
- XSS対策（入力値のサニタイズ）
- **検索エンジン対策**: robots.txtとmetaタグで検索エンジンにインデックスされないよう設定
- **APIエンドポイント保護**: Cloudflare Workers経由でGAS APIを呼び出し、実際のGAS URLをフロントエンドに露出しない

### パフォーマンス
- localStorageによるキャッシュ（5分間）
- API呼び出し回数の最小化
- 大量データの場合はページネーション検討

### ユーザビリティ
- ローディング表示
- エラーメッセージの適切な表示
- モバイル対応（レスポンシブデザイン）
- オフライン時の挙動

### その他
- QRコードはログイン済みユーザーのみ表示可能
- 実出席と出欠登録の差分を分析可能
- スプレッドシートのアクセス権限は厳密に管理
- 定期的なバックアップ推奨

---

## 📝 イベント登録画面入力項目（詳細）

### 基本情報
- イベント名（必須）
- 開催日（必須）
- 開始時間 / 終了時間（任意）
- 開催場所（任意）
- MAP URL
- 主催（プルダウン選択　hosts_master）
- 説明文（任意）
- 至急登録（チェック）

### 出欠設定
- 出欠回答の締切日（カレンダー選択）
- 出欠タイプの選択：
  - タイプA：参加 / 不参加 / 未定（ラジオボタン）
  - タイプB：任意項目を作成して選択（例：◯日参加 / 宿泊あり / 宿泊なし など）
- メモ（任意入力 例: 出向で公欠）

### 登録・支払い情報
- 登録期限（カレンダー選択）
- キャンセル料発生日（カレンダー選択）
- 登録料（数値入力　円）
- 支払い方法（チェックボックスで選択 payment_methods_master）
  - 現地払い
  - 銀行振込
  - 領収書（当日お渡し/後日お渡し/不明）
- **領収書 但し書き（デフォルト）**
  - テキスト入力欄
  - プレースホルダー：「例: 会費として、研修費として」
  - （空欄の場合：「イベント名 参加費として」が自動設定される）
  - 注記：メンバーが領収書発行時に変更可能

### その他情報
- 服装規定（プルダウン ➕ 自由記載 dress_codes_master）
- タグ設定（複数選択可 tags_master）
- 備考（自由記述欄）

### 参加者設定
- 対象者の条件（スタッフ、全員）
- 出欠状況の公開範囲：
  - 管理者のみ / スタッフ / 全員に公開

### オプション
- QRコードリーダー生成（出席登録用）
- CSV出力設定（出欠一覧）
- Googleカレンダー連携（ON/OFF）
- **メンバーへの表示項目選択**（チェックボックスで選択）
  - ☑ 開催日
  - ☑ 開催時間
  - ☑ 開催場所
  - ☐ MAP URL
  - ☑ 主催
  - ☑ 説明文
  - ☑ 登録料
  - ☐ 支払い方法
  - ☑ 服装規定
  - ☐ 備考
  - ☑ 登録期限
  - ☑ 出欠締切日
  - ☐ キャンセル料発生日
  - ☑ タグ

---

## 終わりに

この仕様書に従って実装することで、GASをバックエンドAPI、GitHub Pagesをフロントエンドとした、モダンで保守性の高い出欠管理システムが構築できます。

フロントエンドとバックエンドが分離されているため：
- フロントエンドの修正がGASに影響しない
- デバッグがしやすい
- 将来的な拡張が容易
- チーム開発がしやすい

などのメリットがあります。